<h1>Applies to</h1>
  <ul>
    <li>Active Directory Application Mode (ADAM) <li>Microsoft Windows Server 2003 or later operating system<li>Microsoft Windows XP Professional SP1 or later operating system </li></li></li>
  </ul>
  <h1>Summary</h1>
  <p>This How to shows you how you can develop an ASP.NET Web site that uses Active Directory Application Mode (ADAM) to store ASP.NET roles. It shows you how to configure ADAM and the Authorization Manager (AzMan) policy store, how to create new roles and add a user to a role, and how to use the Roles Management API for roles-based authorization. Using ADAM as a roles store is a good solution for applications accessed over an intranet or extranet where the user accounts store is Microsoft Active Directory directory service or ADAM and where the application requires application-specific roles that are different from Active Directory groups.</p>
  <h1>Contents</h1>
  <ul>
    <li>
      <div>Objectives</div>
      <li>
        <div>Overview</div>
        <li>
          <div>Installation Requirements</div>
          <li>
            <div>Summary of Steps</div>
            <li>
              <div>Step 1. Install the ADAM Instance</div>
              <li>
                <div>Step 2. Configure the AzMan Policy Store in ADAM</div>
                <li>
                  <div>Step 3. Configure the Web Application to Use the AuthorizationStoreRoleProvider</div>
                  <li>
                    <div>Step 4. Perform Role Management Operations</div>
                    <li>
                      <div>Additional Considerations</div>
                      <li>
                        <div>Additional Resources</div>
                      </li>
                    </li>
                  </li>
                </li>
              </li>
            </li>
          </li>
        </li>
      </li>
    </li>
  </ul>
  <h1>Objectives</h1>
  <ul>
    <li>Use ADAM for role storage. <li>Create an Authorization Manager policy store in ADAM. <li>Configure the <b>AuthorizationStoreRoleProvider</b>. <li>Perform role checks within an ASP.NET application. </li></li></li></li>
  </ul>
  <h1>Overview</h1>
  <p>The Roles Management API in ASP.NET allows you to implement application-specific roles and manage user role membership. To achieve this, the Roles Management system stores its data in an underlying data store that it accesses through an appropriate role provider for that data store. Supported role providers include <b>SqlRoleProvider</b>, <b>WindowsTokenRoleProvider</b>, and <b>AuthorizationStoreRoleProvider</b>. All of these implement a standard set of role provider interfaces.</p>
  <p>You can use an AzMan policy store in ADAM to store role data that is specific to an application or Web site (such as what roles a user belongs to), while keeping that data separate from the generic user information (such as full name and Windows group membership), which is stored in a domain's Active Directory. When a user logs on to a Web site running ADAM, the site authenticates the user with the Active Directory user store, and then uses the <b>AuthorizationStoreRoleProvider</b> to read which roles the user belongs to from the application roles that are kept in the AzMan policy store in ADAM. The ASP.NET application and the ADAM instance do not have to be on the same server.</p>
  <p>When you use role-based authorization, your application must authenticate its users. You can use any available form of authentication, such as Windows authentication or forms authentication. If you use forms authentication and you want to use the <b>AuthorizationStoreRoleProvider</b>, your users must have valid Windows local or domain user accounts. You can use the ASP.NET role management feature independently or in conjunction with the ASP.NET membership feature.</p>
  <p>This How to shows you how to set up ADAM on a server and how to configure an AzMan policy store in ADAM. It shows you how to create a Web site that uses Windows authentication to identify users and then uses the <b>AuthorizationStoreRoleProvider</b> role provider (which uses the AzMan policy store in ADAM) to provide role management for users of that Web site. Additionally, it shows you how to create roles and add users to those roles programmatically.</p>
  <p>The ASP.NET <b>AuthorizationStoreRoleProvider</b> uses only the AzMan functionality that is necessary to support the functionality implemented in the ASP.NET role management API. AzMan supports additional role management functionality that you can access by using the AzMan APIs. </p>
  <h1>Installation Requirements</h1>
  <p>Windows Server 2008 includes ADAM, now called Active Directory Lightweight Directory Service. You can install and run ADAM on any computer that uses the Microsoft Windows Server 2003 or Windows&#174; XP Professional SP1 or later operating systems. You can download ADAM from: <a href="http://www.microsoft.com/downloads/details.aspx?familyid=9688f8b9-1034-4ef6-a3e5-2a2a57b5c8e4&displaylang=en">http://www.microsoft.com/downloads/details.aspx?FamilyID=9688f8b9-1034-4ef6-a3e5-2a2a57b5c8e4&DisplayLang=en</a>.</p>
  <p>AzMan is available for Windows Server 2003, Windows XP Professional, and Windows 2000 Server as follows: </p>
  <ul>
    <li>
      <b>Windows Server 2003:</b> Install Windows 2003 Server Service Pack 1 or later. You can install this from <a href="http://windowsupdate.microsoft.com/">http://windowsupdate.microsoft.com</a>. <li><b>Windows XP Professional:</b> Install the Windows Server 2003 Administration Tools Pack, which is available for download at <a href="http://www.microsoft.com/downloads">http://www.microsoft.com/downloads</a>. This tools pack allows remote server management of Windows Server 2003 and also includes AzMan. <blockquote><b>Note</b>&nbsp;&nbsp;&nbsp;If you are running Windows XP Service Pack 2 or later, you must install Service Pack 1 or later of the Windows Server 2003 Administration Tools Pack.<b></b></blockquote><li><b>Windows 2000:</b> Download the Windows 2000 Authorization Manager Runtime available at <a href="http://www.microsoft.com/downloads/details.aspx?familyid=7edde11f-bcea-4773-a292-84525f23baf7&displaylang=en">http://www.microsoft.com/downloads/details.aspx?FamilyID=7edde11f-bcea-4773-a292-84525f23baf7&DisplayLang=en</a>. Your computer must have Windows 2000 Server Service Pack 4 or later installed. You must also install MSXML 4.0 Service Pack 2 or later. <p>This installs the run-time components only and not the AzMan administration Microsoft Management Console (MMC) snap-in. You can still use the MMC snap-in on a computer that uses Windows Server 2003 or on a computer that uses Windows XP and has the Windows Server 2003 Administration Tools Pack installed, to remotely administer AzMan on a computer running Windows 2000 Server. </p></li></li></li>
  </ul>
  <h1>Summary of Steps</h1>
  <p>Follow these steps to use ADAM for roles in ASP.NET applications: </p>
  <ul>
    <li>Step 1. Install the ADAM instance. <li>Step 2. Configure the AzMan policy store in ADAM. <li>Step 3. Configure the Web application to use the AuthorizationStoreRoleProvider. <li>Step 4. Perform role management operations. </li></li></li></li>
  </ul>
  <h1>Step 1. Install the ADAM Instance</h1>
  <p>In this step, you install the ADAM instance to be used as the role store for your application. You do not need to install the ADAM instance on the same computer as your ASP.NET application.</p>
  <p>
    <b>To install an ADAM instance</b>
  </p>
  <ol>
    <li>Log on to your computer by using an account in the Administrators group. <li>Download the ADAM installer from <a href="http://www.microsoft.com/downloads/details.aspx?familyid=9688f8b9-1034-4ef6-a3e5-2a2a57b5c8e4&displaylang=en">http://www.microsoft.com/downloads/details.aspx?FamilyID=9688f8b9-1034-4ef6-a3e5-2a2a57b5c8e4&DisplayLang=en</a>. Run the installer, which unzips the product files into a directory of your choice. <li>Go to the directory where you extracted the ADAM files, and run ADAMSetup.exe to start the setup. A wizard will guide you through most of the subsequent steps. <li>After you accept the license agreement, on the <b>Installation Options</b> page, select <b>ADAM and ADAM administration tools</b>. <li>In <b>Setup Options</b>, select <b>A unique instance</b>. <li>Type the name you want to use for this ADAM instance. For this example, use <b>AdamForRolesProvider</b>. <blockquote><b>Note</b>&nbsp;&nbsp;&nbsp;Create a name that is meaningful for your application. The ADAM instance name is used as the name of the service and also as the default location for the ADAM data store.<b></b></blockquote><li>On the <b>Ports</b> page, accept the defaults and make a note of the port numbers. You will need this information in subsequent steps. <blockquote><b>Note</b>&nbsp;&nbsp;&nbsp;If you install ADAM on a computer that has either of the default ports in use, the ADAM setup wizard automatically locates the first available port, starting at 50000. For example, Active Directory uses ports 389 and 636, as well as ports 3268 and 3269 on global catalog servers. Therefore, if you install ADAM on a domain controller, the ADAM setup wizard provides a default value of 50000 for the LDAP port and 50001 for the SSL port.<b></b></blockquote><li>On the <b>Application Directory Partition</b> page, select <b>Yes create an application directory partition</b> and type a partition name. For this example, use the partition name <b>OU=SecNetPartition,O=SecNet,C=US</b>. <li>On the <b>File Locations</b> page, type the location where the ADAM system files are installed. In this example, accept the defaults. <li>Under <b>Service Account Selection</b>, use the default<b> Network service account</b>. If your Windows Server 2003 computer is not a member of a domain, you will see a warning message concerning replication. Click <b>Yes</b> to continue. <blockquote><b>Note</b>&nbsp;&nbsp;&nbsp;The account that you select determines the security context in which the ADAM instance runs. Unless you are installing ADAM on a domain controller, the ADAM setup wizard defaults to the Network Service account. When you install ADAM on a domain controller, you must select a domain user account as the ADAM service account.</blockquote><li>You must be sure that the local security policy does not prevent local users who connect over the network from authenticating as themselves. Otherwise, users who connect to ADAM over the network are forced to use a security context of Guest, and any attempts to bind to ADAM will fail. <p>To check this, leave the ADAM setup wizard running and do the following: </p><ol><li>On the <b>Start</b> menu, click <b>Control Panel</b>. <li>Open <b>Administrative Tools</b>, and then double-click the <b>Local Security Policy</b> option. <li>Under <b>Security Settings</b>, expand <b>Local Policies</b>, then select <b>Security Options</b>. <li>In the <b>Policy</b> list, double-click <b>Network Access: Sharing and Security model for local accounts</b>. <li>Set this to <b>Classic</b>-<b>local users authenticate as themselves</b>, and then click <b>OK</b>. </li></li></li></li></li></ol><li>Return to the ADAM Setup Wizard. On the <b>ADAM Administrators</b> page, select <b>This account,</b> and then specify the local group, <b>Administrators</b>. <li>On the <b>Importing LDIF Files</b> page, select <b>Import the selected LDIF files for this instance of ADAM,</b> and then add the following LDIF files: <ul><li>MS-AZMan.LDF <li>MS-InetOrgPerson.LDF <li>MS-User.LDF </li></li></li></ul><p>After you add the files, click <b>Next</b>. </p><blockquote><b>Note</b>&nbsp;&nbsp;&nbsp;LDIF files are schema files for special objects in ADAM. The AzMan.LDF file is the schema for AzMan.<b></b></blockquote><li>On the <b>Ready to install</b> page, click <b>Next</b> to start the installation. </li></li></li></li></li></li></li></li></li></li></li></li></li></li>
  </ol>
  <h1>Step 2. Configure the AzMan Policy Store in ADAM</h1>
  <p>In this step, you configure the AzMan Policy Store in ADAM. To configure the AzMan policy store, do the following: </p>
  <ul>
    <li>Set up the AzMan policy store in ADAM. <li>Assign the Network Services account the administrator role in AzMan. <li>Create an AzMan application. </li></li></li>
  </ul>
  <h2>To create the AzMan policy store in ADAM </h2>
  <ol>
    <li>At the command prompt, type <b>azman.msc</b> to open the Authorization Manager snap-in. <li>On the <b>Action</b> menu, click <b>Options</b>, and then click <b>Developer mode</b>. <li>On the <b>Action</b> menu, click <b>New Authorization Store</b>. Set the Authorization store type as <b>Active Directory</b>. Type the following <b>Store name</b>, leave the description field blank, and then click <b>OK.</b><p><b>msldap://<i></i></b><i>servername</i><b>:</b><i> portnumber</i><b>/CN=AzManADAMStore,<i></i></b><i>partition</i></p><p>In the command above: </p><ul><li>Change <i>servername</i> to the name of your server or to <b>localhost</b> to administer the instance on the local computer. <li>Change <i>portnumber</i> to the port number you used when you set up the ADAM instance. <li>Change <i>partition</i> to the partition name that you created when you installed ADAM. If you used the suggested name in Step 1, this would be <b>OU=SecNetPartition,O=SecNet,C=US</b>. <li>The container name for your AzMan policy store in ADAM<b></b>is<b> CN=AzManADAMStore</b>. You can change this to something else if you prefer. </li></li></li></li></ul><li>Right-click the AzManADAMStore, and then click <b>Properties.</b> In the <b>Properties</b> window, click the <b>Security</b> tab. <li>Under <b>Authorization Manager user role</b>, choose the required access level from the following options: <ul><li><b>Administrator.</b> The user can do full role management and perform access checks. <li><b>Reader.</b> The user can read the store and perform access checks. <li><b>Delegated User.</b> When combined with the Administrator setting, this allows the user to audit applications and scopes. See <b>Authorization auditing</b> in Authorization Manager Help for details. </li></li></li></ul><p>For the purposes of this How to, select <b>Administrator</b>. Click the <b>Add</b> button to add the account that ASP.NET uses (the Network Service account) to this role. </p><blockquote><b>Note</b>&nbsp;&nbsp;&nbsp;If your ASP.NET application uses impersonation to impersonate a fixed identity or if you have configured your ASP.NET application to run under a custom account, you must add the impersonated account or custom account as an <b>Administrator</b> or <b>Reader</b>, according to the level of access required.<b></b></blockquote></li></li></li></li></li>
  </ol>
  <h2>To create the AzMan application </h2>
  <ol>
    <li>Make sure that the AzManAdamStore is selected in the console tree. In the <b>Actions</b> menu, click <b>New Application</b>. <li>Type a name for your application. For this example, use <b>AzManDemo</b> and leave the <b>Description</b> and <b>Version Info</b> fields blank. </li></li>
  </ol>
  <h1>Step 3. Configure the Web Application to Use the AuthorizationStoreRoleProvider</h1>
  <p>In this step, you configure ASP.NET to use the <b>AuthorizationStoreRoleProvider</b>, which is used to connect to the AzMan policy store in the ADAM instance that you just created. See "Additional Considerations" for instructions on using the <b>AuthorizationStoreRoleProvider</b> with Windows XP or Windows 2000.</p>
  <h2>To create an ASP.NET application and configure it to use the AuthorizationStoreRoleProvider </h2>
  <ol>
    <li>Create an empty Web site project and add a connection string for the AzMan policy store in ADAM to the Web.config file by using the following steps: <ol><li>Create a new empty ASP.NET Web site, and name it <b>AdamRoles</b>. <li>Add a Web.config file to your project. <li>Define a connection string to the AzMan policy store in ADAM in the &lt;<b>ConnectionStrings</b>&gt; element. The connection string takes the following format. <div><pre>msldap://<i> servername:port</i>/CN=<i>container</i>,<i> partition</i></pre></div><p>Using the example, add the following connection string: </p><div><pre>&lt;add name="AzManADAMServer" connectionString="msldap://servername:port/CN=AzManADAMStore,<br />&#9;&#9;OU=SecNetPartition,O=SecNet,C=US"/&gt;  </pre></div><p>Where <i>servername</i> is your server name and <i>port</i> is your port number. </p></li></li></li></ol><li>Configure the application to use the role provider by adding the following elements as children of the &lt;<b>system.web</b>&gt; element. <div><pre>&lt;roleManager <br />&nbsp;&nbsp;&nbsp; enabled="true" <br />&nbsp;&nbsp;&nbsp; cacheRolesInCookie="true" <br />&nbsp;&nbsp;&nbsp; defaultProvider="RoleManagerAzManADAMProvider"<br />&nbsp;&nbsp;&nbsp; cookieName=".ASPXROLES" <br />&nbsp;&nbsp;&nbsp; cookiePath="/" <br />&nbsp;&nbsp;&nbsp; cookieTimeout="30" <br />&nbsp;&nbsp;&nbsp; cookieRequireSSL="true" <br />&nbsp;&nbsp;&nbsp; cookieSlidingExpiration="true"<br />&nbsp;&nbsp;&nbsp; createPersistentCookie="false" <br />&nbsp;&nbsp;&nbsp; cookieProtection="All"&gt;<br />&nbsp;&nbsp;&nbsp; &lt;providers&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;add name="RoleManagerAzManADAMProvider"<br />&nbsp;&nbsp;&nbsp;&nbsp; type="System.Web.Security.AuthorizationStoreRoleProvider, System.Web, Version=3.5.0.0,<br />&#9; Culture=neutral, publicKeyToken=b03f5f7f11d50a3a"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connectionStringName="AzManADAMServer" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; applicationName="AzManDemo"/&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/providers&gt;<br />&lt;/roleManager&gt;  </pre></div></li></li>
  </ol>
  <blockquote>
    <b>Note</b>&nbsp;&nbsp;&nbsp;By ensuring unique values for the <b>cookieName</b> and <b>cookiePath</b> attributes, you prevent possible problems that can occur when hosting multiple applications on the same server. This best practice will prevent a user on one site from using his or her role cookie on a different site hosted on the same server.</blockquote>
  <h1>Step 4. Perform Role Management Operations</h1>
  <p>In this step, you create a test application that assigns a role to a user, removes a role from a user, and tests for role membership. The data that supports these role management operations is stored in the AzMan store in ADAM.</p>
  <h2>To test role management </h2>
  <ol>
    <li>Add a WebForm called Default.aspx to the Web site that contains the following code. <div><pre>&lt;&#37;&#64; Page Language="C#" &#37;&gt;<br />&lt;&#33;DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "<a href="http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd</a>"&gt;<br />&lt;script runat="server"&gt;<br />&nbsp;&nbsp;&nbsp; protected void Page_Load(object sender, EventArgs e)<br />&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (&#33;Roles.RoleExists("TestRole"))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Roles.CreateRole("TestRole");<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ShowRoleMembership();<br />&nbsp;&nbsp;&nbsp; &#125;<br />&nbsp;&nbsp;&nbsp; private void ShowRoleMembership()<br />&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (Roles.IsUserInRole("TestRole"))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Label1.Text = User.Identity.Name &#43; " is in role TestRole";<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Label1.Text = User.Identity.Name &#43; " is NOT in role TestRole";<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;<br />&nbsp;&nbsp;&nbsp; &#125;<br />&nbsp;&nbsp;&nbsp; protected void Button1_Click(object sender, EventArgs e)<br />&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Roles.AddUserToRole(User.Identity.Name, "TestRole");<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ShowRoleMembership();<br />&nbsp;&nbsp;&nbsp; &#125;<br />&nbsp;&nbsp;&nbsp; protected void Button2_Click(object sender, EventArgs e)<br />&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Roles.RemoveUserFromRole(User.Identity.Name, "TestRole");<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ShowRoleMembership();<br />&nbsp;&nbsp;&nbsp; &#125;<br />&lt;/script&gt;<br />&lt;html&nbsp; &gt;<br />&lt;head runat="server"&gt;<br />&nbsp;&nbsp;&nbsp; &lt;title&gt;Untitled Page&lt;/title&gt;<br />&lt;/head&gt;<br />&lt;body&gt;<br />&nbsp;&nbsp;&nbsp; &lt;form id="form1" runat="server"&gt;<br />&nbsp;&nbsp;&nbsp; &lt;div&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;asp:Button ID="Button1" runat="server" Text="Add to role" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnClick="Button1_Click" /&gt;&lt;br /&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;br /&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;asp:Button ID="Button2" runat="server" Text="Remove from role" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnClick="Button2_Click" /&gt;&lt;br /&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;br /&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;asp:Label ID="Label1" runat="server"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Text="Label"&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/asp:Label&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/div&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/form&gt;<br />&lt;/body&gt;<br />&lt;/html&gt;  </pre></div><li>Run the application. Note the following features about this application: <ol><li>When you start it up, the code in the <b>Page_Load</b> event handler creates the role <b>TestRole</b>, if it does not already exist. <li>The text of <b>Label1</b> shows whether or not the current authenticated user is a member of the <b>TestRole</b> role. <li>When you click the <b>Add to role</b> button, the code in the <b>Button1_Click</b> event handler uses the Roles API to add the current authenticated user to the <b>TestRole</b> role. <li>If you click the <b>Add to role</b> button again before clicking the <b>Remove from role</b> button, the call to <b>Roles.AddUserToRole</b> throws an exception because the user is already in the role <b>TestUser</b>. You must code for this condition in your applications. <li>When you click the <b>Remove from role</b> button, the current authenticated user is removed from the role <b>TestRole</b>. <blockquote><b>Note</b>&nbsp;&nbsp;&nbsp;This step demonstrates how to create and remove roles programmatically and how to determine whether a user is in a role programmatically. You can add and remove users from roles by using the AzMan MMC plug-in or the ASP.NET Configuration Tool. You can also configure access restrictions to pages and folders by using roles.</blockquote></li></li></li></li></li></ol></li></li>
  </ol>
  <h1>Deployment Considerations</h1>
  <p>In addition to the preceding guidance, consider the following deployment considerations: </p>
  <ul>
    <li>Deploy ADAM Instance on a Remote Server <li>Use an existing ADAM Instance for your ASP.NET Roles </li></li>
  </ul>
  <h2>Deploy ADAM Instance on a Remote Server</h2>
  <p>When using role manager, you should consider deploying your ADAM role store on a remote server. In order to deploy your ADAM instance on a remote server you must grant the necessary permissions to allow the account running your ASP.NET application to access the ADAM instance.</p>
  <p>If your ASP.NET application runs under the default Network Service account, you must authorize the Web server machine account. If you have configured a custom application pool in IIS running under a custom domain account, you must authorize that domain account.</p>
  <p>The following instructions assume the ASP.NET application runs under the default Network Service account:</p>
  <h3>Authorize your Web server machine account to access the remote ADAM instance</h3>
  <p>You have to grant the permissions to the users to access that Adam partition. Use the ADAM ADSI to edit your partition. </p>
  <ol>
    <li>On the server running the ADAM instance, create a local ADAM Readers group called <b>ADAMReaders</b> using Local Users and Groups in the Computer Management tools and add your web server machine account <b><i>Domain</i>/<i>WebServername</i></b>to this group. <li>Open the <b>ADAM ADSI Edit</b> tool from the ADAM group in the Programs menu. Connect to your ADAM instance; in the <b>Connection Settings</b> dialog, select <b>Well-known naming context</b>, and select <b>Configuration</b> in the drop-down box. Click <b>OK</b>. <li>Select <b>CN=Roles</b> in the left-hand pane, right-click on <b>CN=Readers</b> in the right hand pane and then select <b>Properties</b>. <li>In the <b>CN=Readers Properties</b> dialog box<b>,</b> select the <b>member </b>attribute in the attributes list, and then click <b>Edit</b>. <li>Click <b>Add Windows Account</b> and add your Local ADAM Readers Group <b><i>AdamServerName</i>\ADAMReaders</b>. </li></li></li></li></li>
  </ol>
  <h2>Use an Existing ADAM Instance for Your ASP.NET Roles</h2>
  <p>In production, you may want to use an existing ADAM instance to store your ASP.NET Roles. If you want to use an existing ADAM instance, you must: </p>
  <ul>
    <li>Import the AzMan schema into ADAM <li>Perform the same steps described above for a new ADAM instance starting from <b>Step 2</b>-<b>Configure the AzMan Policy Store in ADAM</b>. </li></li>
  </ul>
  <h3>To import the AzMan schema into ADAM </h3>
  <ol>
    <li>On the computer where the ADAM instance is installed, click on the <b>Start</b> menu, click <b>All Programs</b>, click <b>ADAM</b>, and then click <b>Adam Tools Command Prompt</b>. <li>At the command prompt, run the following command to import the AzMan schema into the existing ADAM store. This command runs the LDIFDE executable, which creates, modifies, or deletes a directory object. <p><b>ldifde -i -f MS-AzMan.ldf -s </b><i>servername</i><b>:</b><i> portnumber</i><b> -j . -c "CN=Schema,CN=Configuration,DC=X" "#schemaNamingContext"<br />-b <i>username</i><i>domain</i> &#42;</b></p><p>When you type the command, replace <i>servername</i> and <i>portnumber</i><b></b>with your actual computer name and port number. The port number is the one you selected when you installed this instance of ADAM. By default, port 389 is used for the first ADAM instance but this may be changed at install time. Replace <i>username</i> and <i>domain</i> with the account name and domain name of an account that is authorized to administare this ADAM instance. </p><p>You will be prompted for the password to the account you have specified. After you type the password, you will see the following output: </p><div><pre><br />Connecting to "servername: portnumber"<br />Logging in as "username" in domain "domain" using SSPI<br />Importing directory from file "MS-AzMan.ldf"<br />Loading entries........................................<br />39 entries modified successfully.<br />The command has completed successfully  </pre></div><li><blockquote><b>Note</b>&nbsp;&nbsp;&nbsp;For information about the <b>ldifde</b> switches, type <b>ldifde -?</b> at the command prompt.<b></b></blockquote></li></li></li>
  </ol>
  <h3>To configure the AzMan policy store</h3>
  <p>Proceed as described above for a new ADAM instance starting from <b>Step 2</b>-<b>Configure the AzMan Policy Store in ADAM</b>.</p>
  <h1>Additional Considerations</h1>
  <p>If you use Windows XP or Windows 2000, you must install the primary interop assembly for the AzMan COM object into the global assembly cache (GAC) before you can use the <b>AuthorizationStoreRoleProvider</b>. This assembly is already installed in the GAC on Windows Server 2003 and later computers.</p>
  <h2>To install the primary interop assembly on Windows 2000 </h2>
  <ol>
    <li>Run the installer for the Windows 2000 Authorization Manager Runtime (download from http://www.microsoft.com/downloads/details.aspx?FamilyID=7edde11f-bcea-4773-a292-84525f23baf7&DisplayLang=en) The installer creates two subdirectories: one contains the setup file for the Authorization Manager and the other, called \pia, contains the primary interop assembly. <li>From the Windows Control Panel, run the <b>Microsoft .NET Framework Configuration</b> tool, and then open the <b>Manage Assembly Cache</b> option. <li>Use the <b>Add an Assembly to the Assembly Cache</b> option to navigate to the <i>Authorization Manager Runtime Installation Directory</i><b>\pia</b> folder, and then add the <b>Microsoft.Interop.Security.AzRoles.dll</b> assembly to the cache. </li></li></li>
  </ol>
  <blockquote>
    <b>Note</b>&nbsp;&nbsp;&nbsp;The \pia folder contains two versions of the primary interop assembly. The primary interop assembly for AzMan version 1.0 is in the \pia folder, and the primary interop assembly of AzMan version 1.2 in the \pia\1.2 folder. The V1.2 AzMan COM object exposes additional interfaces that will be of interest to advanced AzMan users, but does not offer additional functionality to users of the ASP.NET Roles Management API.<b></b></blockquote>
  <h2>To install the primary interop assembly on Windows XP </h2>
  <ol>
    <li>Install the Windows Server 2003 Administration Tools Pack, available for download at <a href="http://www.microsoft.com/downloads">http://www.microsoft.com/downloads</a>. This download does not include the AzMan primary interop assembly. <li>To install the primary interop assembly, download the Windows 2000 Authorization Manager Runtime from <a href="http://www.microsoft.com/downloads/details.aspx?familyid=7edde11f-bcea-4773-a292-84525f23baf7&displaylang=en">http://www.microsoft.com/downloads/details.aspx?FamilyID=7edde11f-bcea-4773-a292-84525f23baf7&DisplayLang=en</a>. Run the downloaded file, which unzips files (including the AzMan primary interop assembly) into a directory in the \<b>pia</b> folder. <li>From the Windows Control Panel, run the <b>Microsoft .NET Framework Configuration</b> tool, and then open the <b>Manage Assembly Cache</b> option. <li>Use the <b>Add an Assembly to the Assembly Cache</b> option to navigate to the <i>Authorization Manager Runtime Installation Directory</i><b>\pia</b> folder, and then add the <b>Microsoft.Interop.Security.AzRoles.dll</b> assembly to the cache. </li></li></li></li>
  </ol>
  <h1>Additional Resources</h1>
  <ul>
    <li>
      <a href="http://msdn2.microsoft.com/en-us/library/ms974546.aspx">An Introduction to ADAM</a>
    </li>
  </ul>
  <hr />
  <p>Adapted from Microsoft patterns & practices guidance.</p>