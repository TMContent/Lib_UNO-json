<h1>Applies To</h1>
  <ul>
    <li>ASP.NET 4.0</li>
  </ul>
  <h1>Summary</h1>
  <p>The purpose of this code snippet is to illustrate how to retrieve a public keypair stored in the registry using the Data Protection API (DPAPI) and decrypt a message using that key pair.</p>
  <h1>Objectives</h1>
  <ul>
    <li>Make use of a securely stored RSA keypair for to decrypt an encrypted message.</li>
    <li>Illustrate how securely stored keys in the registry and using the DPAPI can be easy to implement.</li>
  </ul>
  <h1>Scenarios</h1>
  <ul>
    <li>Distributed client-server architecture where clients need to send confidential encrypted messages to the server but don't need to ever read those messages.</li>
    <li>Application does not want to maintain a dedicated key store for encryption purposes.</li>
  </ul>
  <h1>Solution Example</h1>
  <pre>public static byte[] RetrieveRSAKeyPairAndDecryptMessage(byte[] encrypted){<br />      // Retrieve the keypair from the registry, decrypt using the DPAPI<br />      // and store the serialized key data as an XML string<br />      byte[] encryptedKeyPair = Registry.GetValue(@"HKEY_CURRENT_USER\RSAKeyPair",<br />	  "KeyData", null) as byte[];<br />      byte[] keyPairBytes = ProtectedData.Unprotect(<br />           encryptedKeyPair,<br />           null,<br />           DataProtectionScope.CurrentUser);<br />      string keyPairXml = UnicodeEncoding.ASCII.GetString(keyPairBytes);<br /><br />      // Create a new RSA CSP in which to load the public/private key<br />      // data retrieved from the registry<br />      RSACryptoServiceProvider retrievedRSA = new RSACryptoServiceProvider();<br />      retrievedRSA.FromXmlString(keyPairXml);<br /><br />      // Decrypt message and return<br />      return (retrievedRSA.Decrypt(encrypted, false));<br />}</pre>
  <h1>Problem Example</h1>
  <p>The following example demonstrates the retrieval of an RSA key pair containing private key material from the file system.</p>
  <pre>// fileName is a string containing a path location with a serialized RSA key pair<br />// encrypted is a byte array containing an encrypted message for decryption<br />// Open up the public key file and read into a string<br />StreamReader keyReader = new StreamReader(fileName);<br />string keyPairXml = keyReader.ReadToEnd();<br />keyReader.Close();<br /><br />// Create a new RSA CSP in which to load the public/private key <br />// data retrieved from the registry<br />RSACryptoServiceProvider retrievedRSA = new RSACryptoServiceProvider();<br />retrievedRSA.FromXmlString(keyPairXml);<br /><br />// Decrypt message retrieved<br />RSA.Decrypt(encrypted, false);</pre>
  <ul>
    <li>If the filesystem is compromised, the private key material may be exposed.</li>
    <li>Extra management required to ensure that ACL's are securely set for files that contain key data.</li>
    <li>In alternate settings, lack of encryption when sending message exposes sensitive data to eavesdropping while in transit.</li>
  </ul>
  <h1>Test Case</h1>
  <p>The following classes must be included in any project making use of the sample code provided above:</p>
  <pre>using System.IO;<br />using System.Security;<br />using System.Security.AccessControl;<br />using System.Security.Cryptography;<br />using Microsoft.Win32;</pre>
  <p>Use the solution example above and the following code to encrypt an example using the registry-stored public key and then decrypt using the solution example:</p>
  <pre>static void Main(string[] args){<br />   // Read public key into a string<br />   string publicKeyXml = "&lt;RSAKeyValue&gt;" +<br />    "&lt;Modulus&gt;tnLAgAJwXXxYj+2QPX6q/mHZZf23xSvvovoBlZ1Y7RbTlkY4N2nlcGxfR6mQcTTWKfWShQ7yEaX6rVfhhRhdaH<br />    LCsg7g3AmW2BsoBxWUijD81ZeNKyWrw8t0gjnigNR46+PqO1Xi7R9aA+PgaluhuZBBgJK2wIAlRJSPlTr5OjDr4vJlZiAG/V<br />    qmJVXioPfv1QI2hfLM86JgIcrD47L0K44tKwyhAj4PN1nsomjPeb0P9m9t3od/c+yZGKk+iJ1nwQwG02H/EXROaO6YFKb3xi<br />    jNv69gv+ZLGc+qssXs7Bs7CdzqmQvSylxuXkYz5bQG++raYWm4l056WhtIRG8mqQ==&lt;/Modulus&gt;" +<br />    "&lt;Exponent&gt;AQAB&lt;/Exponent&gt;" + "&lt;/RSAKeyValue&gt;";<br /><br />    // Encrypt a message using our key and write out the results<br />    string msg = "The quick brown fox jumped over the lazy dog";<br />    byte[] encrypted = ReadRSAPublicKeyAndEncryptMessage(publicKeyXml, msg);<br />    Console.WriteLine("Encrypted data:");<br />    Console.WriteLine(Convert.ToBase64String(encrypted));<br /><br />    // Retrieve RSA KeyPair from registry and decrypt a message<br />    byte[] decrypted = RetrieveRSAKeyPairAndDecryptMessage(encrypted);<br />    Console.WriteLine("\nDecrypted data:");<br />    Console.WriteLine(Encoding.ASCII.GetString(decrypted));<br />}<br /><br />public static byte[] ReadRSAPublicKeyAndEncryptMessage(string xmlKeyData, string fileName){<br />    // Create a new RSA CSP in which to load the public key data from file<br />    RSACryptoServiceProvider yourRSA = new RSACryptoServiceProvider();<br />    yourRSA.FromXmlString(xmlKeyData);<br /><br />    // Encrypt a message and return<br />    byte[] original = Encoding.ASCII.GetBytes("The quick brown fox jumped over the lazy dog");<br />    return(yourRSA.Encrypt(original, false));<br />}</pre>
  <h1>Expected Result</h1>
  <p>Encrypted data:</p>
  <pre>YQdGxH+fyXEVjaoToOT4kVR00nmNv4xBWLRP5hyk7qz2zS9a64I0Ug9S99shDWvmbIT/nsKTkmPu8gZGXx3R7zNXn44KKKIlXKcIxv<br />fXHHnkuMuX3tXdpLZKPhPKcG09nFVtxdKehOnvVQEr5Wyp54XnkqU3B6VpBui6wabN/dqrhE0ziqpAkM2NbhU5H18mfo6brq0Ug9Tn<br />s9xj4mAD5AwDvqKlkumr9qS94czPzt5ECFv8rX4/HBvl/PhQZ+zsYt3xHwkQRDt+T+A5zf1G5ey9pOAKpzPtLI+/2LShaJVujo/fQi<br />foLU1vCa1BoMONCpk0A1B4zIm5a+TpY+zp6w==</pre>
  <p>Decrypted data:</p>
  <pre>The quick brown fox jumped over the lazy dog</pre>
  <h1>More Information</h1>
  <p>RSA is an algorithm for public key (also knows as asymmetric) cryptography in which distinct public and private keys are created. Encryption operations makes use of the public key while decryption requires the private key. This offers an advantage over symmetric cryptography because the secret key used to decrypt a message does not need to be shared in order to support encryption of messages to a recipient. </p>
  <p>The RSA private key must be securely stored in order to maintain the confidentiality of data encrypted using an individual's public RSA key. However, the public key can be freely distributed by the owner of the key pair to anyone who wishes to send an encrypted message to that owner. </p>
  <br />
  <hr />
  <p>Adapted from Microsoft patterns &amp; practices guidance.</p>