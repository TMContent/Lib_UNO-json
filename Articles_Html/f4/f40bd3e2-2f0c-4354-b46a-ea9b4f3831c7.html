<h1>Applies To</h1>
  <p>Applications written using Scala and Play Framework 2.1.0+</p>
  <h1>What to Check For</h1>
  <p>Ensure that all echoed input is first encoded before reflecting on the output page.<font color="#ff0000"><br /></font></p>
  <font color="#ff0000">
  </font>
  <h1>Why</h1>
  <p>Encoding echoed input prevents injection attacks such as cross-site scripting.</p>
  <h1>How to Check</h1>
  <p>An application can take input via various&nbsp;sources, such as a web interface, database, file system or other software running on the server, and then use that same input in various outputs. Use the following steps to establish a validation strategy:</p>
  <ol>
    <li>
      <p>
        <strong>Identify all sources of input.&nbsp;</strong>At design time identify all potential sources of input to your application. Once implemented, scour source code to discover sources of input that may have been missed in the design. Potential sources of input in a web application typically include:</p>
      <ul>
        <li>URL based parameters</li>
        <li>Form based parameters</li>
        <li>Hidden fields</li>
        <li>Cookies</li>
        <li>HTTP headers (Host, accept types, www authentication, cache settings, encodings, etc)</li>
        <li>Local filesystem</li>
        <li>Database</li>
        <li>Other services running on the system</li>
        <li>Javascript variables</li>
        <li>File upload and attributes (filename, size, data, etc)</li>
        <li>DNS results or host names</li>
        <li>External component call return values (COM, AJAX, ActiveX)</li>
      </ul>
      <p>Once you&nbsp;have listed the sources of input your application&nbsp;can use, look for all entry points. Good starting points are method parameters and assignment statements. For example:</p>
      <p>
        <font face="Arial, Verdana" size="2">This method uses the&nbsp;<i>jobId</i>&nbsp;variable.</font>
      </p>
      <pre>def findJobDetail(jobId: String): Action[play.api.mvc.AnyContent] = Action { implicit request =&gt;
    val job: Option[JobEntity] = Job.findJobDetail(new ObjectId(jobId))
    job match {
      case None =&gt; Results.Redirect("/errorPage")
      case Some(jobDetail: JobEntity) =&gt; Ok(views.html.jobDetail(jobDetail, request.session.get("userId").getOrElse("")))
    }

  }</pre>
      <p>
        <font face="Arial, Verdana" size="2">This assignment stores data from a&nbsp;</font>
        <em>GET</em>
        <font face="Arial, Verdana" size="2">&nbsp;request parameter named&nbsp;</font>
        <font face="Arial, Verdana">
          <font size="2">jobIds&nbsp;and stores it in the string&nbsp;</font>
          <i style="font-size: small;">jobId</i>
          <font size="2">. Ensure that this input is validated.</font>
        </font>
      </p>
      <pre>String <span style="font-size: 10pt;">jobId</span><span style="font-size: 10pt;"> = request.params.get("<span style="font-size: 10pt;">jobIds</span></span><span style="font-size: 10pt;">")</span></pre>
      <p>
        <font face="Arial, Verdana" size="2">This assignment uses the input that was gathered above to store more input from a database. Verify that&nbsp;<i>jobId</i>&nbsp;is validated before this use, and also ensure that&nbsp;</font>
        <em>data</em>
        <font face="Arial, Verdana" size="2">&nbsp;is validated as another source of input.</font>
      </p>
    </li>
    <li>
      <p>
        <strong>Trace data from source to sink.&nbsp;</strong>Trace each source of input from the immediate source, through your application, to its final destination. The final sink may be in memory, on the hard drive, sent over the network or stored in a data store such as a database. Create a list of the input sources that are echoed back to the user through output - whether directly, through a file, in a URL or through a database or other intermediary source.</p>
    </li>
    <li>
      <p>
        <strong>Ensure input is properly encoded before being used as output</strong>. Ensure that you have encoded input from each of the input sources identified above before it is used as output. Select appropriate encoding based upon how the output is returned to the client. Verify the context in which the output is used and ensure it is properly encoded. A couple example contexts are shown below (URL, HTML entity):</p>
      <ul>
        <li>
          <font face="Arial, Verdana" size="2">URL Encoding-&nbsp;<i>@helper.urlEncode(URL) ie&nbsp;&lt;a href="@helper.urlEncode(foo)"&gt;my href is urlencoded&lt;/a&gt;</i></font>
        </li>
        <li>
          <font face="Arial, Verdana" size="2">HTML Format Escaping-&nbsp;</font>
          <i style="font-family: Arial, Verdana; font-size: small;">&nbsp;HtmlFormat.escape(userparam)</i>
        </li>
        <li>HTML Entity Encoding&nbsp;</li>
        <li>HTML Attribute Encoding</li>
        <li>JavaScript Encoding</li>
        <li>CSS Encoding</li>
        <li>DOM Encoding</li>
      </ul>
      <p>Beware that certain locations may require a mixed encoding, such as initially performing URL encoding, then performing JavaScript encoding. This depends entirely on the output context wherein the data is used, and requires knowledge of the parsing mechanisms of browsers. Some example encodings are below.</p>
      <p />
      <font face="Arial, Verdana" size="2">User URL provided:</font>
      <pre>http://server/form?x=<strong>"&gt;&lt;SCRIPT&gt;alert('XSS');&lt;/SCRIPT&gt;</strong></pre>
      <p>No encoding:</p>
      <pre>&lt;form action="http://server/form?x=<strong>"&gt;&lt;SCRIPT&gt;alert('XSS');&lt;/SCRIPT&gt;</strong>"&gt;</pre>
      <p>URL Encoding:</p>
      <pre>&lt;form action="http://server/form%3Fx%3D<strong>%22%3E%3CSCRIPT%3Ealert%28%27XSS%27%29%3B%3C/SCRIPT%3E</strong>"&gt;</pre>
      <p>HTML Encoding:</p>
      <pre>&lt;form action="http://server/form?x=<strong>"&lt;&lt;SCRIPT&lt;alert('XSS');&lt;/SCRIPT&lt;</strong>"&gt;</pre>
    </li>
  </ol>
  <h1>How to Fix</h1>
  <p>Use the following steps to ensure all echoed input is encoded:</p>
  <ol>
    <li>
      <p>
        <strong>Identify all echoed input.&nbsp;</strong>Locate all places inside your application where user-supplied data will be returned to the client. Such data can be of a reflective or persistent nature:</p>
      <ul>
        <li>
          <strong>Reflective</strong>: In a reflective setting, the input is immediately returned to the client. For example, search engines present the searched query when displaying the results.</li>
        <li>
          <strong>Persistent</strong>: In a persistent setting, the input is stored and returned to the client when retrieved from the database. For example, message boards store the users' posts inside a database and return them when a given topic is viewed.</li>
      </ul>
    </li>
    <li>
      <p>
        <strong>Determine the&nbsp;type of encoding.&nbsp;</strong>After identifying all echoed input, determine how the input is returned to client. Data is said to be in an HTML context when that data is rendered as a part of an HTML document and is understood by the browser to be HTML. There are other contexts available to Web Applications, such as JavaScript context, CSS context, etc. Data is said to be in a JavaScript context when it is included in JavaScript code and is interpreted as JavaScript by the browser, and so on. Data has to be encoded differently for different contexts to prevent Cross-Site Scripting vulnerabilities. Differences in encoding arise from the fact that different contexts have different special symbols and keywords. Output encoding routines have to be designed with the understanding of the context of the output in mind.</p>
      <ul>
        <li>
          <p>
            <strong>URL encoding</strong>: URL encoding allows your application to maintain the original URL, yet display it to the user in a non-malicious way. Because HTTP headers allow a substitution schema, all characters/symbols are preserved by displaying their ASCII codes instead of the actual character/symbol. For example,&nbsp;<em>&lt;</em>&nbsp;is represented by&nbsp;<em>%3C</em>&nbsp;where&nbsp;<em>3C</em>&nbsp;is the ASCII value for&nbsp;<em>&lt;.</em></p>
        </li>
        <li>
          <p>
            <strong>HTML encoding</strong>: Use HTML encoding when the echoed input is returned as regular text or HTML content. Encode input by substituting certain characters with their respective HTML values:<br /></p>
          <blockquote>
            <table>
              <tbody>
                <tr>
                  <td>Character</td>
                  <td>HTML value</td>
                </tr>
                <tr>
                  <td>&lt;</td>
                  <td>&lt;</td>
                </tr>
                <tr>
                  <td>&gt;</td>
                  <td>&gt;</td>
                </tr>
                <tr>
                  <td>&</td>
                  <td>&amp;</td>
                </tr>
                <tr>
                  <td>"</td>
                  <td>&quot;</td>
                </tr>
                <tr>
                  <td>'</td>
                  <td>&#39;</td>
                </tr>
              </tbody>
            </table>
          </blockquote>
        </li>
        <li>
          <p>
            <strong>HTML attribute encoding</strong>: Use HTML attribute encoding to encode dynamic data that is output in an attribute of an HTML tag, except&nbsp;URL, CSS, and JavaScript event handler attributes.</p>
        </li>
        <li>
          <p>
            <strong>JavaScript encoding</strong>: Use JavaScript encoding to encode dynamic data that is output into the JavaScript context, including certain event handlers in HTML tags.</p>
        </li>
        <li>
          <p>
            <strong>CSS encoding</strong>: Use CSS encoding to encode dynamic data that is output into the CSS context.</p>
        </li>
        <li>
          <p>
            <strong>DOM Encoding</strong>: Use DOM encoding to encode dynamic data that is used in situations where the DOM is involved. These instances are more complicated and often involve multiple output contexts, which necessitates chaining in many circumstances.</p>
        </li>
      </ul>
    </li>
    <li>
      <p>
        <strong>Apply the encoding.&nbsp;</strong>After you identify the echoed input and determine the appropriate encoding method, apply the encoding before the input is returned to the client. There are different encoding libraries available. Different libraries have different capabilities and weaknesses. Please, refer to the vendor's documentation for each potential encoding library.</p>
    </li>
  </ol>
  <p />