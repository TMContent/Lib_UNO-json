<h1>Applies to</h1>
  <ul>
    <li>C#</li>
  </ul>
  <h1>Summary</h1>
  <p>The purpose of this code snippet is to illustrate how to secure data stored in the Windows registry through the use of registry access control list (ACL) permissions. By using these permissions, a user</p>
  <p>can programmatically control who can and cannot access data stored in the registry.</p>
  <h1>Objectives</h1>
  <ul>
    <li>Creating an applying a registry kep security context to control which users can access data from the registry</li>
  </ul>
  <h1>Scenarios</h1>
  <ul>
    <li>Application comprised of multiple components that to access the same key material for secret encryption keys </li>
    <li>Application needs to store data configuration data to be retrieved on startup, such as database connection strings </li>
    <li>Application consists of a client tier that needs to store runtime credentials to connect to other application tiers </li>
  </ul>
  <h1>Problem Example</h1>
  <pre>// Write an unprotected key and value into the registry. Default <br />// permissions allow all other users to access this key<br />RegistryKey key = Registry.CurrentUser.CreateSubKey(keyName);<br />key.SetValue(valueName, data);</pre>
  <ul>
    <li>Any other user on the system can access this key because no security context has been applied</li>
  </ul>
  <h1>Test Case</h1>
  <p>The following classes must be included in any project making use of the sample code provided above:</p>
  <pre>using System.Security;<br />using System.Security.AccessControl;<br />using Microsoft.Win32;</pre>
  <p>Furthermore, two distinct users must be defined on the test system. These users will be referred to in the following example as User A and User B. </p>
  <p>This test cases illustrates how a registry key secured using access </p>
  <p>control permissions by one user cannot be access by another user in </p>
  <p>the following 3 steps:</p>
  <p>1) Store a key as "User A" (in this example, "User A" = Administrator)</p>
  <p>using the following code:</p>
  <pre>static void Main(string[] args)<br />{<br />&nbsp;&nbsp;&nbsp; string keyName = "AdminSecuredKey";<br />&nbsp;&nbsp;&nbsp; string valueName = "AdminSecuredValue";</pre>
  <pre>
    <br />&nbsp;&nbsp;&nbsp; ControlledRegistryStore(keyName, valueName, "sensitive data");<br />}</pre>
  <pre>
    <br />static void ControlledRegistryStore(string keyName, string valueName, string data)<br />{<br />&nbsp;&nbsp;&nbsp; // Create a security context for a new key that we will use to store our data.<br />&nbsp;&nbsp;&nbsp; // The security context will restrict access to only our user.<br />&nbsp;&nbsp;&nbsp; string user = Environment.UserDomainName + "\\" + Environment.UserName;<br />&nbsp;&nbsp;&nbsp; RegistrySecurity security = new RegistrySecurity();<br />&nbsp;&nbsp;&nbsp; RegistryAccessRule rule = new RegistryAccessRule(user,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RegistryRights.FullControl,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; InheritanceFlags.ContainerInherit,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PropagationFlags.None,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AccessControlType.Allow);<br />&nbsp;&nbsp;&nbsp; security.AddAccessRule(rule);</pre>
  <pre>
    <br />&nbsp;&nbsp;&nbsp; // Actually create the new registry key and apply the security context we just came up with.<br />&nbsp;&nbsp;&nbsp; RegistryKey key = Registry.CurrentUser.CreateSubKey(keyName,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RegistryKeyPermissionCheck.ReadWriteSubTree,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; security);</pre>
  <pre>
    <br />&nbsp;&nbsp;&nbsp; // Write the data into the registry<br />&nbsp;&nbsp;&nbsp; key.SetValue(valueName, data);<br />}</pre>
  <p>2) Attempt to retrieve the previously stored key as User A using the following code:</p>
  <pre>static void Main(string[] args)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp; string keyName = "AdminSecuredKey";<br />&nbsp;&nbsp;&nbsp;&nbsp; string valueName = "AdminSecuredValue";</pre>
  <pre>
    <br />&nbsp;&nbsp;&nbsp;&nbsp; string data = RegistryRetrieve(Registry.Users, "\\" + keyName, valueName);<br />&nbsp;&nbsp;&nbsp;&nbsp; if (data != null)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(data);<br />&nbsp;&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("*** Inaccessible key ***");<br />}</pre>
  <pre>
    <br />static string RegistryRetrieve(RegistryKey parent, string keyName, string valueName)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp; // Recursively search through each subkey of a parent key<br />&nbsp;&nbsp;&nbsp;&nbsp; // checking to see if a match for the keyname exist and if<br />&nbsp;&nbsp;&nbsp;&nbsp; // the data can be obtained from that key. Returns data upon<br />&nbsp;&nbsp;&nbsp;&nbsp; // match and an error message otherwise. <br />&nbsp;&nbsp;&nbsp;&nbsp; foreach (string childName in parent.GetSubKeyNames())<br />&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RegistryKey child = parent.OpenSubKey(childName);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string data = null;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (child.Name.EndsWith(keyName))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // We found the name, try to pull out key data<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; data = child.GetValue(valueName) as string;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // No luck finding the name, try a depth-first recursive search<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; data = RegistryRetrieve(child, keyName, valueName);<br />&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp; if (data != null) return data;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; catch (Exception ex)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Print out a message whenever we come across a <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // key we don't have permissions to open<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(childName + ": " + ex.Message);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
  <pre>
    <br />&nbsp;&nbsp;&nbsp;&nbsp; return null;</pre>
  <pre>
  </pre>
  <p>3) Repeat Step 2 while logged in as User B. Compare results.</p>
  <h1>Expected Result</h1>
  <pre>
    <br />--------------------------------<br />"User A" (Administrator) output:<br />--------------------------------<br />C:\temp&gt;whoami<br />vm-win2003\administrator</pre>
  <pre>
    <br />C:\temp&gt;RegistrySnippet.exe<br />S-1-5-21-2537879503-2075122368-204042655-1006: Requested registry access is not<br />allowed.<br />sensitive data</pre>
  <pre>
    <br />---------------------------<br />"User B" (Joe User) output:<br />---------------------------<br />C:\temp&gt;whoami<br />vm-win2003\joeuser</pre>
  <pre>
    <br />C:\temp&gt;RegistrySnippet.exe<br />NetDDE: Requested registry access is not allowed.<br />S-1-5-19: Requested registry access is not allowed.<br />S-1-5-19_Classes: Requested registry access is not allowed.<br />S-1-5-20: Requested registry access is not allowed.<br />S-1-5-20_Classes: Requested registry access is not allowed.<br />S-1-5-21-2537879503-2075122368-204042655-1006: Requested registry access is not<br />allowed.<br />S-1-5-21-2537879503-2075122368-204042655-500: Requested registry access is not a<br />llowed.<br />S-1-5-21-2537879503-2075122368-204042655-500_Classes: Requested registry access<br />is not allowed.<br />NetDDE: Requested registry access is not allowed.<br />* Inaccessible key *</pre>
  <pre>&nbsp;</pre>
  <h1>More Information</h1>
  <ul>
    <li>Developers should not rely alone or registry permissions to control access to highly sensitive data. Consider encrypting certain data using the Data Protection API (DPAPI) in conjunction with registry access controls to add additional safeguards to more sensitive data stored in the registry. See Additional Resources section for links to encrypting data with the </li>
  </ul>
  <h1>Additional Resources</h1>
  <ul>
    <li>Working with Permissions (.NET): <a href="http://blogs.msdn.com/asanto/archive/2006/01/22/516009.aspx">http://blogs.msdn.com/asanto/archive/2006/01/22/516009.aspx</a></li>
  </ul>
  <hr />
  <p>Adapted from Microsoft patterns & practices guidance.</p>