<h1>What to Check For</h1>
  <p>Ensure that the application logs events that might indicate unusual or suspicious activity. Unusual activity includes replays of old authentication tickets or too many login attempts over a specific period of time.</p>
  <h1>Why</h1>
  <p>Instrumenting for suspicious activity allows you to detect and react to potential problems as early as possible. </p>
  <h1>How to Check</h1>
  <ol>
    <li>
      <p />
      <strong>Define what should be logged. </strong>Before you can check whether the correct logging is taking place, you need to&nbsp;create a list that defines unusual activity for your application. Use the following list as a starting point: <ul><li>Repeated unsuccessful authentication attempts <li>Attempts to use stale session-related information or authentication tickets <li>Large and/or rapid transactions <li>Transactions that occur outside of normal time periods <li>Application errors, especially those not easily caused by user error or occuring&nbsp;in deeper tiers.</li></li></li></li></li></ul><li><p><strong>Ensure the data is being logged. </strong>Once you understand what constitutes unusual activity for your application, check to ensure that it is&nbsp;logged appropriately.&nbsp;Appropriate logging depends upon the specific data being logged. Most applications will raise a custom event to indicate when unusual activity is occurring. </p><li><p><strong>Ensure That Logs are Monitored. </strong>Monitoring needs will depend on the application. Ensure that the applicable monitoring is in place and that the responsible staff has an appropriate response plan ready in the event of any suspicious behavior.</p></li></li></li>
  </ol>
  <h1>How to Fix</h1>
  <ol>
    <li>
      <p />
      <strong>Define Unusual Activity For Your Application. </strong>The first and most important step is understanding what defines suspicious activity for your application. Because the business focus of each application is unique, many of the specifics must be&nbsp;determined for each application. For example, logging may be part of a larger fraud-prevention campaign. However, there are some activities that are suspicious across a wide variety of application types: <ul><li>Repeated unsuccessful authentication attempts <li>Attempts to use stale session-related information or authentication tickets <li>Large or rapid transactions <li>Transactions that occur outside of normal time periods <li>Application errors, especially those not easily caused by user error or occuring&nbsp;in deeper tiers </li></li></li></li></li></ul><li><p><strong>Ensure Sufficient Data is being Logged. </strong>Once you understand what constitutes unusual activity for your application, you need to ensure that it is&nbsp;logged appropriately.&nbsp;Appropriate logging depends upon the specific data being logged. Example: Replays of old authentication tickets automatically raise an ExpiredTicketFailure event. To raise an event for too many login attempts, you can write an event handler for the <b>LoginError</b> event of the <b>Login</b> control. In the handler, call <b>Membership.GetUser(Login1.UserName).IsLockedOut</b> to determine if there have been too many login attempts for the user.&nbsp;You can then raise a custom event to indicate that the account has been locked out.&nbsp;Custom events can also be raised for a wide variety of non-authentication-related unusual activities. Other suspicious activity will require a more application-specific approach. Some suspicious activity logging will be best accomplished by parsing existing log files and looking for anomolous activity&#8212;rapid transactions from a single host or user, unsually large orders, etc. </p><li><p><strong>Ensure That Logs are Monitored. </strong>Logging&nbsp;will not be useful&nbsp;if the results never see the light of day, so the next step is ensuring that logs are monitored and the information is acted upon. Work with the operations team who will be managing the application to define a plan for monitoring and responding to log events. Depending on the environment, you may need to define this from scratch, or you may be fitting into a pre-exisiting framework. <br />If you are&nbsp;defining a monitoring framework from scratch, here are some things you need to consider: </p></li><ul><li>When do the logs need to be monitored&#8212;some applications will need 24x7 coverage, but many will be fine with 8x5. <li>How much time will log monitoring take&#8212;if&nbsp;your application is a&nbsp;large ecommerce site, you may have a dedicated team for log monitoring, but a small web app may be safe enough with a sysadmin taking a look a couple times a day. <li>What are your response time needs&#8212;if there's a serious problem with the site, it will&nbsp;show up in the logs first; is your tolerance for problems defined in minutes, hours, or days? <li>What will be your procedure for acting on potential issues? <li>How will you control access to your logs and information derived from them; how sensitive is the information likely to be? <li>What response capabilities will the log monitoring team have? Log monitoring on its own does no good if the information can't be acted on&#8212;compromised accounts need to be locked, machines patched or taken off line, etc.</li></li></li></li></li></li></ul><li><p><strong>Avoid Pitfalls for Logging. </strong>Logging too much information can end up being a problem of its own. Once you have an idea of the volume of log events that you're seeing from your application, it may be worthwhile to implement some form of log throttling to reduce the flow of information to a rate at which you can act upon. Good log throttling should only eliminate redundant information&nbsp;as well as&nbsp;provide a way to surface the most important information first. Automatically taking action based on detection of anomolous conditions is a very dangerous thing to do and is&nbsp;best avoided. While it may be reasonable to throttle the speed at which an event (say, a login attempt) may occur, preventing an action from occurring&nbsp;may result in an easy-to-launch denial of service attack against your application. </p></li></li></li>
  </ol>
  <h1>Problem Example</h1>
  <p>An e-commerce site does hundreds of transactions an hour but only keeps basic web server and database transaction logs.&nbsp;When an attacker finds a vulnerability in the login script and steals several accounts&nbsp;to make&nbsp;a large number of high-value transactions, the break-in isn't discovered until after the merchandise has been shipped.&nbsp;</p>
  <h1>Solution Example</h1>
  <p>An e-commerce site does hundreds of transactions an hour, and keeps a seperate security log that records unusual activity for the application.&nbsp;The log is monitored 24x7 by the site operations team, who can respond quickly to attacks and if they need more assistance, they can contact the developers.&nbsp;The logs contain the following categories of information (among others):</p>
  <ul>
    <li>Multiple account login failures for the same account or from the same address <li>Unusually large transactions, based on a customer's history and site averages <li>Multiple rapid transactions from the same customer <li>Any exceptions, http errors, or&nbsp;SQL errors from security critical systems</li></li></li></li>
  </ul>
  <p>When an attacker finds a vulnerability in the login script and attempts to steal several accounts, the 24x7 monitoring team immediately sees the attempts in the logs, locks the accounts, blocks the attacker and works with development to deploy a fix.</p>
  <h1>Related Guideline</h1>
  <ul>
    <li>
      <a href="/article/dd1a00d0-7951-43f8-8f13-a719348b1b02">Guideline: Instrument Application for Unusual Activity</a>
    </li>
  </ul>
  <p />
  <hr />
  <p />
  <p>Adapted from Microsoft patterns & practices guidance. </p>