<h1>Applies to</h1>
  <ul>
    <li>Applications written using Servlets or JSP.</li>
  </ul>
  <h1>What to Do</h1>
  <p>Use a global exception handler to catch any unhandled exceptions. A global exception handler improves the application's robustness and minimizes the risk of information disclosure.</p>
  <h1>Why</h1>
  <p>Unhandled exceptions can be a serious stumbling block to an application's performance and security. Unhandled exceptions must be avoided as they can result in the application entering an unknown state and/or revealing sensitive internal application details. Using a global exception handler will prevent unhandled exceptions.</p>
  <h1>When</h1>
  <p>If your application can throw an exception, use a global exception handler.</p>
  <h1>How</h1>
  <p>Global exception handlers will catch any exceptions that are not otherwise handled in your code. Use the following steps to set global exception handling:</p>
  <ol>
    <li>
      <p>
        <strong>Place handler in root code. </strong>Setting up the global exception handlers involves placing portions of the root execution code inside <em>try/catch/finally</em> blocks where the caught exception is of type <em>java.lang.Throwable</em>. Since the purpose of the global exceptions is to clean-up and bring your application into a known state, you should be careful when choosing which portions of the root execution code to place inside such blocks. Depending on your application's specifications, your application may either recover and continue working or exit gracefully. In each of these cases, the global exception handlers will be placed differently.</p>
      <li>
        <p>
          <strong>Recover and continue. </strong>The root <em>try/catch/finally</em> block is placed inside a loop. This allows your application to recover from the exception and restart the execution of its current task. Example:</p>
        <pre>public void doGet(HttpServletRequest request,<br />      HttpServletResponse response) throws ServletException, IOException&amp;#123;<br />      PrintWriter out = response.getWriter();<br />      workDone = false;<br /><br />      while (&amp;#33;workDone)<br />      &amp;#123;<br />            try<br />            &amp;#123;<br />                  ...<br />            &amp;#125;<br />            catch (Throwable e)<br />            &amp;#123;<br />                  logger.severe("Unhandled exception was caught:\n"<br />                            &amp;#43; e.toString());<br />                  out.println("An error has occurred.");<br />            &amp;#125;<br />      &amp;#125;<br /><br />      out.flush();<br />      out.close();<br />&amp;#125;</pre>
        <li>
          <p>
            <strong>Exit gracefully. </strong>There are two approaches to placing an exception handler that allows your application to exit gracefully:</p>
          <ul>
            <li>
              <p>
                <strong>Dynamic handling</strong>: This allows the handling to be conducted inside the Java code. It consists of placing the entire root execution code inside a <em>try/catch/finally</em> block. Using dynamic handling allows your application to log the error and provide an error message to the user without having to disclose any detailed information about the raised exception. Example:</p>
              <pre>public void doGet(HttpServletRequest request,<br />      HttpServletResponse response) throws ServletException, IOException&amp;#123;<br />      PrintWriter out = response.getWriter();<br />      workDone = false;<br /><br />      try<br />      &amp;#123;<br />            ...<br />      &amp;#125;<br />      catch (Throwable e)<br />      &amp;#123;<br />            //Execute clean-up routine<br /><br />            logger.severe("Unhandled exception was caught:\n"<br />                       &amp;#43; e.toString());<br />            out.println("An error has occurred.");<br />      &amp;#125;<br /><br />      out.flush();<br />      out.close();<br />&amp;#125;</pre>
              <li>
                <p>
                  <strong>JSP error pages</strong>: JSP error pages provide an effective way for placing a global exception handler. If an unhandled exception appears, JSP provides a mechanism for redirecting the user to an error page; therefore, the user never sees the actual error. Example:</p>
                <pre>&lt;&amp;#37;&amp;#64; page errorPage="error.html" &amp;#37;&gt;</pre>
                <p>The JSP error pages should begin with the <em>&lt;&amp;#37;&amp;#64;page &amp;#37;&gt;</em> tag. For example:</p>
                <pre>&lt;&amp;#37;&amp;#64; page isErrorPage="true" &amp;#37;&gt;</pre>
              </li>
            </li>
          </ul>
          <li>
            <p>
              <strong>Ensure an error page is setup for all unhandled java.lang.Throwable exceptions.</strong> This configuration allows the application to gracefully catch exceptions and redirect the user to a generic error page</p>
            <pre>&amp;nbsp;&lt;error-page&gt;<br />&amp;nbsp;&amp;nbsp; &lt;exception-type&gt;java.lang.Throwable&lt;/exception-type&gt;<br />&amp;nbsp;&amp;nbsp; &lt;location&gt;/error/errorGeneric.jsp&lt;/location&gt;<br />&amp;nbsp;&lt;/error-page&gt;</pre>
            <li>
              <p>
                <strong>Ensure an error page is setup for all relevant HTTPerror codes.</strong> This configuration allows the application to gracefully catch HTTP error codes and redirect the user to a generic error page.</p>
              <pre>&lt;error-page&gt;<br />&amp;nbsp;&amp;nbsp; &lt;error-code&gt;404&lt;/error-code&gt;<br />&amp;nbsp;&amp;nbsp; &lt;location&gt;/error/error404.jsp&lt;/location&gt;<br />&amp;nbsp;&lt;/error-page&gt;<br />&amp;nbsp;&lt;error-page&gt;<br />&amp;nbsp;&amp;nbsp; &lt;error-code&gt;500&lt;/error-code&gt;<br />&amp;nbsp;&amp;nbsp; &lt;location&gt;/error/error500.jsp&lt;/location&gt;<br />&amp;nbsp;&lt;/error-page&gt;</pre>
            </li>
          </li>
        </li>
      </li>
    </li>
  </ol>
  <h1>Problem Example</h1>
  <p>The following code produces a data analysis based on a financial index. Unfortunately, there is no global exception handling. Therefore, an attacker can force the application to reveal its call stack and possibly the source code filenames&amp;nbsp;by triggering an unhandled exception.</p>
  <pre>import java.io.&amp;#42;;<br />import java.util.&amp;#42;;<br />import java.lang.&amp;#42;;<br />import javax.servlet.&amp;#42;;<br />import javax.servlet.http.&amp;#42;;<br />import java.util.regex.&amp;#42;;<br /><br />public final class DataAggregator extends HttpServlet&amp;#123;<br />      public void doGet(HttpServletRequest request, HttpServletResponse response)<br />            throws ServletException, IOException<br />      &amp;#123;<br />            PrintWriter out = response.getWriter();<br />            String searchTerm = request.getParameter("index");<br /><br />            // The application does not provide a global exception handler<br />            if (validateSearchTerm(searchTerm))<br />            &amp;#123;<br />                  String retString;<br /><br />                  retString = "The queried index \"";<br />                  retString &amp;#43;= encodeHtml(searchTerm);<br />                  retString &amp;#43;= "\" produced the following results:&lt;br&gt; ";<br />                  out.println(retString);<br />                  aggregateData(out, searchTerm);<br />            &amp;#125;<br />            else<br />            &amp;#123;<br />                  // Add the appropriate logging mechanisms<br />                  // Consult the Logging section<br /><br />                  out.println("We cannot handle your request at the moment.<br />                           &amp;#43; " Please try again later.");<br />            &amp;#125;<br /><br />            out.flush();<br />            out.close();<br />      &amp;#125;<br />&amp;#125;</pre>
  <h1>Solution Example</h1>
  <p>The following code produces a data analysis based on a financial index. Because the code provides a global exception, it is impossible for an unhandled exception to surface to the client. Therefore, no debug and source data will be disclosed&amp;nbsp;to the attacker.</p>
  <pre>import java.io.&amp;#42;;<br />import java.util.&amp;#42;;<br />import java.lang.&amp;#42;;<br />import javax.servlet.&amp;#42;;<br />import javax.servlet.http.&amp;#42;;<br />import java.util.regex.&amp;#42;;<br /><br />public final class DataAggregator extends HttpServlet&amp;#123;<br />      public void doGet(HttpServletRequest request, HttpServletResponse response)<br />            throws ServletException, IOException<br />      &amp;#123;<br />            PrintWriter out = response.getWriter();<br />            String searchTerm = request.getParameter("index");<br /><br />            // The application provides a global exception handler<br />            try<br />            &amp;#123;<br />                  if (validateSearchTerm(searchTerm))<br />                  &amp;#123;<br />                        String retString;<br /><br />                        retString = "The queried index \"";<br />                        retString &amp;#43;= encodeHtml(searchTerm);<br />                        retString &amp;#43;= "\" produced the following results:&lt;br&gt; ";<br />                        out.println(retString);<br />                        aggregateData(out, searchTerm);<br />                  &amp;#125;<br />                  else<br />                  &amp;#123;<br />                        // Add the appropriate logging mechanisms<br />                        // Consult the Logging section<br /><br />                        out.println("We cannot handle your request at the moment.<br />                                 &amp;#43; " Please try again later.");<br />                  &amp;#125;<br />            &amp;#125;<br /><br />            catch (Throwable e)<br />            &amp;#123;<br />                  // Add the appropriate logging mechanisms<br />                  // Consult the Logging section<br /><br />                  out.println("We cannot handle your request at the moment."<br />                           &amp;#43; " Please try again later.");<br />            &amp;#125;<br /><br />            out.flush();<br />            out.close();<br />      &amp;#125;<br />&amp;#125;</pre>