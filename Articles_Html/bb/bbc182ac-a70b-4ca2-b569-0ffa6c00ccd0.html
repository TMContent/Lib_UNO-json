<h1>Applies To</h1>
  <ul>
    <li>ASP.NET 4.0</li>
  </ul>
  <h1>Summary</h1>
  <p>This code demonstrates how to implement security output encoding when using the .NET <em>DataTable</em> object to display application data. Output encoding mitigates against client-side script vulnerabilities by representing output data using escape character equivalents for values that might otherwise be interpreted by the browser, such as those characters used in the formatting of HTML pages (&lt;,&gt;,&,",').</p>
  <h1>Objectives</h1>
  <ul>
    <li>Protect application users from client-side scripting attacks.</li>
    <li>Ensure that malicious data that may pre-date input validation routines or have been missed through poor validation does not render as application output.</li>
  </ul>
  <h1>Scenarios</h1>
  <ul>
    <li>Database-backed web application that uses data tables to present output.</li>
    <li>Application that uses data tables to present input from an untrusted source.</li>
  </ul>
  <h1>Problem Example</h1>
  <p>The following example demonstrates the use of a DataTable to query data without the use of any output encoding:</p>
  <pre>// Build a datagrid to house our data and add to the set of page controls<br />DataGrid dataGrid = new DataGrid();<br />this.Controls.Add(dataGrid);<br /><br /><br />// Create a new database connection using Integrated Security and open that connection<br />string connectionString =<br /> "Initial Catalog=snippets;Data Source=vm-win2003\\sqlexpress;Integrated Security=SSPI;";<br />SqlConnection cn = new SqlConnection(connectionString);<br />cn.Open();<br /><br />// Create a new SQL Command object with a query to execute the stored procedure<br />SqlCommand cmd = new SqlCommand("exec spFullNames", cn);<br />SqlDataAdapter adapter = new SqlDataAdapter(cmd);<br /><br />// Create a new data table and fill our that table with names from the adapter <br />DataTable names = new DataTable();<br />adapter.Fill(names); <br /><br />// Present the data to the user in the previously created Data Grid<br />dataGrid.DataSource = names;<br />dataGrid.DataBind();</pre>
  <ul>
    <li>Any HTML data present within the database query output will be rendered as part of the application HTML output.</li>
    <li>Any Javascript data present within the database query output will be rendered as part of the application HTML output.</li>
    <li>Code is vulnerable to client-side script attacks such as cross-site scripting (XSS).</li>
  </ul>
  <h1>Test Case</h1>
  <p>The following classes must be included in any project making use of the sample code provided above:</p>
  <pre>using System.Data;<br />using System.Data.SqlClient;<br />using System.Web;</pre>
  <p>Create a new C# ASP.NET application and use the following <em>Page_Load</em> method to test the provided example methods (adjust database code for your example):</p>
  <pre>protected void Page_Load(object sender, EventArgs e)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp; if (!Page.IsPostBack)<br />&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Create a new database connection using Integrated Security and open that connection<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string connectionString = "Initial Catalog=snippets;Data Source=vm-win2003\\sqlexpress;Integrated Security=SSPI;";<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SqlConnection cn = new SqlConnection(connectionString);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cn.Open(); <br />&nbsp;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Create a new SQL Command object with a query to execute the stored procedure<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SqlCommand cmd = new SqlCommand("exec spFullNames", cn);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SqlDataAdapter adapter = new SqlDataAdapter(cmd);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadEncodedPeopleTableEvent(adapter);<br />&nbsp;&nbsp;&nbsp;&nbsp; }<br />}</pre>
  <h1>Expected Result</h1>
  <pre>&lt;table cellspacing="0" rules="all" border="1" style="border-collapse:collapse;"&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;tr&gt;&lt;td&gt;Name&lt;/td&gt;&lt;/tr&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;tr&gt;&lt;td&gt;Elvin Jones&lt;/td&gt;&lt;/tr&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;tr&gt;&lt;td&gt;Gene Krupa&lt;/td&gt;&lt;/tr&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;tr&gt;&lt;td&gt;Tony Williams&lt;/td&gt;&lt;/tr&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;tr&gt;&lt;td&gt;&lt;script&gt;alert('XSS!');&lt;/script&gt; XSS&lt;/td&gt;&lt;/tr&gt;<br />&lt;/table&gt;</pre>
  <h1>More Information</h1>
  <ul>
    <li>In addition to output validation, developers should always validate any input that originates from untrusted sources, such as application users or external feeds. </li>
  </ul>
  <br />
  <hr />
  <p>Adapted from Microsoft patterns & practices guidance.</p>
  <h1>
  </h1>