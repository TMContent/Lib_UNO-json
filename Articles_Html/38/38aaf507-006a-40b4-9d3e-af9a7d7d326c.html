<h1>Applies to</h1>
  <ul>
    <li>ASP.NET 4.0</li>
  </ul>
  <h1>Summary</h1>
  <p>This How to shows you how to use the <em>Authorization Manager (AzMan)</em> in conjunction with the ASP.NET role manager API to manage roles, check user role membership, and authorize roles to perform specific operations against an <em>AzMan</em> policy store. The How to also explains how to use <em>Authorization Manager</em>'s authorization model of tasks and operations through the <em>AzMan</em> COM API. </p>
  <p>The benefit of using <em>AzMan</em> is that it enables you to define operations, group them into tasks, and then authorize roles to perform specific tasks. It also provides an administrative console for managing roles, tasks, operations, and users.</p>
  <h1>Contents</h1>
  <ul>
    <li>Objectives </li>
    <li>Overview </li>
    <li>Summary of Steps </li>
    <li>Step 1. Create an AzMan Policy Store </li>
    <li>Step 2. Define Tasks and Operations </li>
    <li>Step 3. Create Roles and Assign Users in AzMan </li>
    <li>Step 4. Configure Your ASP.NET Application to Use AuthorizationStoreRoleProvider </li>
    <li>Step 5. Use Role Manager to Perform a Role Check </li>
    <li>Step 6. Use AzMan APIs to Authorize Operations </li>
    <li>ASP.NET Web Site Configuration Tool </li>
    <li>Security Considerations </li>
    <li>ADAM Considerations </li>
    <li>Additional Resources</li>
  </ul>
  <h1>Objectives</h1>
  <ul>
    <li>Identify when to use Authorization Manager (AzMan). </li>
    <li>Create a policy store, define tasks, operations, and role assignments using AzMan. </li>
    <li>Configure your Web application to use AuthorizationStoreRoleProvider. </li>
    <li>Use AzMan APIs to authorize operations. </li>
  </ul>
  <h1>Overview</h1>
  <p>
    <em>Authorization Manager (AzMan)</em> enables you to define individual operations, which can be grouped together to form tasks. You can then authorize roles to perform specific tasks and/or individual operations. <em>AzMan</em> provides an administration tool as a Microsoft Management Console (MMC) snap-in to manage roles, tasks, operations, and users. You can configure an <em>AzMan</em> policy store in an XML file, Active Directory, or in an Active Directory Application Mode (ADAM) store. By configuring the ASP.NET role manager to use the <em>AuthorizationStoreRoleProvider</em>, you can use the role management API against an AzMan policy store. The <em>AuthorizationStoreRoleProvider</em> does not support <em>AzMan business rules ("BizRules")</em>, which are scripted extensions to authorization checks, because the role manager implementation does not have the concept of extended data that can be passed along during an authorization check. To use <em>AzMan BizRules</em>, you need to use COM interop.</p>
  <h2>Roles API vs. Authorization Manager</h2>
  <p>ASP.NET role manager provides an API that enables you to manage application roles, add and remove users from roles, and check role membership, but it does not allow you to query whether a user is authorized to perform a named task or operation. <em>AzMan</em> allows you to define individual operations and combine them into tasks. With <em>AZMan</em>, in addition to role checks, you can also check whether a user can perform a task. Role assignment and task authorization can be configured outside of the application or performed programmatically within the application. The <em>AzMan</em> administration MMC snap-in allows administrators to change the tasks a role may perform at run time and to manage each user's membership of roles.</p>
  <p>At run time, if you are using the ASP.NET roles API, you programmatically query a user's role membership. Using the <em>AzMan</em> COM API and the <em>AccessCheck</em> function, you query whether a user is authorized to perform a named task.</p>
  <p>You should use <em>AzMan</em> to design and implement role-based authorization if you want to design a more fine-grained role-based authorization approach around operations and tasks, and if you want the additional flexibility of allowing an administrator to create, delete, and administer the permissions assigned to a role at run time.</p>
  <h1>Summary of Steps</h1>
  <p>To use the ASP.NET role manager to check user role membership in an <em>Authorization Manager</em> policy store, perform the following steps: </p>
  <ul>
    <li>Step 1. Create an AzMan policy store. </li>
    <li>Step 2. Define tasks and operations. </li>
    <li>Step 3. Create roles and assign users in AzMan. </li>
    <li>Step 4. Configure your ASP.NET application to use AuthorizationStoreRoleProvider. </li>
    <li>Step 5. Use role manager to perform a role check. </li>
    <li>Step 6. Use AzMan APIs to authorize operations.</li>
  </ul>
  <h1>Step 1. Create an AzMan Policy Store</h1>
  <p>You can create <em>AzMan</em> policy stores in an XML file, Active Directory, or ADAM. In this step, you create an <em>AzMan</em> policy store in an XML file.</p>
  <p>
    <b>To create an AzMan Policy store</b>
  </p>
  <ol>
    <li>At the Windows command prompt, enter <em>azman.msc</em> to open the Authorization Manager MMC snap-in. </li>
    <li>On the <em>Action</em> menu, click <em>Options</em>, and then click <em>Developer mode</em>. <em>Developer mode</em> exposes options, such as store creation, that are not available in <em>Administrator</em> mode. </li>
    <li>On the <em>Action</em> menu, click <em>New Authorization Store</em>. Set the Authorization store type as <em>XML File</em>. </li>
    <li>Enter the full store name, for example: <em>C:\RolesData\AzManStore.xml</em>. You can click the <em>Locations</em> button to navigate to the <em>AzMan</em> store, or you can create a folder where you will store it. </li>
    <li>Right-click <em>AzManStore.xml</em>, and then click <em>Properties</em>. In the Properties window, click the <em>Security</em> tab. </li>
    <li>Under <em>Authorization Manager user role</em>, select <em>Administrator</em>. Click the <em>Add</em> button to add the account that ASP.NET uses (the <em>Network Service</em> account) to this role. </li>
  </ol>
  <p>
    <b>Note:</b>&amp;nbsp;If your ASP.NET application uses impersonation to impersonate the original caller or a fixed identity, or if it runs under a different custom account, you must add the impersonated account or custom account as an <em>Administrator</em>, or <em>Reader</em>, according to the level of access required.</p>
  <p>
    <b>To create the AzMan application</b>
  </p>
  <ol>
    <li>Make sure <em>AzManStore.xml</em> is selected in the console tree. On the <em>Actions</em> menu, click <em>New Application</em>. </li>
    <li>Enter a name for your application. For this example, enter <em>AzManDemo</em> in the <em>Application Name</em> box, and leave the <em>Description</em> and <em>Version Info</em> boxes empty. </li>
  </ol>
  <h1>Step 2. Define Tasks and Operations</h1>
  <p>Use the following steps to define tasks and operations. Note that you do not need to perform this step if you intend to use only the ASP.NET <em>Role Manager</em> API, which can only authorize users on role membership; it cannot authorize users by application task or operation. Perform these steps if you want to use the <em>AzMan</em> COM API to authorize by task or operation.</p>
  <p>
    <b>To define tasks</b>
  </p>
  <ol>
    <li>On the console tree, expand <em>AzManDemo</em>, and then expand <em>Definitions</em>. </li>
    <li>Right-click <em>Task Definitions</em>, and then click <em>New Task Definition</em>. </li>
    <li>In the <em>Name</em> box, type<em> Privileged Task</em>, and then click <em>OK</em>. </li>
  </ol>
  <p>
    <b>To define operations </b>
  </p>
  <ol>
    <li>On the console tree, expand <em>AzManDemo</em>, and then expand <em>Definitions</em>. </li>
    <li>Right-click the <em>Operation Definitions</em>, and then click <em>New Operation Definition</em>. </li>
    <li>In the <em>Name</em> box, type <em>Do Sensitive Operation</em>, type <em>1</em> in the <em>Operation number</em> box, and then click <em>OK</em>. </li>
  </ol>
  <p>
    <b>To associate operations with tasks</b>
  </p>
  <ol>
    <li>In the <em>Task Definitions</em> folder, double-click the <em>Privileged Task</em>, task that you previously created. </li>
    <li>Click the <em>Definition</em> tab, and then click <em>Add</em>. </li>
    <li>In the <em>Add Definition</em> dialog box, click the <em>Operations</em> tab, and then select the <em>Do Sensitive Operation</em> check box. Click <em>OK</em>, and then click <em>OK</em> again. This assigns the newly created operations to the task named <em>Privileged Task</em>. <p><b>Note: </b>An <em>AzMan</em> task is an optional abstraction and if an application has only a few operations defined, it may make sense to just use operations.</p></li>
  </ol>
  <h1>Step 3. Create Roles and Assign Users in AzMan</h1>
  <p>In this step, you use the <em>AzMan</em> administration MMC snap-in to create a role named <em>Manager</em>. You then assign the task that you created in the previous step to the role.</p>
  <p>
    <b>To define roles with the AzMan administration MMC snap-in</b>
  </p>
  <ol>
    <li>At the Windows command prompt, type <em>azman.msc</em> to open the Authorization Manager MMC snap-in. </li>
    <li>On the <em>Action</em> menu, click <em>Options</em>, and then click <em>Administrator mode</em>. Administrator mode exposes fewer options than developer mode, but it exposes only those configuration options that can be changed at run time, such as assigning tasks to roles and assigning users to roles. </li>
    <li>On the <em>AzMan</em> Management Console tree, expand <em>AzManDemo</em>, and then expand <em>Definitions</em>. </li>
    <li>Right-click <em>Role Definitions</em>, and then click <em>New Role Definition</em>. </li>
    <li>In the <em>Name</em> box, type <em>Manager</em>, and then click <em>OK</em>. </li>
  </ol>
  <p>
    <b>To assign a user to a role with the Administration UI</b>
  </p>
  <ol>
    <li>Right-click the <em>Role Assignments</em> folder, and then click <em>Assign Roles</em>. </li>
    <li>In the dialog box that appears, click the <em>Manager</em> check box, and then click <em>OK</em>. </li>
    <li>Right-click the <em>Manager</em> role listed after the <em>Role Assignments</em> folder in the console tree, and then click <em>Assign Windows Users and Groups</em>. </li>
    <li>Type the name of the Windows user account you are logged on as, click <em>Check Names</em>, and then click <em>OK</em>. This assigns your user account to the <em>Manager</em> role. </li>
  </ol>
  <p>
    <b>To associate tasks with roles</b>
  </p>
  <ol>
    <li>In the <em>Role Definitions</em> folder, double-click the <em>Manager</em> role you created previously. </li>
    <li>Click the <em>Definition</em> tab, and then click <em>Add</em>. </li>
    <li>In the <em>Add Definition</em> dialog box, click the <em>Tasks</em> tab, and then click the <em>Privileged Task</em> check box (this is the task you created in the previous step). Click <em>OK</em> twice. This assigns the <em>Privileged Task</em> task to the <em>Manager</em> role. </li>
  </ol>
  <h1>Step 4. Configure Your ASP.NET Application to Use AuthorizationStoreRoleProvider</h1>
  <p>In this step, you configure role management in an ASP.NET application to use the AzMan store.</p>
  <p>
    <b>To connect to the AzMan store</b>
  </p>
  <ol>
    <li>Create a new ASP.NET Web site named <em>AzManRoles</em>. </li>
    <li>Define a connection string to the <em>AzMan</em> policy store in the &lt;<em>connectionStrings</em>&gt; element of the <em>Web.config</em> file. For example, to create a connection string to <em>C:\RolesData\AzManStore.xml</em>, use the following configuration. <pre>&lt;configuration&gt; <br />&amp;nbsp; &lt;connectionStrings&gt; <br />&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;add name="LocalPolicyStore" <br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; connectionString="msxml://c:/RolesData/azmanstore.xml" /&gt;<br />&amp;nbsp; &lt;/connectionStrings&gt; <br />&lt;/configuration&gt;   </pre></li>
    <li>Configure the application to use the role provider by adding the following elements as children of the &lt;<em>system.web</em>&gt; element. <pre>&lt;system.web&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;roleManager <br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; enabled="true" <br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; cacheRolesInCookie="true" <br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; defaultProvider="RoleManagerAzManProvider"<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; cookieName=".ASPXROLES" <br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; cookiePath="/" <br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; cookieTimeout="30" <br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; cookieRequireSSL="true" <br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; cookieSlidingExpiration="true"<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; createPersistentCookie="false" <br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; cookieProtection="All"&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;providers&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;add name="RoleManagerAzManProvider"<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; type="System.Web.Security.AuthorizationStoreRoleProvider, System.Web, Version=2.0.0.0, <br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Culture=neutral, publicKeyToken=b03f5f7f11d50a3a"<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; connectionStringName="LocalPolicyStore" <br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; applicationName="AzManDemo"/&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;/providers&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;/roleManager&gt;<br />&lt;/system.web&gt;  </pre></li>
  </ol>
  <p>In the preceding configuration file fragment, you define a &lt;<em>providers</em>&gt; element that uses the <em>AuthorizationStoreRoleProvider</em>, with the <em>connectionStringName</em> attribute set to the name of the connection string you defined in the previous step, and you must set the <em>applicationName</em> attribute to the name of the <em>AzMan</em> application you created in the <em>AzMan</em> store.</p>
  <p>
    <b>Note:</b>&amp;nbsp;By ensuring unique values for the <em>cookieName</em> and <em>cookiePath</em> attributes, you prevent possible problems that can occur when hosting multiple applications on the same server. This best practice will prevent a user on one site from using his or her role cookie on a different site hosted on the same server.</p>
  <h1>Step 5. Use Role Manager to Perform a Role Check</h1>
  <p>At run time, you can use roles to authorize access in two ways: </p>
  <ul>
    <li>Use role authorization to restrict access to pages and folders. </li>
    <li>Use the roles API to programmatically check for role membership. </li>
  </ul>
  <h2>Role Authorization</h2>
  <p>A typical use for roles is to establish rules that allow or deny access to pages or folders. You can set up such access rules in the &lt;<em>authorization</em>&gt; section of the <em>Web.config</em> file. The following example allows users in the role of members to view pages in the folder named <em>memberPages</em> and denies access to anyone else.</p>
  <pre>&lt;configuration&gt;<br />&amp;nbsp;&amp;nbsp; &lt;location path="memberPages"&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;system.web&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;authorization&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;allow roles="Manager" /&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;deny users="*" /&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;/authorization&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;/system.web&gt;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;/location&gt;<br />&amp;nbsp;&amp;nbsp; &lt;!-- other configuration settings here --&gt;<br />&lt;/configuration&gt;  </pre>
  <h2>Roles API</h2>
  <p>If you are using Windows authentication in your application, or if you are using Forms authentication with the ASP.NET membership feature, you can use <em>Roles</em> API methods such as <em>Roles.IsUserInRole("roleName")</em> to test for role membership for the currently authenticated user or <em>Roles.GetRolesForUser() </em>to return a string array of all roles for the user. </p>
  <p>You can use <em>Roles.IsUserInRole("username", "roleName")</em> to test for role membership for a named user. </p>
  <h1>Step 6. Use AzMan APIs to Authorize Operations</h1>
  <p>With <em>AzMan</em>, the primary mechanism to determine access to a given operation is the <em>AccessCheck</em> API. In this step, you use the <em>Authorization Manager</em> API in an ASP.NET application to query the operations that are in a task to determine whether the current user is authorized to perform them. The ability in the <em>AzMan</em> API to query for authorization to perform an operation or task exceeds the capabilities of the ASP.NET <em>Role Management</em> API, which only supports role membership checks.</p>
  <p>
    <b>To connect to the AzMan store</b>
  </p>
  <ol>
    <li>Create a new C# ASP.NET Web site named <em>AccessingTasks</em>. </li>
    <li>Add a reference to the <em>AzMan</em> COM library. In the <em>Add Reference</em> dialog box, click the <em>COM</em> tab, and then select <em>azroles 1.0 Type Library</em>. Click <em>OK</em>. </li>
    <li>Add the following using statements to the code page of the <em>Default.aspx</em> page. <pre>using AZROLESLib;<br />using System.Collections.Specialized;<br />using System.Security.Principal;   </pre></li>
    <li>To open the <em>AzMan</em> policy store, add the following code. Use the same connection string as defined at the beginning of step 5. <pre>AzAuthorizationStoreClass AzManStore = new AzAuthorizationStoreClass();<br />AzManStore.Initialize(0, ConfigurationManager.ConnectionStrings<br />            ["LocalPolicyStore"].ConnectionString, null);<br />IAzApplication azApp = AzManStore.OpenApplication("AzManDemo", null);  </pre></li>
  </ol>
  <p>Now check whether a user is authorized to complete the operation. The sample code in the following procedure checks if the authenticated user is authorized to perform an operation.</p>
  <p>
    <b>To check whether a user is authorized to perform an operation</b>
  </p>
  <ol>
    <li>Construct a representation of the client's security context. The context is similar to a token in that it caches role mappings for a user. To create the client's context object: <ol><li>If your application uses Windows authentication (the application Web.config file specifies <em>authentication mode='Windows'</em>, and Microsoft Internet Information Services (IIS) has been configured to require integrated Windows authentication), construct the client context a follows. <pre>    // Get the current user context <br />&amp;nbsp;&amp;nbsp;&amp;nbsp; IPrincipal userPrincipal = HttpContext.Current.User;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp; WindowsIdentity userIdentity = userPrincipal.Identity as WindowsIdentity;<br />&amp;nbsp;&amp;nbsp;&amp;nbsp; IAzClientContext clientContext =<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; azApp.InitializeClientContextFromToken(<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; (ulong)userIdentity.Token, null);  </pre></li><li>If your application uses an authentication mechanism where you only have the original caller's user name available, but you do not have the password, you can construct the client context as shown in the following example. <pre>IAzClientContext clientContext =<br />   azApp.InitializeClientContextFromName(name, domain, null);  </pre></li></ol></li>
    <li>Use the client context object and <em>AzMan</em> to determine whether the user is authorized to perform the operations. <p>The <em>AccessCheck</em> method returns an object array that is actually an array of integers, one for each requested operation. If any of the integers are nonzero, the user is not authorized to perform the corresponding operation in the operations array. </p><pre>    // Create an object array describing the operation IDs to query&amp;nbsp; <br />&amp;nbsp;&amp;nbsp;&amp;nbsp; // In this simple example, query for the single operation called<br />&amp;nbsp;&amp;nbsp;&amp;nbsp; // 'Do Sensitive Operation' which has an ID of 1.<br />&amp;nbsp;&amp;nbsp;&amp;nbsp; object[] operationIds = new object[] {1};<br /><br />&amp;nbsp;&amp;nbsp;&amp;nbsp; // Check if user has access to the operations<br />&amp;nbsp;&amp;nbsp;&amp;nbsp; // The first argument, "Auditstring", is a string that is used if you <br />&amp;nbsp;&amp;nbsp;&amp;nbsp; // have run-time auditing turned on<br />&amp;nbsp;&amp;nbsp;&amp;nbsp; object[] result = (object[])clientContext.AccessCheck("Auditstring",<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; new object[1], operationIds, null, null, null, null, null);<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; <br />&amp;nbsp;&amp;nbsp;&amp;nbsp; // Test the integer array we got back to see which operations are<br />&amp;nbsp;&amp;nbsp;&amp;nbsp; // authorized<br />&amp;nbsp;&amp;nbsp;&amp;nbsp; int accessAllowed = (int)result[0];<br />&amp;nbsp;&amp;nbsp;&amp;nbsp; if (accessAllowed != 0)<br />&amp;nbsp;&amp;nbsp;&amp;nbsp; {<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; // current user not authorized to perform operation<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Response.Write("User not authorized for operation: " +<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; "Do Sensitive Operation" + "&lt;br /&gt;");<br />&amp;nbsp;&amp;nbsp;&amp;nbsp; }<br />&amp;nbsp;&amp;nbsp;&amp;nbsp; else<br />&amp;nbsp;&amp;nbsp;&amp;nbsp; {<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; // current user authorized to perform operation<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Response.Write("User authorized for operation " +<br />&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; "Do Sensitive Operation" + "&lt;br /&gt;");<br />&amp;nbsp;&amp;nbsp;&amp;nbsp; }      </pre></li>
  </ol>
  <p>When you save and run this code, the resulting page reports whether the current user is authorized to perform the operation.</p>
  <h1>ASP.NET Web Site Configuration Tool</h1>
  <p>The ASP.NET Web Site Configuration tool is built into Visual Studio. You can use this tool to assign users to roles, but only if your application uses forms authentication, because user management is disabled in this tool if you are using Windows authentication.</p>
  <p>
    <b>To assign users to roles with the ASP.NET Web Site Configuration tool</b>
  </p>
  <ol>
    <li>On the <em>Website</em> menu, click <em>ASP.NET Configuration</em>. </li>
    <li>Click the <em>Security</em> tab. </li>
    <li>Click <em>Create</em> or <em>Manage Roles </em></li>
    <li>In the table of roles, click <em>Manage</em> next to the role that you want to add a user to. </li>
    <li>Locate the desired user, and then click <em>Add Role</em>. </li>
  </ol>
  <h1>Security Considerations</h1>
  <p>If an XML policy store is used, access rights are controlled by NTFS ACLs. Reading a policy store requires Read access. Writing a policy store requires both <em>Read</em> and <em>Write</em> access. Any account that had rights to the XML file has rights to all applications and all scopes within the file. There is no support for delegated rights with the XML policy store.</p>
  <p>If an Active Directory or ADAM policy store is used, rights are expressed by way of roles defined in the store. Domain accounts (either a domain user or a machine account) can be added to the <em>Reader</em> and <em>Administrator</em> roles on the policy store, application, or scope using the <em>AzMan</em> MMC. Delegated rights are supported for Active Directory policy stores.</p>
  <h1>ADAM Considerations</h1>
  <p>This How to describes how to configure an <em>AzMan</em> policy store in an XML file. You can also create <em>AzMan</em> stores in Active Directory or in ADAM. </p>
  <br />
  <hr />
  <p>Adapted from Microsoft patterns &amp; practices guidance.</p>