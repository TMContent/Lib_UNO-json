<h2>Applies To</h2><ul><li> PHP</li>
</ul><h2>What to Do</h2><p>Scramble names and extensions of uploaded files.
</p><h2>Why</h2><p>Scramble names and extensions of uploaded files to make it more difficult for attackers to upload and execute malicious code. Even if an attacker is able to upload a malicious script, changing its file extension should prevent it from being executed. Changing the name of the file should also make it more difficult for the attacker to create an HTTP request to access the malicious script.
</p><h2>How</h2><p>To scramble names and extensions of uploaded files:
</p><ol>
<li> <strong>Find all code used to upload files.</strong> Search your application code for calls to move_uploaded_files(). Make a spreadsheet of this code.</li>
<li> <strong>Add code to maintain an uploaded-file lookup table.</strong> If the original file names need to be preserved, they should be stored in a lookup table, either in a database or in an XML file.</li>
<li> <strong>Add code to access uploaded files indirectly.</strong> For accessing the uploaded files, use a PHP script to read the specified file and return its contents. This can be used to show uploaded images in the browser or for any other purpose where users need to access the uploaded files. Using a PHP script to return the contents (rather than the web server processing the uploaded files as a result of direct request) ensures that the uploaded files will not be executed as code.</li>
<li> <strong>Change code to scramble file names.</strong> Web servers execute PHP files as code based on file extensions. If a file has an extension that is defined as code in the server's configuration, it will be executed. Common PHP file extensions are .php and .php5, but there may be others, depending on the server configuration. Scrambling the file extensions, or even removing them completely, prevents execution. Scrambling the file names also makes it more difficult for the attacker to find the uploaded file(s) and thus makes it harder to create HTTP requests that access those files directly.</li>
</ol>
