<h2>Applies To</h2>
<ul>
<li>ASP.NET 4.0</li>
</ul>
<h2>What to Check For</h2>
<p>Verify that stored procedures with type-safe parameters are used for SQL queries.</p>
<h2>Why</h2>
<p>Using stored procedures with type-safe parameters helps prevent SQL injection attacks.</p>
<h2>How To Check</h2>
<p>To verify that stored procedures with type-safe parameters are used for SQL queries:</p>
<ol>
<li>
<p><strong>Identify all SQL queries used by the application.</strong> Review code to find all functions that query the database.</p>
</li>
<li>
<p><strong>Make sure that stored procedures are used.</strong> Examine each function that queries the database to make sure that it uses stored procedures.</p>
</li>
<li>
<p><strong>Review stored procedures.</strong> Examine stored procedures used by the application to make sure they do not concatenate untrusted data into SQL syntax, but use parameters instead.</p>
</li>
</ol>
<h2>How To Fix</h2>
<p>First the stored procedure will have to be created on the database. Here is an example of a stored procedure:</p>
<pre><code>CREATE PROCEDURE sp_AddNewUser (@UserName nvarchar(255), @Email  nvarchar(255), @FirstName nvarchar(255), @LastName nvarchar(255)) AS
-- INSERT the new user
INSERT INTO Users_Table(UserName, Email, FirstName, LastName) VALUES(@UserName, @Email, @FirstName, @LastName);
</code></pre>
<p>Now to call the stored procedure we can use the following .NET code:</p>
<pre><code>//create a new connection using our connection string
SqlConnection myConnection = new SqlConnection(connection string);
myConnection.Open();
//create a new command that specifies our store procedure
SqlCommand myCommand = new SqlCommand(&quot;sp_AddNewUser&quot;, myConnection);
//Specify our command is a stored proceduremy
Command.CommandType = CommandType.StoredProcedure;
//Create a new parameter to carry the username
SqlParameter UserParameter = new SqlParameter(&quot;@UserName&quot;, SqlDbType.VarChar);
UserParameter.Direction = ParameterDirection.Input;
UserParameter.Value = &quot;TestUser&quot;;
//Add the parameter to the command
myCommand.Parameters.Add(UserParameter);
//Repeat this code to add commands for each parameter in the SPROC
//Execute the command on the Database
myCommand.ExecuteNonQuery();
</code></pre>
<hr>
<p>Adapted from Microsoft patterns &amp; practices guidance.</p>
