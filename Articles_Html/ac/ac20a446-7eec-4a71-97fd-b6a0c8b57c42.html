<h2>What to Check For</h2><p>Verify that uploaded files are stored in a location that is not web accessible.
</p><h2>Why</h2><p>Storing uploaded files in a location that is not web accessible prevents shell upload vulnerabilities. Even if an attacker manages to upload a malicious script, they won't be able to execute it if the malicious script is stored in a location that is not accessible from the web.
</p><h2>How to Check</h2><p>To verify that uploaded files are stored in a location that is not web accessible:
</p><ol>
<li> <strong>Determine where the application stores uploaded files.</strong> Examine the application design and file structure to determine where the application stores uploaded files. Uploaded files might be stored in a database, in which case they won't show up on the filesystem, and storing files in a database passes this checklist item.</li>
<li> <strong>Verify that the location where uploaded files are stored is not web accessible.</strong> If uploaded files are stored on the filesystem, determine their relative path in the application. Attempt to access some uploaded files and the uploads directory using HTTP requests on a deployed application to make sure that the location where uploaded files are stored is not web accessible. </li>
</ol>
<h2>How to Fix</h2><p>To store uploaded files in a location that is not web accessible:
</p><ol>
<li> <strong>Find all code used to upload files.</strong> Search your application for code that is used to upload files. Make a spreadsheet that enumerates this code. </li>
<li> <strong>Determine where to store uploaded files.</strong> It's possible to store uploaded files in a folder outside of the web root or in a database.<ol>
<li> Storing uploaded files outside the web root is a strong and easy to implement measure. However, it makes installing the application on a large amount of servers slightly more difficult, because the servers then need to be configured to allow storing files outside of the web root by creating a folder to store the uploaded files and granting the web server permissions to write to that folder. This additional configuration work is why many commercial applications store uploaded files in a web accessible location, and subsequently suffer from shell upload vulnerabilities. If you are using this approach, in the application installation instructions, document any special server configuration settings required to protect the uploads directory, and explain the risks of not protecting it. The main risk is that a web accessible uploads directory makes it easier for attackers to upload malicious code.</li>
<li> Another mitigation method is to store uploaded files in a database. Files stored in a database cannot be accessed directly via HTTP requests, so even if an attacker is able to upload a shell, they won't be able to access it. If the application is already using a database, there is no additional end-user configuration required. However, this method is harder to code, and there is some maintenance overhead because the database and backups might become quite large. </li></ol></li>
<li> <strong>Change code to store uploaded files outside web root.</strong> Change each piece of code that is used to handle uploaded files so that the uploaded files are stored in the chosen location that is not accessible from the web.</li>
</ol>