<h1>Applies To</h1>
  <ul>
    <li>ASP.NET 4.0</li>
  </ul>
  <h1>What to Check For</h1>
  <p>Ensure that Windows authentication is used when connecting the web-application to the SQL Server whenever possible.</p>
  <h1>Why</h1>
  <p>You do not need to embed user names and passwords in the database connection string when using Windows Authentication. With Windows Authentication, you also benefit from centralized account management. </p>
  <h1>How To Check</h1>
  <p>To verify that Windows authentication is used to connect to SQL server:</p>
  <ol>
    <li>
      <p>
        <strong>Check that a connection string is configured.</strong> Check that the connection string is stored in the &lt;<em>connectionStrings</em>&gt; section of your application's <em>Web.config</em> file and it includes either the <em>'Trusted_Connection=Yes</em>' attribute, or the equivalent attribute '<em>Integrated Security=SSPI</em>' as follows:</p>
      <pre>&nbsp;&lt;connectionStrings&gt;<br />&nbsp;&nbsp;&nbsp; &lt;add name="MyLocalSQLServer1"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connectionString="Server=MyServer;Database=pubs;Trusted_Connection=Yes;"/&gt;<br />&nbsp;&nbsp; &lt;add name="MyLocalSQLServer2"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connectionString="Initial Catalog=pubs;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; data source=localhost;Integrated Security=SSPI;"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; providerName="System.Data.SqlClient"/&gt;<br />&nbsp;&lt;/connectionStrings&gt;</pre>
    </li>
    <li>
      <p>
        <strong>Verify that the connection string is encrypted.</strong> Encrypting the connection string inside the configuration file ensures its confidentiality in case this file is compromised. Once the application accesses the configuration file, it should decrypt the connection string just before use. Once you have located the &lt;<em>connectionStrings</em>&gt; section in <em>Web.config</em>, it should look like the following:</p>
      <pre>&lt;connectionStrings&gt;<br />&nbsp; &lt;EncryptedData&gt;<br />&nbsp;&nbsp;&nbsp; &lt;CipherData&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;CipherValue&gt;GHAFQEW234A21...&lt;/CipherValue&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/CipherData&gt;<br />&nbsp; &lt;/EncryptedData&gt;<br />&lt;/connectionStrings&gt;</pre>
    </li>
    <li>
      <p>
        <strong>Ensure that SQL Server security is configured.</strong> Check that a SQL Server login has been created for your application's service account, and it has been granted restricted permissions to access your database. Ensure that you have provided no direct table access, and limited access to selected stored procedures only. Where table access is necessary, check that you have granted the minimum access required. </p>
    </li>
    <li>
      <p>
        <strong>Test security access.</strong> Check database access to ensure that appropriate database permissions are provided and permissions unnecessary to the application's operation are denied.</p>
    </li>
  </ol>
  <h1>How To Fix</h1>
  <p>To connect to SQL Server using Windows authentication, perform the following steps:</p>
  <ol>
    <li>
      <p>
        <strong>Configure a connection string.</strong> For ASP.NET applications, you should store connection strings in the &lt;<em>connectionStrings</em>&gt; section of your application's <em>Web.config</em> file. The connection string used with Windows authentication must include either the <strong>Trusted_Connection=Yes</strong> attribute, or the equivalent attribute <em>Integrated Security=SSPI</em>:</p>
      <pre>&nbsp;&lt;connectionStrings&gt;<br />&nbsp; &lt;add name="MyLocalSQLServer" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connectionString="Initial Catalog=pubs;User Id=sa;Password=asdasd;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; data source=localhost;Integrated Security=SSPI;"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; providerName="System.Data.SqlClient"/&gt;<br />&lt;/connectionStrings&gt;</pre>
    </li>
    <li>
      <p>
        <strong>Encrypt the connection string.</strong> Even though database connection strings for Windows authentication do not contain usernames and passwords, you should still encrypt them in <em>Web.config</em> to reduce the possibility of disclosing server names and database names. </p>
      <p>To encrypt the <em>connectionStrings</em> section&nbsp;with the Machine Store, run the following command from a .NET command prompt:</p>
      <pre>aspnet_regiis -pe "connectionStrings"<br /> -app "/MachineDPAPI" -prov "DataProtectionConfigurationProvider" </pre>
    </li>
    <li>
      <p>
        <strong>Configure SQL Server security.</strong> You need to create a SQL Server login for your application's service account, and grant restricted permissions to access your database. You should restrict access to specific database objects, such as stored procedures. </p>
    </li>
    <li>
      <p>
        <strong>Test security access.</strong> Test database access that appropriate database permissions are available. Just as important, test that permissions unneccessary to the application's operation are denied.&nbsp;</p>
    </li>
  </ol>
  <h1>Related Items</h1>
  <em>You may find these additional articles useful</em>
  <ul>
    <li>
      <a href="/article/6e58adbb-cf9f-4e3c-b867-20ba3f3f8a30">Use Windows Authentication When Connecting to SQL Server</a>
    </li>
  </ul>
  <hr />
  <p>Adapted from Microsoft patterns & practices guidance. </p>