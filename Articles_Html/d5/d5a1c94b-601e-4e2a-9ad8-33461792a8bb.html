<h2>Applies To</h2>
<ul>
<li>Java</li>
</ul>
<h2>What to Check For</h2>
<p>Ensure that type-safe SQL parameters are used with stored procedures or prepared statements when performing database transactions.</p>
<h2>Why</h2>
<p>Use type-safe parameters with parameterized APIs to prevent SQL injection. Attackers can use a SQL injection to manipulate the database in unforeseen ways. SQL injection allows an attacker to execute arbitrary queries on the application database. In some cases, SQL injection can result in command execution.</p>
<h2>How to Check</h2>
<p>To check if parameterized APIs with type-safe parameters are used to execute SQL queries:</p>
<ol>
<li>
<p><strong>Identify all database transactions.</strong> Locate all SQL queries throughout your application. Example: <code>&quot;select user from myappUsers where user = ? and pass = ?;&quot;</code></p>
</li>
<li>
<p><strong>Verify that each transaction uses stored procedures with type-safe parameters or prepared statements.</strong> Verify that your application interacts with the backend database through the use of parameterized APIs instead of concatenating untrusted data into SQL syntax.</p>
<p>An example of using a stored procedure:</p>
<pre><code> Connection.prepareStatement(&quot;exec PlaceOrder(?, ?, ?);&quot;);
</code></pre>
<p>An example of using a prepared statement:</p>
<pre><code> Connection cn = MyApp.getDBConnection();
 PreparedStatement st = cn.prepareStatement(
    &quot;select user from myappUsers where user = ? and pass = ?;&quot;);
 st.setString(1, user);
 st.setString(2, new String(passDigest));
 ResultSet rs = st.executeQuery();
</code></pre>
</li>
</ol>
<h2>How to Fix</h2>
<p>To use type-safe SQL parameters with parameterized APIs, follow these steps:</p>
<ol>
<li>
<p><strong>Identify the SQL queries.</strong> Locate all SQL queries throughout your application. Example:</p>
<pre><code> Connection cn = MyApp.getDBConnection();
 Statement st = cn.createStatement();
 String query = &quot;select login_attempts from myappUsers where user = \&quot;&quot; + user
              + &quot;\&quot; and pass = \&quot;&quot; + new String(passDigest) + &quot;\&quot;;&quot;;
 ResultSet rs = st.executeQuery(query);
</code></pre>
</li>
<li>
<p><strong>Identify the parameters in each SQL query.</strong> After locating all SQL queries, identify the parameters in each query. Understand the format and type of each parameter's data.</p>
</li>
<li>
<p><strong>Use PreparedStatement or stored procedures.</strong> Java supports parameterized queries via its PreparedStatement class. PreparedStatement is mapped by most databases to a parameterized query or a stored procedure. Turn all SQL queries into parameterized queries. To accomplish this, turn all Statement objects into PreparedStatement objects. For example, the SQL query from Step 1 would be:</p>
<pre><code> Connection cn = MyApp.getDBConnection();
 PreparedStatement st = cn.prepareStatement(&quot;select login_attempts from myappUsers&quot;
                      + &quot; where user = ? and pass = ?;&quot;);
 st.setString(1, user);
 st.setString(2, new String(passDigest));
 ResultSet rs = st.executeQuery();
</code></pre>
</li>
</ol>
<h2>Problem Example</h2>
<p>In the following example untrusted input is concatenated into SQL syntax, which causes SQL injection.</p>
<pre><code>// The application crafts the SQL query based on user's input
Connection cn = MyApp.getDBConnection();
Statement st = cn.createStatement();
String query = &quot;select login_attempts from myappUsers where user = \&quot;&quot;
            + user + &quot;\&quot; and pass = \&quot;&quot; + passHash + &quot;\&quot;;&quot;;
ResultSet rs = st.executeQuery(query);
</code></pre>
<h2>Solution Example</h2>
<p>The following code uses PreparedStatement, which prevents SQL injection:</p>
<pre><code>// The application uses parameterized queries
Connection cn = MyApp.getDBConnection();
PreparedStatement st = cn.prepareStatement(&quot;select user from myappUsers&quot;
                    + &quot; where user = ? and pass = ?;&quot;);
st.setString(1, user);
st.setString(2, passHash);
ResultSet rs = st.executeQuery();
</code></pre>
