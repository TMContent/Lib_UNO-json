<h1>What to Do</h1>
  <p>Log application events on a separate, protected server. </p>
  <h1>Why</h1>
  <p>If the primary server is compromised, logs which are located elsewhere cannot be compromised.&amp;nbsp; This prevents an attacker from covering their steps.&amp;nbsp; Also, the logging server can have a much smaller attack surface than the primary server, as it does not need to be accessible to end users.&amp;nbsp; This makes logs much harder to compromise than other parts of the site, which can be valuable when nonrepudiation is a primary business requirement. </p>
  <h1>When</h1>
  <p>Whenever you create log files in a client/server or web environment, putting them on a separate server is a good idea.&amp;nbsp; In practice, this may not be feasible for very small systems.&amp;nbsp; However, most systems with separate dedicated web/middle tier and database servers are large enough to warrant a dedicated log server. </p>
  <h1>How&amp;nbsp;</h1>
  <p>Use the following steps to log to a seperate server:</p>
  <ol>
    <li>
      <p>
        <strong>Ensure your application uses Health Monitoring. </strong>By default, health monitoring is enabled for ASP.NET applications. You can see the default configuration in the machine-level Web.config.comments file in the <b>&amp;#37;windir&amp;#37;\Microsoft .NET\Framework\&amp;#123;version&amp;#125;\CONFIG </b>configuration file directory. </p>
      <li>
        <p>
          <strong>Configure SqlWebEventProvider. </strong>If you want to configure an event provider that writes to a SQL Server instance, you must create the database used by the <b>SqlWebEventProvider</b>, configure a connection string, and configure a provider definition. </p>
        <ol>
          <li>Install the Web event database by running the following command from the Visual Studio command prompt: <p /><b>aspnet_regsql.exe -E -S </b>&lt;<b>ServerName</b>&gt;<b> -A w</b><p />This command uses the following switches: <ul><li><b>-E.</b> This switch indicates to use Windows authentication to connect to the database. <li><b>-S</b> &lt;<b>ServerName</b>&gt;<b>.</b> This switch indicates the name of the server where the database will be installed, or is already installed. <li><b>-A w. </b>This switch indicates to add Web event support. This creates the relevant tables and stored procedures required by the <b>SqlWebEventProvider</b>. </li></li></li></ul><li>Create a SQL Server logon for your Web application's identity. For example, create a network service and then create a database user for this logon in the Aspnetdb database. <li>Grant the database user <b>execute</b> permission on the <b>aspnet_WebEvent_LogEvent</b> stored procedure. <li>Add the following connection string to your application's Web.config file. <br /><pre>&lt;connectionStrings&gt;<br /> &amp;nbsp;&amp;nbsp; &lt;add name="MySqlConnection" connectionString=  "Data Source=remotehost;Initial Catalog=aspnetdb;Integrated Security=SSPI;"/&gt;<br />&lt;/connectionStrings&gt;</pre><li>Add the following &lt;<b>providers</b>&gt; configuration within the &lt;<b>healthMonitoring</b>&gt; section in Web.config. <br /><pre>&lt;providers&gt;<br />   &lt;add connectionStringName="MySqlConnection"<br />      maxEventDetailsLength="1073741823"<br />      buffer="true"<br />      bufferMode="Extra Critical Notification"<br />       name="MySqlWebEventProvider"<br />       type="System.Web.Management.SqlWebEventProvider,System.Web,Version=2.0.0 .0,<br />&amp;#9;&amp;#9;Culture=neutral,PublicKeyToken=b03f5f7f11d50a3a" /&gt;<br /> &lt;/providers&gt; </pre></li></li></li></li></li>
        </ol>
        <p />The following list describes the most important attributes you can set when configuring event providers: <ul><li><b>name. </b>This is a name for the buffer mode used to reference it from other elements. <li><b>type.</b> This is a fully-qualified assembly reference to the provider class. This class should implement the <b>System.Configuration.Provider.ProviderBase</b> class. <li><b>buffer.</b> If you are using the <b>SqlWebEventProvider</b>, use this attribute to enable event buffering. If this attribute is <b>true</b>, you must configure the <b>bufferMode</b> attribute. The default value is <b>false</b>. <li><b>bufferMode.</b> If you are using the <b>SqlWebEventProvider</b>, use this attribute to specify the friendly name of the buffer mode to be used for buffering the events. <li><b>connectionStringName.</b> If you are using the <b>SqlWebEventProvider</b>, use this attribute to specify the friendly name of the connection string used for connecting to the SQL Server database. <li><b>maxEventDetailsLength.</b> This is the maximum length of the event details. </li></li></li></li></li></li></ul><blockquote><b>Note</b>&amp;nbsp;&amp;nbsp;&amp;nbsp;If you want to use the <b>SqlWebEventProvider</b> to write to a local or remote SQL Server instance, use the Aspnet_regsql tool to configure the necessary database tables and roles as described in "Step 3. Configure Health Monitoring."<b></b></blockquote></li>
    </li>
  </ol>
  <h1>Problem Example</h1>
  <p>An e-commerce site with a two-tier web server/database model is built using file-based logging, and each machine keeps its logs on local disk.&amp;nbsp; When several of the web servers are compromised, the attackers wipe the logs and the owners are unable to determine how they got in.&amp;nbsp; The attacks re-occur several times because of this, before the hole is finally found and patched.</p>
  <h1>Solution Example</h1>
  <p>An e-commerce site with a two-tier web server/database model is built using remote logging server, with communication occuring over an encrypted channel.&amp;nbsp; When several of the web servers are compromised, the attackers are unable to break into the remote logging machine and cannot wipe the logs.&amp;nbsp; The owners find the whole quickly, thanks to the information in the log files, and the machines are patched immediately.</p>
  <pre>&lt;healthMonitoring heartbeatInterval="0" enabled="true"&gt;<br /> &lt;providers&gt;<br />    &lt;add connectionStringName="MySqlConnection"<br />       maxEventDetailsLength="1073741823"<br />       buffer="true"<br />       bufferMode="Extra Critical Notification"<br />        name="MySqlWebEventProvider"<br />        type="System.Web.Management.SqlWebEventProvider,System.Web,Version=2.0.0 .0,<br />&amp;#9;&amp;#9;Culture=neutral,PublicKeyToken=b03f5f7f11d50a3a" /&gt;<br />  &lt;/providers&gt;<br />&lt;/healthMonitoring&gt; </pre>
  <h1>Related Items</h1>
  <ul>
    <li>
      <a href="/article/8fb399eb-218c-4a50-9630-7dbf6d1ec088">Application Logs to a Separate Protected Server</a>
    </li>
  </ul>
  <hr />
  <p>Adapted from Microsoft patterns &amp; practices guidance. </p>