<h1>Applies to</h1>
  <ul>
    <li>PHP</li>
  </ul>
  <h1>What to Check For</h1>
  <p>Verify that unique tokens are included in HTTP requests in hidden fields.</p>
  <h1>Why</h1>
  <p>CSRF may be possible when an attacker can form a URL, which performs an action on the behalf of an authenticated user. Forming such URLs becomes much more difficult, if unique tokens are included in HTTP requests. Including difficult to predict token in HTTP requests is an effective defense against CSRF attacks.</p>
  <h1>How to Check</h1>
  <p>To verify that unique tokens are included in HTTP requests:</p>
  <ol>
    <li>
      <p>
        <strong>Identify sensitive operations.</strong> Review application design and code to identify all operations that require authorization.</p>
      <li>
        <p>
          <strong>Identify code that performs sensitive operations.</strong> Identify all pages that are involved in performing sensitive operations - this includes both the pages that link to sensitive operations and the code that actually carries out the sensitive operations.</p>
        <li>
          <p>
            <strong>Examine code that performs sensitive operations.</strong> Review each page that allows calling sensitive operations to make sure that it stores a unique token in a session variable. Review each page that allows calling sensitive operations to make sure that it sends the unique token with the request in a hidden field. Review each page that performs sensitive information to make sure that it validates the unique token.</p>
        </li>
      </li>
    </li>
  </ol>
  <h1>How to Fix</h1>
  <p>To include unique tokens in HTTP requests:</p>
  <ol>
    <li>
      <p>
        <strong>Identify sensitive operations.</strong> Review application design and code to identify all operations that require authorization.</p>
      <li>
        <p>
          <strong>Identify code that performs sensitive operations. </strong>Identify all pages that are involved in performing sensitive operations - this includes both the pages that link to sensitive operations and the code that actually carries out the sensitive operations.</p>
        <li>
          <p />
          <strong>Choose a method for generating unique tokens.</strong> There are different ways to generate unique tokens. One approach is to use the uniqid function combined with a hash based on current time. For example: <pre>uniqid(md5(microtime()), true);</pre><li><p /><strong>Add the unique token to the session.</strong> Add code that adds the generates unique tokens and stores them in session variables to the pages that link to sensitive operations. For example: <pre>session_start();<br />&amp;#36;_SESSION&amp;#91;'CSRFToken'&amp;#93; = uniqid(md5(microtime()), true);</pre><li><p /><strong>Add unique tokens to HTTP requests.</strong> Add code that sends the generated unique tokens in HTTP requests to the pages that link to sensitive operations. One of the simplest ways to do this is to include the tokens in hidden fields in forms. For example:<pre>&lt;input type="hidden" name="CSRFToken" value="&lt;?php echo &amp;#36;_SESSION&amp;#91;'CSRFToken'&amp;#93; ?&gt;" /&gt;</pre><li><p /><strong>Add token validation code.</strong> Add code to the pages that carry out sensitive operations that compares the tokens sent in HTTP requests to the tokens stored in session variables. Comparing the tokens in HTTP requests to tokens in session variables makes sure that the tokens are generated by the server as a part of normal application workflow and therefore the requested action is being performed by a legitimate user. The validation code should look something like the following:<pre>session_start();<p /><p>if (&amp;#36;_POST&amp;#91;'CSRFToken'&amp;#93; &amp;#33;== &amp;#36;_SESSION&amp;#91;'CSRFToken'&amp;#93;) &amp;#123;<br />&amp;nbsp; // The tokens don't match - possible CSRF detected<br />&amp;nbsp; die('Possible CSRF');<br />&amp;#125;<br />// Validation passed, so tokens match - perform the sensitive operation</p></pre></li></li></li></li>
      </li>
    </li>
  </ol>