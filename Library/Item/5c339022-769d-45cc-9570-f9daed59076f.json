{
  "TeamMentor_Article": {
    "$": {
      "Metadata_Hash": "260356441",
      "Content_Hash": "1467510804"
    },
    "Metadata": [
      {
        "Id": [
          "5c339022-769d-45cc-9570-f9daed59076f"
        ],
        "Library_Id": [
          "e7d92b5b-e1d8-4039-b019-8b02594ea93a"
        ],
        "Title": [
          "Use Unique Tokens in Requests"
        ],
        "Category": [
          "Session Management"
        ],
        "Phase": [
          "Implementation"
        ],
        "Technology": [
          "Technology Independent"
        ],
        "Type": [
          "Guideline"
        ],
        "DirectLink": [
          "Use Unique Tokens in Requests"
        ],
        "Tag": [
          ""
        ],
        "Security_Demand": [
          ""
        ],
        "Author": [
          ""
        ],
        "Priority": [
          ""
        ],
        "Status": [
          ""
        ]
      }
    ],
    "Content": [
      {
        "$": {
          "Sanitized": "true",
          "DataType": "Html"
        },
        "Data": [
          "<h2>What to Do</h2>\r\n  <p>Generate a unique nonce for each form, place the nonce into the form, and verify the nonce upon receipt of the form. Be sure that the nonce is not predictable (CWE-330).\r\n</p>\r\n  <p>\r\n    <strong>Note:</strong> Note that this can be bypassed using XSS (CWE-79).</p>\r\n  <h1>Why</h1>\r\n  <p>CSRF may be possible when an attacker can form a URL, which performs an action on the behalf of an authenticated user. Forming such URLs becomes much more difficult, if unique tokens are included in HTTP requests. Including difficult to predict token in\r\n HTTP requests is an effective defense against CSRF attacks.</p>\r\n  <h1>How</h1>\r\n  <p>To include unique tokens in HTTP requests:</p>\r\n  <ol>\r\n    <li>\r\n      <p>\r\n        <strong>Identify sensitive operations.</strong> Review application design and code to identify all operations that require authorization.</p>\r\n    </li>\r\n    <li>\r\n      <p>\r\n        <strong>Identify code that performs sensitive operations. </strong>Identify all pages that are involved in performing sensitive operations - this includes both the pages that link to sensitive operations and the code that actually carries out the sensitive\r\n operations.</p>\r\n    </li>\r\n    <li>\r\n      <p>\r\n        <strong>Choose a method for generating unique tokens.</strong> There are different ways to generate unique tokens. One approach is to use the uniqid function combined with a hash based on current time. For example:\r\n</p>\r\n      <pre>uniqid(md5(microtime()), true);</pre>\r\n    </li>\r\n    <li>\r\n      <p>\r\n        <strong>Add the unique token to the session.</strong> Add code that adds the generated unique tokens and stores them in session variables to the pages that link to sensitive operations. For example:\r\n</p>\r\n      <pre>session_start();<br />$_SESSION['CSRFToken'] = uniqid(md5(microtime()), true);</pre>\r\n    </li>\r\n    <li>\r\n      <p>\r\n        <strong>Add unique tokens to HTTP requests.</strong> Add code that sends the generated unique tokens in HTTP requests to the pages that link to sensitive operations. One of the simplest ways to do this is to include the tokens in hidden fields in forms.\r\n For example:</p>\r\n      <pre>&lt;input type=\"hidden\" name=\"CSRFToken\" value=\"&lt;?php echo $_SESSION['CSRFToken'] ?&gt;\" /&gt;</pre>\r\n    </li>\r\n    <li>\r\n      <p>\r\n        <strong>Add token validation code.</strong> Add code to the pages that carry out sensitive operations that compares the tokens sent in HTTP requests to the tokens stored in session variables. Comparing the tokens in HTTP requests to tokens in session variables\r\n makes sure that the tokens are generated by the server as a part of normal application workflow and therefore the requested action is being performed by a legitimate user. The validation code should look something like the following:</p>\r\n      <pre>session_start();<p /><p>if ($_POST['CSRFToken'] !== $_SESSION['CSRFToken']) {<br />  // The tokens don't match - possible CSRF detected<br />  die('Possible CSRF');<br />}<br />// Validation passed, so tokens match - perform the sensitive operation</p></pre>\r\n    </li>\r\n  </ol>\r\n  <h1>Additional Resources</h1>\r\n  <ul>\r\n    <li>For more information about \"CWE-330: Use of Insufficiently Random Values\", please see\r\n<a href=\"http://cwe.mitre.org/data/definitions/330.html\">http://cwe.mitre.org/data/definitions/330.html</a></li>\r\n    <li>For more information about \"CWE-79: Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')\", please see\r\n<a href=\"http://cwe.mitre.org/data/definitions/79.html\">http://cwe.mitre.org/data/definitions/79.html</a></li>\r\n  </ul>"
        ]
      }
    ]
  }
}