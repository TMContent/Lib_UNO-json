{
  "TeamMentor_Article": {
    "$": {
      "Metadata_Hash": "-1943845469",
      "Content_Hash": "-1217003690"
    },
    "Metadata": [
      {
        "Id": [
          "136a0a43-8e31-4228-9adc-7a05bf9db866"
        ],
        "Id_History": [
          "136a0a43-8e31-4228-9adc-7a05bf9db866,c50a33fc-75ca-4ec3-948b-c794161eb67e,"
        ],
        "Library_Id": [
          "be5273b1-d682-4361-99d9-6234f2d47eb7"
        ],
        "Title": [
          "[SINK] How to Use Role Manager in ASP.NET"
        ],
        "Category": [
          "Authorization"
        ],
        "Phase": [
          "Implementation"
        ],
        "Technology": [
          ".NET 3.5"
        ],
        "Type": [
          "How To"
        ],
        "DirectLink": [
          "How to Use Role Manager in ASP.NET"
        ],
        "Tag": [
          "ASP.NET,ASP.NET 3.5,ASP"
        ],
        "Security_Demand": [
          ""
        ],
        "Author": [
          ""
        ],
        "Priority": [
          ""
        ],
        "Status": [
          ""
        ],
        "Source": [
          "ASP.NET 3.5"
        ]
      }
    ],
    "Content": [
      {
        "$": {
          "Sanitized": "true",
          "DataType": "Html"
        },
        "Data": [
          "<h1>Applies to</h1>\r\n  <ul>\r\n    <li>Microsoft Windows Server 2003 operating system or later&nbsp;operating system<li>Microsoft Windows XP Professional Service Pack 1 or later operating system </li></li>\r\n  </ul>\r\n  <h1>Summary</h1>\r\n  <p>This How to shows you how to use the ASP.NET role manager. The role manager eases the task of managing roles and performing role-based authorization in your application. It shows how to configure the various role providers for use with your Web application, how to create new roles, how to add a user to a role, and how to use the role management API for roles-based authorization.</p>\r\n  <h1>Contents</h1>\r\n  <ul>\r\n    <li>\r\n      <div>Objectives</div>\r\n      <li>\r\n        <div>Overview</div>\r\n        <li>\r\n          <div>Summary of Steps</div>\r\n          <li>\r\n            <div>Step 1. Configure Your Role Store</div>\r\n            <li>\r\n              <div>Step 2. Configure Your Role Provider in Web.config</div>\r\n              <li>\r\n                <div>Step 3. Create and Assign Roles</div>\r\n                <li>\r\n                  <div>Step 4. Perform Role-Based Authorization</div>\r\n                  <li>\r\n                    <div>Additional Considerations</div>\r\n                    <li>\r\n                      <div>Additional Resources</div>\r\n                    </li>\r\n                  </li>\r\n                </li>\r\n              </li>\r\n            </li>\r\n          </li>\r\n        </li>\r\n      </li>\r\n    </li>\r\n  </ul>\r\n  <h1>Objectives</h1>\r\n  <ul>\r\n    <li>Configure an ASP.NET Web application to use role management. <li>Learn how to configure the <b>SqlRoleProvider</b>, <b>WindowsTokenRoleProvider</b>, and <b>AuthorizationStoreRoleProvider</b>. <li>Create and assign roles by using ASP.NET configuration tools, SQL scripts, and the role management APIs. <li>Perform role based authorization in an ASP.NET Web application. </li></li></li></li>\r\n  </ul>\r\n  <h1>Overview</h1>\r\n  <p>ASP.NET&nbsp;includes a role manager feature that includes a roles management API that allows you to create and delete roles and assign and remove users from roles. The role manager stores its data in an underlying data store that it accesses through an appropriate role provider for that data store.</p>\r\n  <p>The main benefits of using role manager are that it allows you to look up users' roles without writing and maintaining code. Additionally, the role providers offer a consistent way for you to check the role membership of your users, regardless of the underlying data store. Therefore, if your role store were to change tomorrow, you would only need to change the configuration settings to make your code work.</p>\r\n  <p>Supplied role providers include: </p>\r\n  <ul>\r\n    <li>\r\n      <b>SqlRoleProvider.</b> This is used where the role store is kept in SQL Server. <li><b>WindowsTokenRoleProvider.</b> This is a read-only provider that retrieves role information for a Windows user account based on the account's Windows security group membership. You cannot create, add to, or delete roles with this provider. <li><b>AuthorizationStoreRoleProvider.</b> This is used if your application uses Authorization Manager (AzMan). It uses an AzMan policy store in an XML file, in Active Directory, or in Active Directory Application Mode (ADAM) as its role store. It is typically used in an intranet or extranet scenario where Windows authentication and Active Directory is used for authentication. </li></li></li>\r\n  </ul>\r\n  <p>To perform role management, your ASP.NET application must be able to identify and authenticate its users in some way. For example, it might use Windows authentication or Forms authentication.</p>\r\n  <p>This How to shows you how to set up and configure a role store and a role provider and use role-based authorization in your ASP.NET applications. Additionally, it demonstrates some of the basic roles API calls available to work with roles programmatically.</p>\r\n  <h1>Summary of Steps</h1>\r\n  <p>To use the role manager in your application, perform the following steps: </p>\r\n  <ul>\r\n    <li>Step 1. Configure your role store. <li>Step 2. Configure your role provider in Web.config. <li>Step 3. Create and assign roles. <li>Step 4. Perform role-based authorization. </li></li></li></li>\r\n  </ul>\r\n  <h1>Step 1. Configure Your Role Store </h1>\r\n  <p>In this step, you prepare the role store used to maintain role details. The setup details vary according to the store and associated provider that you choose to use.</p>\r\n  <h2>Using SqlRoleProvider</h2>\r\n  <p>If you want to store roles in SQL Server, you use the <b>SqlRoleProvider</b>. By default, roles are stored in a database named Aspnetdb in a SQL Express database instance in the \\app_data folder beneath your application's virtual directory root folder. You can also configure the <b>SqlRoleProvider</b> to use a local or remote instance of SQL Server.</p>\r\n  <h3>To use a SQL Express database role store in the Website \\app_data folder</h3>\r\n  <p>You do not have to create or configure this database. The first time you perform an operation that uses the role management API, ASP.NET automatically creates a database named Aspnetdb, configures it, and sets appropriate permissions on it. </p>\r\n  <p>ASP.NET configures the SQL Express database with a database login for the default accounts used to run ASP.NET applications (Network Service on Windows Server 2003 or later&nbsp;and ASPNET on Windows 2000) and grants them full access to the Aspnetdb database. </p>\r\n  <p>If you have configured ASP.NET to run using a custom service account, you must create a SQL login for that account, and add the login to the <b>aspnet_Roles_FullAccess</b> role in the Aspnetdb database. </p>\r\n  <p>\r\n    <b>To install the role management database in SQL Server</b>\r\n  </p>\r\n  <ol>\r\n    <li>Log on to Windows using an account that has administration rights for your SQL Server instance. <li>Open a command prompt window and execute the following command to install the role management database. <p><b>Aspnet_regsql.exe</b>-<b>E</b>-<b>S</b><i>sqlinstance</i>-<b>A r</b></p><p>Note that this program is located in the <b>&#37;windir&#37;\\Microsoft.NET\\Framework\\&#123;version&#125;</b> folder. </p><p>When you type the command, replace <i>version</i> with the version of the .NET Framework that you are using and <i>sqlinstance</i> with the name of the SQL Server instance you want to install the role management database in. </p><p>You will see the following output: </p><div><pre>Start adding the following features:<br />Rolemanager<br />............<br />Finished.  </pre></div><blockquote><b>Note</b>&nbsp;&nbsp;&nbsp;For information about the switches for Aspnet_regsql.exe, type <b>Aspnet_regsql.exe -?</b> at the command prompt.</blockquote></li></li>\r\n  </ol>\r\n  <p>\r\n    <b>To grant permissions in the database</b>\r\n  </p>\r\n  <p>You need to create a database login for your Web application's process account; by default, this is the Network Service account. If you have configured a custom account to run ASP.NET, you must grant permissions to that account. </p>\r\n  <blockquote>\r\n    <b>Note</b>&nbsp;&nbsp;&nbsp;If you have configured your ASP.NET application to use impersonation, your ASP.NET application executes using the security context of the original caller. To access data in a SQL Server database, you must usually create a database login for the original caller and grant access to the required data.</blockquote>\r\n  <blockquote>However, the role management system accesses the Aspnetdb database by using the process identity regardless of whether your application uses impersonation. </blockquote>\r\n  <ol>\r\n    <li>Open SQL Server Enterprise Manager, expand <b>Security</b>, and then expand <b>Logins</b> for the server hosting the role management database. Create a new login for your Web application's process account (for example, <b>NT AUTHORITY/Network Service</b>). <li>Set the default database to <b>Aspnetdb</b>. <li>Under the <b>Databases</b> node in Enterprise Manager, expand the <b>Aspnetdb</b> database entry, and then click <b>Roles</b>. Right-click <b>aspnet_Roles_FullAccess</b>, and then click <b>Properties</b>. In the <b>Database Role Properties</b> dialog box, click <b>Add</b>, and then select the database login you created in the previous step to add the login to that role. <blockquote><b>Note</b>&nbsp;&nbsp;&nbsp;Aspnet_regsql.exe creates three database roles with differing levels of access to the role management database: </blockquote><ul><li><b>FullAccess</b> gives rights to create and delete roles, and add and remove users from those roles. <li><b>BasicAccess</b> allows role membership checks for the current user only. <li><b>ReportingAccess</b> allows a page to check which roles exist and which users belong to them. </li></li></li></ul></li></li></li>\r\n  </ol>\r\n  <h2>Using WindowsTokenRoleProvider</h2>\r\n  <p>You use the <b>WindowsTokenRoleProvider</b> with ASP.NET applications that use Windows authentication. It is a read-only provider that retrieves role information for a Windows user based on Windows security groups. You cannot create, add to, or delete roles with this provider. Instead, you must use the Windows Computer Management or Active Directory Users and Computers administration tools.</p>\r\n  <p>The Windows security system acts as role store for this provider, so no additional configuration is required to set up the role store.</p>\r\n  <h2>Using AuthorizationStoreRoleProvider</h2>\r\n  <p>Use the <b>AuthorizationStoreRoleProvider</b> to store roles data in an AzMan policy store in an XML file, in Active Directory, or ADAM. </p>\r\n  <p>AzMan is supported on Windows 2000 Server or later and on Windows XP Professional.&nbsp; </p>\r\n  <h1>Step 2. Configure Your Role Provider in Web.config</h1>\r\n  <p>In this step, you configure the appropriate role provider in your application's Web.config file.</p>\r\n  <h2>Using SqlRoleProvider</h2>\r\n  <p>To use the role store in the default SQL Express instance in a database in your Web site's \\app_dir folder, add the following configuration to your application's Web.config file.</p>\r\n  <div>\r\n    <pre>&lt;system.web&gt;<br />&nbsp;&nbsp;&nbsp; &lt;roleManager enabled=\"true\" /&gt;<br />&lt;/system.web&gt;  </pre>\r\n  </div>\r\n  <p>This configuration enables role management and causes your application to use the default provider named <b>AspNetSqlRoleProvider</b> defined in the Machine.config file. This uses the local SQL Express instance.</p>\r\n  <p>To use a role store in SQL Server, add a connection string to point to your role database and add a role provider definition in the Web.config file, as shown here.</p>\r\n  <div>\r\n    <pre>&lt;configuration&gt;<br />&nbsp; &lt;connectionStrings&gt;<br />&nbsp;&nbsp;&nbsp; &lt;add name=\"SqlRoleManagerConnection\" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connectionString=\"Data Source=sqlinstance;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Initial Catalog=aspnetdb;Integrated Security=SSPI;\"&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/add&gt;<br />&nbsp; &lt;/connectionStrings&gt;<br />&lt;/configuration&gt;</pre>\r\n  </div>\r\n  <pre>&lt;roleManager enabled=\"true\" defaultProvider=\"SqlRoleManager\"&gt;<br />&nbsp; &lt;providers&gt;<br />&nbsp;&nbsp;&nbsp; &lt;add name=\"SqlRoleManager\" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type=\"System.Web.Security.SqlRoleProvider\"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connectionStringName=\"SqlRoleManagerConnection\"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; applicationName=\"MyApplication\" /&gt;<br />&nbsp; &lt;/providers&gt;<br />&lt;/roleManager&gt;</pre>\r\n  <h2>Using WindowsTokenRoleProvider</h2>\r\n  <p>The Windows security system acts as role store for this provider, and Windows groups represent roles. You can use this provider when you use Windows authentication. To do this, add the following configuration to your application's Web.config file.</p>\r\n  <div>\r\n    <pre>&lt;authentication mode=\"Windows\" /&gt;<br />&lt;roleManager enabled=\"true\" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; defaultProvider=\"AspNetWindowsTokenRoleProvider\" /&gt;  </pre>\r\n  </div>\r\n  <p>This configuration enables role management and uses the role provider named <b>AspNetWindowsTokenRoleProvider</b>, which is defined in the Machine.config file.</p>\r\n  <h2>Using AuthorizationStoreRoleProvider</h2>\r\n  <p>The <b>AuthorizationStoreRoleProvider</b> is used to store roles data in an AzMan policy store in an XML file, in Active Directory, or in ADAM. To configure this provider, add a connection string to point to the relevant policy store and then add a role provider definition in the Web.config file.</p>\r\n  <p>The following connection string refers to an XML-based policy store contained in a file named Azmanstore.xml.</p>\r\n  <div>\r\n    <pre>&lt;configuration&gt; <br />&nbsp; &lt;connectionStrings&gt; <br />&nbsp;&nbsp;&nbsp; &lt;add name=\"AzManPolicyStoreConnectionString\" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connectionString=\"msxml://c:/RolesData/azmanstore.xml\" /&gt;<br />&nbsp; &lt;/connectionStrings&gt; <br />&lt;/configuration&gt;  </pre>\r\n  </div>\r\n  <p>The following connection string refers to an ADAM-based policy store.</p>\r\n  <div>\r\n    <pre>&lt;configuration&gt; <br />&nbsp; &lt;connectionStrings&gt; <br />&nbsp;&nbsp;&nbsp; &lt;add name=\"AzManPolicyStoreConnectionString\" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connectionString= \"msldap://servername:port/CN=AzManADAMStore,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OU=SecNetPartition,O=SecNet,C=US\"/&gt;<br />&nbsp; &lt;/connectionStrings&gt; <br />&lt;/configuration&gt;  </pre>\r\n  </div>\r\n  <p>The following configuration shows how to enable role management and use the provider named <b>RoleManagerAzManADAMProvider</b>. This uses the connection string shown earlier to connect to an ADAM policy store.</p>\r\n  <div>\r\n    <pre>&lt;roleManager <br />&nbsp;&nbsp;&nbsp; enabled=\"true\" <br />&nbsp;&nbsp;&nbsp; cacheRolesInCookie=\"true\" <br />&nbsp;&nbsp;&nbsp; defaultProvider=\"RoleManagerAzManADAMProvider\"<br />&nbsp;&nbsp;&nbsp; cookieName=\".ASPXROLES\" <br />&nbsp;&nbsp;&nbsp; cookiePath=\"/\" <br />&nbsp;&nbsp;&nbsp; cookieTimeout=\"30\" <br />&nbsp;&nbsp;&nbsp; cookieRequireSSL=\"false\" <br />&nbsp;&nbsp;&nbsp; cookieSlidingExpiration=\"true\"<br />&nbsp;&nbsp;&nbsp; createPersistentCookie=\"false\" <br />&nbsp;&nbsp;&nbsp; cookieProtection=\"All\"&gt;<br />&nbsp;&nbsp;&nbsp; &lt;providers&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;add name=\"RoleManagerAzManADAMProvider\"<br />&nbsp;&nbsp;&nbsp;&nbsp; type=\"System.Web.Security.AuthorizationStoreRoleProvider, System.Web,<br />&#9;&#9; Version=3.5.0.0, Culture=neutral, publicKeyToken=b03f5f7f11d50a3a\"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connectionStringName=\"AzManPolicyStoreConnectionString\" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; applicationName=\"AzManDemo\"/&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/providers&gt;<br />&lt;/roleManager&gt;  </pre>\r\n  </div>\r\n  <h1>Step 3. Create and Assign Roles</h1>\r\n  <p>In this step, you create roles for your application and assign users to those roles. There are several methods you can use to create and assign roles. Using them depends on how your application authenticates its users and which role provider it uses. The various methods for creating and assigning users to roles include: </p>\r\n  <ul>\r\n    <li>At development time, you can use the ASP.NET configuration tool. <li>If you are using the <b>AuthorizationStoreRoleProvider</b>, you can use the AzMan administrator Microsoft Management Console (MMC) snap-in. <li>You can create roles programmatically by using either the role management APIs or, if you are using the <b>SqlRoleProvider</b>, by executing SQL scripts to add them to the database directly. <li>If you are using the <b>WindowsTokenRoleProvider</b>, you use the Windows Computer Management tool or Active Directory Users and Computers to create Windows groups which are used as roles. </li></li></li></li>\r\n  </ul>\r\n  <h2>Using the ASP.NET Web Site Configuration Tool</h2>\r\n  <p>You can use the ASP.NET Web Site Configuration tool from Visual Studio .NET at development time if your application uses Forms authentication and you have configured your application to use the ASP.NET membership feature. If your application uses Windows authentication, you cannot use this tool and you must use either the Roles API or the AzMan administrator MMC snap-in as described in the next section. </p>\r\n  <h3>To assign users to roles by using the ASP.NET Web Site Configuration tool </h3>\r\n  <ol>\r\n    <li>Create roles by using the ASP.NET configuration tool by performing the following steps: <ol><li>Start Visual Studio. <li>On the <b>Website</b> menu, click <b>ASP.NET Configuration</b>. <li>On the <b>Home</b> tab, click <b>Security</b>. <li>Click <b>Create or</b><b>Manage Roles</b>. <li>Use the form to add your application roles. </li></li></li></li></li></ol><li>Assign users to roles as follows: <ol><li>In Visual Studio .NET, click <b>ASP.NET Configuration </b>on the <b>Website</b> menu. <li>On the <b>Home</b> tab, click <b>Security</b>. <li>Click <b>Create or</b><b>Manage Roles</b>. <li>In the <b>Add/Remove Users</b> column, click <b>Manage</b> for a role you have created. This opens a form where you can add or remove users from the role. </li></li></li></li></ol></li></li>\r\n  </ol>\r\n  <h2>Using the AzMan Administrator MMC Snap-In</h2>\r\n  <p>This tool is provided for applications that use an AzMan store to manage its users and roles. It is particularly convenient for applications using Windows authentication that cannot use the ASP.NET configuration tool to assign users to roles. </p>\r\n  <h2>Using SQL Scripts</h2>\r\n  <p>If you have suitable permissions on the role management database, you can run a SQL script to call the various stored procedures provided with the Aspnetdb database. For example, the following script creates a new role in an application and adds a user to it.</p>\r\n  <div>\r\n    <pre>EXEC aspnet_Roles_CreateRole 'ThisApplication', 'NewRole'<br />EXEC aspnet_UsersInRoles_AddUsersToRoles 'ThisApplication', 'ThisUser', 'NewRole', 8  </pre>\r\n  </div>\r\n  <p>There are 19 role-managing stored procedures created inside the role management database. Most of these stored procedures have purposes analogous to calls in the role management API. </p>\r\n  <h2>Using the Role Management APIs</h2>\r\n  <p>You can assign users to roles or remove users from roles by using methods of the <b>System.Web.Security.Roles</b> class. You can also check for the user's role membership and authorize as appropriate.</p>\r\n  <blockquote>\r\n    <b>Note</b>&nbsp;&nbsp;&nbsp;Because the <b>WindowsTokenRoleProvider</b> is read-only, it supports only the <b>IsUserInRole</b> and <b>GetRolesForUser </b>methods.<b></b></blockquote>\r\n  <p>The following code shows how to create new roles.</p>\r\n  <div>\r\n    <pre>using System.Web.Security;</pre>\r\n    <pre>if (&#33;Roles.RoleExists(\"TestRole\"))<br />&#123;<br />&nbsp; Roles.CreateRole(\"TestRole\");<br />&#125;  </pre>\r\n  </div>\r\n  <blockquote>\r\n    <b>Note</b>&nbsp;&nbsp;&nbsp;Role names are not case sensitive. If you attempt to create the same role twice, an exception is thrown.</blockquote>\r\n  <p>The following code shows how to add uses to roles.</p>\r\n  <div>\r\n    <pre>// Example 1 - Add one user to one role<br />Roles.AddUserToRole(\"TestOne\", \"ExampleRole1\");</pre>\r\n    <pre>// Example 2 - Add one user to several roles<br />Roles.AddUserToRoles(\"TestTwo\", <br />&nbsp; new string&#91;&#93; &#123; \"ExampleRole1\", \"ExampleRole2\" &#125;);</pre>\r\n    <pre>// Example 3 - Add several users to one roles<br />Roles.AddUsersToRole(<br />&nbsp; new string&#91;&#93; &#123; \"TestTwo\", \"TestThree\" &#125;, \"ExampleRole3\");</pre>\r\n    <pre>// Example 4 - Add several users to several roles<br />Roles.AddUsersToRoles(<br />&nbsp; new string&#91;&#93; &#123; \"TestThree\", \"TestFour\" &#125;, <br />&nbsp; new string&#91;&#93; &#123; \"ExampleRole4\" &#125;); </pre>\r\n  </div>\r\n  <p>The following code shows how to remove users from roles.</p>\r\n  <div>\r\n    <pre>// Example 1 - Add one user to one role<br />Roles.RemoveUserFromRole(\"TestOne\", \"ExampleRole1\");</pre>\r\n    <pre>// Example 2 - Add one user to several roles<br />Roles.RemoveUserFromRoles(\"TestTwo\", <br />&nbsp; new string&#91;&#93; &#123; \"ExampleRole1\", \"ExampleRole2\" &#125;);</pre>\r\n    <pre>// Example 3 - Add several users to one roles<br />Roles.RemoveUsersFromRole(<br />&nbsp; new string&#91;&#93; &#123; \"TestTwo\", \"TestThree\" &#125;, \"ExampleRole3\");</pre>\r\n    <pre>// Example 4 - Add several users to several roles<br />Roles.RemoveUsersFromRoles(<br />&nbsp; new string&#91;&#93; &#123; \"TestThree\", \"TestFour\" &#125;, <br />&nbsp; new string&#91;&#93; &#123; \"ExampleRole4\" &#125;); </pre>\r\n  </div>\r\n  <blockquote>\r\n    <b>Note</b>&nbsp;&nbsp;&nbsp;Both the <b>AddUser</b> and <b>RemoveUser</b> methods throw a <b>TargetInvocationException</b> if you specify a role that does not exist or if you specify an invalid Windows user account name. The inner exception gives the reason for the failure. None of the methods mentioned earlier can be used against a <b>WindowsTokenRoleProvider</b>.</blockquote>\r\n  <h1>Step 4. Perform Role-Based Authorization </h1>\r\n  <p>In this step, you create test applications that use role management. This step provides two samples: </p>\r\n  <ul>\r\n    <li>The first sample uses the <b>SqlRoleProvider</b> or <b>AuthorizationStoreRoleProvider</b>, in which the application assigns a role to a user, removes a role from a user, and tests for role membership. <li>The second sample uses the <b>WindowsTokenRoleProvider</b> to check which Windows groups (roles) the current user is a member of. The <b>WindowsTokenRoleProvider</b> supports only the<b> IsUserInRole </b>and <b>GetRolesForUser </b>methods of the role management API, and it does not allow you to create, assign to, or remove users from Windows groups. </li></li>\r\n  </ul>\r\n  <p>Both of these sample applications use Integrated Windows authentication in Microsoft Internet Information Services (IIS) to authenticate callers. This is a requirement when using the <b>WindowsTokenRoleProvider</b>, but if you are using the <b>SqlRoleProvider</b> or <b>AuthorizationStoreRoleProvider</b>, you could use alternative authentication such as forms authentication.</p>\r\n  <h2>Sample: Using SqlRoleProvider or AuthorizationStoreRoleProvider</h2>\r\n  <p>This sample uses the <b>SqlRoleProvider</b> or <b>AuthorizationStoreRoleProvider</b>.</p>\r\n  <h3>To test role management with SqlRoleProvider or AuthorizationStoreRoleProvider </h3>\r\n  <ol>\r\n    <li>Use Visual Studio to create a Web site, add a Web.config file, and configure the role store and <b>SqlRoleProvider</b> or <b>AuthorizationStoreRoleProvider</b> as described in steps 1 and 2 of this How to. <li>Using the Internet Information Services MMC snap-in, edit the properties of the Web site. Edit the <b>Anonymous access and authentication control</b> on the <b>Directory</b><b>security</b> tab. Clear the <b>Anonymous access</b> check box and select the <b>Integrated Windows authentication</b> check box. <li>In the Web.config file, enable Windows authentication. <div><pre>&lt;system.web&gt;<br />&nbsp;&nbsp;&nbsp; ...<br />&nbsp;&nbsp;&nbsp; &lt;authentication mode=\"Windows\"/&gt;<br />&nbsp;&nbsp;&nbsp; ...<br />&lt;/system.web&gt;  </pre></div><li>Add the following code to the Default.aspx file. <div><pre>&lt;&#37;&#64; Page Language=\"C#\" &#37;&gt;<br />&lt;&#33;DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.1//EN\" \"<a href=\"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd\">http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd</a>\"&gt;<br />&lt;script runat=\"server\"&gt;<br />&nbsp;&nbsp;&nbsp; protected void Page_Load(object sender, EventArgs e)<br />&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (&#33;Roles.RoleExists(\"TestRole\"))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Roles.CreateRole(\"TestRole\");<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ShowRoleMembership();<br />&nbsp;&nbsp;&nbsp; &#125;<br />&nbsp;&nbsp;&nbsp; private void ShowRoleMembership()<br />&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (Roles.IsUserInRole(\"TestRole\"))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Label1.Text = User.Identity.Name &#43; \" is in role TestRole\";<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Label1.Text = User.Identity.Name &#43; \" is NOT in role TestRole\";<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;<br />&nbsp;&nbsp;&nbsp; &#125;<br />&nbsp;&nbsp;&nbsp; protected void Button1_Click(object sender, EventArgs e)<br />&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Roles.AddUserToRole(User.Identity.Name, \"TestRole\");<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ShowRoleMembership();<br />&nbsp;&nbsp;&nbsp; &#125;<br />&nbsp;&nbsp;&nbsp; protected void Button2_Click(object sender, EventArgs e)<br />&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Roles.RemoveUserFromRole(User.Identity.Name, \"TestRole\");<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ShowRoleMembership();<br />&nbsp;&nbsp;&nbsp; &#125;<br />&lt;/script&gt;<br />&lt;html&nbsp; &gt;<br />&lt;head runat=\"server\"&gt;<br />&nbsp;&nbsp;&nbsp; &lt;title&gt;Untitled Page&lt;/title&gt;<br />&lt;/head&gt;<br />&lt;body&gt;<br />&nbsp;&nbsp;&nbsp; &lt;form id=\"form1\" runat=\"server\"&gt;<br />&nbsp;&nbsp;&nbsp; &lt;div&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;asp:Button ID=\"Button1\" runat=\"server\" Text=\"Add to role\" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnClick=\"Button1_Click\" /&gt;&lt;br /&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;br /&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;asp:Button ID=\"Button2\" runat=\"server\" Text=\"Remove from role\" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnClick=\"Button2_Click\" /&gt;&lt;br /&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;br /&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;asp:Label ID=\"Label1\" runat=\"server\" /&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/div&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/form&gt;<br />&lt;/body&gt;<br />&lt;/html  </pre></div><li>Run the application. Note the following features about this application: <ol><li>When you browse to the application, the code in the <b>Page_Load</b> event handler creates the role <b>TestRole</b> if it does not already exist. <ul><li>The text of <b>Label1</b> shows whether the current authenticated user is a member of the <b>TestRole</b> role. <li>When you click the <b>Add to role</b> button, the code in the <b>Button1_Click</b> event handler uses the role management API to add the current authenticated user to the <b>TestRole</b> role. <li>If you click the <b>Add to role</b> button again before clicking the <b>Remove from role</b> button, the call to <b>Roles.AddUserToRole</b> throws an exception because the user is already in the role <b>TestUser</b>. You must code for this condition in your applications. <li>When you click the <b>Remove from role</b> button, the current authenticated user is removed from the role <b>TestRole</b>. <li>If you click the <b>Remove from role</b> button again before clicking the <b>Add to role</b> button, the call to <b>Roles.RemoveUserFromRole</b> throws an exception because the user is already not in the role <b>TestUser</b> and cannot be removed twice. You must code for this condition in your applications. </li></li></li></li></li></ul></li></ol></li></li></li></li></li>\r\n  </ol>\r\n  <p>\r\n    <b>To control access to pages and folders using roles</b>\r\n  </p>\r\n  <p>A typical use for roles is to establish rules that allow or deny access to pages or folders. You can set up such access rules in the &lt;<b>authorization</b>&gt; section of the Web.config file. The following example allows users in the role of members to view pages in the folder named <b>memberPages</b> and denies access to anyone else.</p>\r\n  <div>\r\n    <pre>&lt;configuration&gt;<br />&nbsp;&nbsp; &lt;location path=\"memberPages\"&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;system.web&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;authorization&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;allow roles=\"Manager\" /&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;deny users=\"&#42;\" /&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/authorization&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/system.web&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/location&gt;<br />&nbsp;&nbsp; &lt;&#33;-- other configuration settings here --&gt;<br />&lt;configuration&gt;  </pre>\r\n  </div>\r\n  <h2>Sample: Using WindowsTokenRoleProvider</h2>\r\n  <p>This sample uses the <b>WindowsTokenRoleProvider</b>.</p>\r\n  <h3>To test role management with WindowsTokenRoleProvider </h3>\r\n  <ol>\r\n    <li>Use Visual Studio&nbsp;to create a Web site, add a Web.config file, and configure the <b>WindowsTokenRoleProvider</b> as described in step 2 of this How to. <li>Using the Internet Information Services MMC snap-in, edit the properties of the Web site. Edit the <b>Anonymous access and authentication control</b> on the <b>Directory security</b> tab. Clear the <b>Anonymous access</b> check box and select the <b>Integrated Windows Authentication</b> check box. <li>In the Web.config file, enable Windows authentication. <div><pre>&lt;system.web&gt;<br />&nbsp;&nbsp;&nbsp; ...<br />&nbsp;&nbsp;&nbsp; &lt;authentication mode=\"Windows\"/&gt;<br />&nbsp;&nbsp;&nbsp; ...<br />&lt;/system.web&gt;  </pre></div><li>Add the following code to Default.aspx. <div><div><div></div></div><pre>&lt;&#37;&#64; Page Language=\"C#\" &#37;&gt;<br />&lt;&#33;DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.1//EN\" \"<a href=\"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd\">http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd</a>\"&gt;<br />&lt;script runat=\"server\"&gt;<br />&nbsp;&nbsp;&nbsp; protected void Page_Load(object sender, EventArgs e)<br />&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string&#91;&#93; members = Roles.GetRolesForUser();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (string role in members)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Label1.Text &#43;= role &#43; \"&lt;br /&gt;\";<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp; &#125; <br />&lt;/script&gt;<br />&lt;html&nbsp; &gt;<br />&lt;head runat=\"server\"&gt;<br />&nbsp;&nbsp;&nbsp; &lt;title&gt;Untitled Page&lt;/title&gt;<br />&lt;/head&gt;<br />&lt;body&gt;<br />&nbsp;&nbsp;&nbsp; &lt;form id=\"form1\" runat=\"server\"&gt;<br />&nbsp;&nbsp;&nbsp; &lt;div&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;asp:Label ID=\"Label1\" runat=\"server\" /&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/div&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/form&gt;<br />&lt;/body&gt;<br />&lt;/html&gt;  </pre></div><li>Run the application. A list of roles that correspond to the Windows groups that the authenticated user is a member of is displayed. Note the following features about this application: <ol><li>Because <b>WindowsTokenRoleProvider</b> is read-only, you cannot create, assign to, or remove users from roles. The <b>WindowsTokenRoleProvider</b> supports only the <b>IsUserInRole </b>and <b>GetRolesForUser</b> methods of the role management API. </li></ol></li></li></li></li></li>\r\n  </ol>\r\n  <ul>\r\n    <li>The text of <b>Label1</b> shows which Windows groups the currently logged on user is a member of. <li>The <b>WindowsPrincipal </b>class supports an override of the <b>IsInRole</b> method that accepts a <b>WindowsBuiltinRole</b> enumeration. This method allows you to test against membership of common Windows groups. The <b>WindowsBuiltInRole</b> enumeration contains members representing common groups such as Administrators, Guest, PowerUser, and User as shown here. <div><div><div></div><div>&nbsp;</div></div><pre>WindowsPrincipal User = new <br />&nbsp; WindowsPrincipal((WindowsIdentity)HttpContext.Current.User.Identity);<br />if (User.IsInRole(WindowsBuiltInRole.PowerUser))<br />&#123;<br />&nbsp; ...<br />&#125;  </pre></div></li></li>\r\n  </ul>\r\n  <p>\r\n    <b>To control access to pages and folders using built-in roles with the WindowsTokenRoleProvider</b>\r\n  </p>\r\n  <p>You can control access to pages or folders to members of one of the built-in Windows groups by specifying the role in the format <b>BUILTIN\\<i>groupName</i></b>. The following example allows users in the built-in administrators group to view pages in the folder named memberPages and denies access to anyone else.</p>\r\n  <div>\r\n    <pre>&lt;configuration&gt;<br />&nbsp;&nbsp; &lt;location path=\"memberPages\"&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;system.web&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;authorization&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;allow roles=\"BUILTIN\\Administrators\" /&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;deny users=\"&#42;\" /&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/authorization&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/system.web&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/location&gt;<br />&nbsp;&nbsp; &lt;&#33;-- other configuration settings here --&gt;<br />&lt;/configuration  </pre>\r\n  </div>\r\n  <h1>Additional Considerations</h1>\r\n  <p>If a user's browser accepts cookies, you can store role information for that user in a cookie on the user's computer. On each page request, ASP.NET reads the role information for that user from the cookie. This can improve application performance by reducing the amount of communication required with the roles data store. </p>\r\n  <p>To configure and enable role caching, set <b>cacheRolesInCookie = true</b> as shown here.</p>\r\n  <div>\r\n    <pre>&lt;roleManager enabled=\"true\" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cacheRolesInCookie=\"true\" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cookieName=\".ASPXROLES\"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cookieTimeout=\"30\" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cookiePath=\"/\" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cookieRequireSSL=\"false\" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cookieSlidingExpiration=\"true\"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cookieProtection=\"All\" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; defaultProvider=\"AspNetSqlRoleProvider\"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; createPersistentCookie=\"false\" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; maxCachedResults=\"25\"/&gt;  </pre>\r\n  </div>\r\n  <p>If the role information for a user is too long to store in a cookie, ASP.NET stores only the most recently used role information in the cookie, and then it looks up additional role information in the data source as required. </p>\r\n  <p>To secure the role cookie: </p>\r\n  <ul>\r\n    <li>Set <b>cookieRequireSSL</b> to <b>true</b> to ensure the cookie is only used over an SSL protected channel. <li>Set <b>createPersistentCookie</b> to <b>false</b> to prevent the cookie from being stored on the client computer, in which case the cookie is only used to protect the current session. <li>Set <b>cookieTimeout</b> to the number of minutes for which the cookie is valid.</li></li></li>\r\n  </ul>\r\n  <hr />\r\n  <p>Adapted from Microsoft patterns & practices guidance.</p>"
        ]
      }
    ]
  }
}