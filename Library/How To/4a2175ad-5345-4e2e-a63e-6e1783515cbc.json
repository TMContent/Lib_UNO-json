{
  "TeamMentor_Article": {
    "$": {
      "Metadata_Hash": "641133342",
      "Content_Hash": "1453415208"
    },
    "Metadata": [
      {
        "Id": [
          "4a2175ad-5345-4e2e-a63e-6e1783515cbc"
        ],
        "Id_History": [
          "4a2175ad-5345-4e2e-a63e-6e1783515cbc,0b6a3b05-c978-47ee-a520-e9ba7af02dd0,"
        ],
        "Library_Id": [
          "be5273b1-d682-4361-99d9-6234f2d47eb7"
        ],
        "Title": [
          "How To Instrument ASP.NET Applications for Security"
        ],
        "Category": [
          "Hardening"
        ],
        "Phase": [
          "Implementation"
        ],
        "Technology": [
          ".NET 3.5"
        ],
        "Type": [
          "How To"
        ],
        "DirectLink": [
          "How To Instrument ASP.NET Applications for Security"
        ],
        "Tag": [
          "ASP.NET,ASP.NET 3.5,ASP"
        ],
        "Security_Demand": [
          ""
        ],
        "Author": [
          ""
        ],
        "Priority": [
          ""
        ],
        "Status": [
          ""
        ],
        "Source": [
          "SI"
        ]
      }
    ],
    "Content": [
      {
        "$": {
          "Sanitized": "true",
          "DataType": "Html"
        },
        "Data": [
          "<h1>Summary</h1>\r\n  <p>This How To shows you how to use custom health monitoring events to instrument your ASP.NET application to track security-related events and operations. ASP.NET provides health monitoring that includes instrumentation for many standard security-related and infrastructure events common to all ASP.NET applications. If you want to track additional security-related activity not covered by the standard events, or if you want to report on application-specific events, you need to create and raise custom events. This How To includes three samples that show how to build custom events that you can use to track password change events, user account lockout, and access to sensitive business logic.</p>\r\n  <h1>Contents</h1>\r\n  <ul>\r\n    <li>Objectives <li>Overview <li>Platform Default Security Events <li>Additional Custom Security Events <li>Sample: Password Change Event <li>Sample: Membership Account Locked Event <li>Sample: Access Sensitive Method Event </li></li></li></li></li></li></li>\r\n  </ul>\r\n  <h1>Objectives</h1>\r\n  <ul>\r\n    <li>Identify the security related events that are raised automatically. <li>Learn about additional security related events you might want to track. <li>Raise custom events to track specific security related activity. <li>Instrument your code to detect password changes. <li>Instrument your code to detect when the membership system locks out an account. <li>Instrument your code to track access to sensitive business logic. </li></li></li></li></li></li>\r\n  </ul>\r\n  <h1>Overview</h1>\r\n  <p>To react promptly to security incidents or infrastructure and application failures, you need to instrument and monitor your ASP.NET applications. ASP.NET runtime components and controls are instrumented for health monitoring and they raise events for many common situations. This includes login failures and successes when using the ASP.NET membership system, attempts to tamper with or reuse forms authentication tickets, and infrastructure issues such as disk access failures. By default, the ASP.NET health monitoring system is configured to report all security-related error events, and all infrastructure-related error events, to the Windows event log.</p>\r\n  <p>When planning the instrumentation of an ASP.NET application, you should start by deciding the standard ASP.NET events that you want to report, where you want to report them, and how you want to monitor them. ASP.NET includes event logging providers to write to the following locations:</p>\r\n  <ul>\r\n    <li>Windows event log <li>SQL Server database <li>E-mail recipient <li>Windows Management Instrumentation (WMI) </li></li></li></li>\r\n  </ul>\r\n  <p>You can also create your own custom event providers. You can use standard monitoring tools and products such as Microsoft Operations Manager (MOM) to monitor events.</p>\r\n  <h2>Event Class Hierarchy</h2>\r\n  <p>The class hierarchy of the standard events is shown in Figure 1, together with the major event code associated with each event. Some events also log a detail code as well as a major code, but these are not shown in Figure 1. For more information about the standard event codes, see <a onclick=\"javascript:Track('ctl00_LibFrame_ctl01&#124;ctl00_LibFrame_ctl04',this);\" href=\"http://msdn.microsoft.com/en-us/library/system.web.management.webeventcodes_members.aspx\">WebEventCodes Class</a> of the .NET Framework Class Library on MSDN.</p>\r\n  <p>\r\n    <img alt=\"\" src=\"http://msdn2.microsoft.com/en-us/library/ms998325.f01paght00001601(en-us,MSDN.10).gif\" border=\"0\" />\r\n  </p>\r\n  <p>\r\n    <b>Figure 1. Class hierarchy of the standard event classes with major event codes</b>\r\n  </p>\r\n  <p>By default, ASP.NET health monitoring is configured to log to the Windows event log all events of type <b>WebFailureAuditEvent</b> (including its descendants, <b>WebAuthenticationFailureAuditEvent</b> and <b>WebViewStateFailureAuditEvent</b>) and all events of type <b>WebBaseErrorEvent </b>(and its descendants, <b>WebErrorEvent</b> and <b>WebRequestErrorEvent</b>). These classes are shown highlighted in Figure 1. </p>\r\n  <p>You can configure health monitoring to log a different set of events. You can select specific event codes by specifying a range of codes to log, and you can log to different event sinks through different event providers. </p>\r\n  <h1>Platform Default Security Events</h1>\r\n  <p>ASP.NET supports many events that you can use to monitor the health of your application. The most critical of these are those of type <b>WebErrorEvent</b> and <b>WebFailureAuditEvent</b> (including its descendants, <b>WebAuthenticationFailureAuditEvent</b> and <b>WebViewStateFailureAuditEvent</b>), which are logged by default, while others may be added to aid investigation in the case of an attack.</p>\r\n  <h2>Platform Default Security Events Logged By Default</h2>\r\n  <p>The following events are logged to the Windows event log by default.</p>\r\n  <h3>Forms Authentication Events</h3>\r\n  <p>The following major event codes are logged for events of type <b>WebAuthenticationFailureAuditEvent</b>. </p>\r\n  <ul>\r\n    <li>\r\n      <b>AuditFormsAuthenticationFailure</b> (code 4005). This is used to identify brute force or dictionary attacks when using forms authentication classes. This code may also be accompanied by one of the following detail codes: <ul><li><b>ExpiredTicketFailure</b>. This is used to identify cookie replay attacks. <li><b>InvalidTicketFailure</b>. This is used to identify authentication cookie tampering. </li></li></ul><li><b>AuditMembershipAuthenticationFailure</b> (code 4006). This is used to identify brute force or dictionary attacks when using the membership feature. </li></li>\r\n  </ul>\r\n  <h3>Invalid ViewState Events</h3>\r\n  <p>The following major event code is logged for exceptions of type <b>WebViewStateFailureAuditEvent</b>: </p>\r\n  <ul>\r\n    <li>\r\n      <b>AuditInvalidViewStateFailure</b> (code 4009). This is used to identify tampering with ViewState. </li>\r\n  </ul>\r\n  <h3>Authorization Events</h3>\r\n  <p>The following major event codes are logged for events of type <b>WebFailureAuditEvent</b>, which are associated with authorization failures: </p>\r\n  <ul>\r\n    <li>\r\n      <b>AuditFileAuthorizationFailure</b> (code 4008). This is used to identify attempts to access unauthorized files or folders. <li><b>AuditUnhandledAccessException</b> (code 4011). This is used to identify attempts of unauthorized access to resource. <li><b>AuditUnhandledSecurityException</b> (code 4010). This is used to identify attempts to perform actions not allowed by the current trust level. <li><b>AuditUrlAuthorizationFailure</b> (code 4007). This is used to identify attempts to access an unauthorized path or page. </li></li></li></li>\r\n  </ul>\r\n  <h3>Application Failure Events</h3>\r\n  <p>The following major event codes are logged for exceptions of type <b>WebErrorEvent</b>, which are associated with compilation or configuration errors and may indicate unauthorized alteration of the content of your Web site: </p>\r\n  <ul>\r\n    <li>\r\n      <b>WebErrorCompilationError</b> (code 3007). This indicates that an error occurred during application compilation. <li><b>WebErrorConfigurationError</b> (code 3008). This indicates that a configuration error occurred. <li><b>WebErrorObjectStateFormatterDeserializationError</b> (code 3011). This indicates that an error deserializing internal state objects occurred. <li><b>WebErrorOtherError</b> (code 3009). This indicates that an unclassified error occurred. <li><b>WebErrorParserError</b> (code 3006). This indicates that a parser error occurred. <li><b>WebErrorPropertyDeserializationError</b> (code 3010). This indicates that an error deserializing internal state objects occurred. </li></li></li></li></li></li>\r\n  </ul>\r\n  <h3>Runtime Error Events</h3>\r\n  <p>The following major event codes are logged for exceptions of type <b>WebRequestErrorEvent</b>, which are associated with runtime errors, and may indicate an attack on your Web site: </p>\r\n  <ul>\r\n    <li>\r\n      <b>DiskOutputCacheInformation</b> (code 5003). This indicates that a disk output cache event occurred. This event is always accompanied by a detail code giving more information. <li><b>DiskOutputCacheQuotaExceeded</b> (code 5001). This indicates that the disk output cache quota was exceeded. <li><b>RuntimeErrorPostTooLarge</b> (code 3004). This indicates that the size of the posted information exceeded the allowed limits. <li><b>RuntimeErrorRequestAbort</b> (code 3001). This indicates that the Web request has been aborted. <li><b>RuntimeErrorUnhandledException</b> (code 3005). This indicates that an unhandled exception occurred. <li><b>RuntimeErrorValidationFailure</b> (code 3003). This indicates that a validation error occurred. <li><b>RuntimeErrorViewStateFailure</b> (code 3002). This indicates that a view state failure occurred. </li></li></li></li></li></li></li>\r\n  </ul>\r\n  <h2>Platform Default Events Not Logged by Default</h2>\r\n  <p>The following events are not logged by default.</p>\r\n  <h3>Application Life Time Events</h3>\r\n  <p>The following events can be logged for detecting application availability. These are not on by default, but we recommend that all of them are turned on in order to detect potential attacks: </p>\r\n  <ul>\r\n    <li>\r\n      <b>ApplicationStart </b>(code 1001) / <b>ApplicationShutdown</b> (code 1002). These events indicate application startup and shutdown, and they are always accompanied by a detail code giving more information. If you see a large quantity of these events, your application may be the target of a denial of service attack. <li><b>ApplicationCompilationStart</b> (code 1003) / <b>ApplicationCompilationEnd</b> (code 1004). These events indicate the compilation of the application has started and finished. If you see these events, it may be an indication of unauthorized modification of your application content. </li></li>\r\n  </ul>\r\n  <h3>Forms Authentication Events</h3>\r\n  <p>For additional forms authentication information, log the following events: </p>\r\n  <ul>\r\n    <li>\r\n      <b>AuditFormsAuthenticationSuccess</b> (code 4001). This is used to maintain audit trail of successful forms authentication, which can then be retraced if the system is compromised, when using forms authentication classes. <li><b>AuditMembershipAuthenticationSuccess</b> (code 4002). This is used to maintain audit trail of successful authentications in the ASP.NET membership system, which can then be retraced if the system is compromised, when using the membership feature. </li></li>\r\n  </ul>\r\n  <h3>Authorization Events</h3>\r\n  <p>To provide additional authorization information, log the following events: </p>\r\n  <ul>\r\n    <li>\r\n      <b>AuditFileAuthorizationSuccess</b> (code 4004). This is used to maintain an audit trail, which can then be retraced to identify all successful file accesses by an attacker if the system is compromised. <li><b>AuditUrlAuthorizationSuccess</b> (code 4003). This is used to maintain an audit trail, which can then be retraced to identify all successful URL and path accesses by an attacker if the system is compromised. </li></li>\r\n  </ul>\r\n  <h3>Web Heartbeat Event</h3>\r\n  <p>The <b>WebHeartbeatEvent</b> may be logged to provide an audit trail that monitors normal operation of your application: </p>\r\n  <ul>\r\n    <li>\r\n      <b>ApplicationHeartbeat</b> (code 1005). This is used to log a heartbeat for the application. The heartbeat interval is defined by the <b>heartBeatInterval</b> attribute of the &lt;<b>healthMonitoring</b>&gt; element. The default value is 0, indicating no heartbeat. </li>\r\n  </ul>\r\n  <h3>Web Request Events</h3>\r\n  <p>These events may be logged to provide an audit trail of normal request completion and abort: </p>\r\n  <ul>\r\n    <li>\r\n      <b>RequestTransactionComplete</b> (code 2001). This indicates the Web request was completed. <li><b>RequestTransactionAbort</b> (code 2002). This indicates the Web request was aborted. </li></li>\r\n  </ul>\r\n  <h2>Additional Custom Security Events</h2>\r\n  <p>There are additional custom security events that you can instrument to improve your ability to detect and understand attacks on your application. The following list identifies some additional security events that you should consider logging. In addition to the events that follow, you might also have to instrument unique events to monitor critical functionality in your application.</p>\r\n  <h3>Authorization Events</h3>\r\n  <p>Following is a list of authorization scenarios for which you can create custom events in order to improve visibility on the health of your application: </p>\r\n  <ul>\r\n    <li>Accessing in memory object/keys. This is used to instrument success and failure events, can be used to identify objects/keys compromise. <li>Roles Authorization success events. This is used to maintain audit trail for user activities. <li>Roles Authorization failure events. This is used to identify attempts at unauthorized access. </li></li></li>\r\n  </ul>\r\n  <h3>Session Management Events</h3>\r\n  <p>Instrumenting the following events can aid your ability to track user activities and detect anomalies in user behavior: </p>\r\n  <ul>\r\n    <li>Session lifetime events <li>Session creation <li>Session termination <li>Session timeout <li>Session expiration </li></li></li></li></li>\r\n  </ul>\r\n  <h3>User Management Events</h3>\r\n  <p>Instrumenting the following events can aid your ability to track anomalies in user account changes: </p>\r\n  <ul>\r\n    <li>Password resets/changes <li>Account creation/deletion/modification/lockout <li>Roles assignment </li></li></li>\r\n  </ul>\r\n  <h1>Sample: Password Change Event</h1>\r\n  <p>This sample provides a custom Web event that you can use to record when a user changes his or her password in an application that uses ASP.NET membership to authenticate users with forms authentication.</p>\r\n  <h2>To create a password changed Web event </h2>\r\n  <ol>\r\n    <li>To build a Web event, create a class in a class library that derives from <b>System.Web.Management.WebSuccessAuditEvent</b>. Use the following code. <div><pre>using System;<br />using System.Web.Management;<br />using System.Text;<br />using System.Web;<br />namespace MyWebEvents<br />&#123;<br />&nbsp;&nbsp;&nbsp; public class PasswordChangedEvent : WebSuccessAuditEvent<br />&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public PasswordChangedEvent(string msg, object eventSource, int eventCode)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : base(msg, eventSource, eventCode)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public PasswordChangedEvent(string msg, object eventSource, int eventCode, int eventDetailCode)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : base(msg, eventSource, eventCode, eventDetailCode)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;<br />public override void FormatCustomEventDetails(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WebEventFormatter formatter)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; base.FormatCustomEventDetails(formatter);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Add custom data.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; formatter.AppendLine(\"\");<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; formatter.IndentationLevel &#43;= 1;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; formatter.AppendLine(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \"&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42; SampleWebSuccessAuditEvent Start &#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;\");<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; formatter.AppendLine(string.Format(\"Request path: &#123;0&#125;\",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RequestInformation.RequestPath));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; formatter.AppendLine(string.Format(\"Request Url: &#123;0&#125;\",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RequestInformation.RequestUrl));<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Display custom event message.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; formatter.AppendLine(\"Password changed\");<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; formatter.AppendLine(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \"&#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42; SampleWebSuccessAuditEvent End &#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;\");<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; formatter.IndentationLevel -= 1;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;&nbsp; <br />&nbsp;&nbsp;&nbsp; &#125;<br />&#125;   </pre></div><li>Compile the class library to build an assembly. </li></li>\r\n  </ol>\r\n  <h2>To instrument an application with the password changed event </h2>\r\n  <ol>\r\n    <li>Create a new ASP.NET Web application that includes the following Login.aspx page. Note that this page contains <b>CreateUserWizard</b> and <b>ChangePassword</b> controls. Within the <b>OnChangePassword</b> event handler, the custom <b>PasswordChangedEvent</b> is raised. <div><pre>&lt;&#37;&#64; Page Language=\"C#\" &#37;&gt;<br />&lt;&#37;&#64; Import namespace=\"System.Web.Management\" &#37;&gt;<br />&lt;&#33;DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.1//EN\" \"<a href=\"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd\">http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd</a>\"&gt;<br />&lt;script runat=\"server\"&gt;<br />&nbsp;&nbsp;&nbsp; protected void OnChangePassword(object sender, EventArgs e)<br />&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MyWebEvents.PasswordChangedEvent pcEvt = new <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MyWebEvents.PasswordChangedEvent(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \"Password changed\", <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this, <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WebEventCodes.WebExtendedBase &#43; 1);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pcEvt.Raise();<br />&nbsp;&nbsp;&nbsp; &#125;<br />&lt;/script&gt;<br />&lt;html&nbsp; &gt;<br />&lt;head runat=\"server\"&gt;<br />&nbsp;&nbsp;&nbsp; &lt;title&gt;Untitled Page&lt;/title&gt;<br />&lt;/head&gt;<br />&lt;body&gt;<br />&nbsp;&nbsp;&nbsp; &lt;form id=\"form1\" runat=\"server\"&gt;<br />&nbsp;&nbsp;&nbsp; &lt;div&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;asp:CreateUserWizard ID=\"CreateUserWizard1\" runat=\"server\"&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;WizardSteps&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;asp:CreateUserWizardStep runat=\"server\"&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/asp:CreateUserWizardStep&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;asp:CompleteWizardStep runat=\"server\"&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/asp:CompleteWizardStep&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/WizardSteps&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/asp:CreateUserWizard&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&lt;/div&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;asp:ChangePassword ID=\"ChangePassword1\" runat=\"server\" OnChangedPassword=\"OnChangePassword\"&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/asp:ChangePassword&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/form&gt;<br />&lt;/body&gt;<br />&lt;/html&gt;  </pre></div><li><blockquote><b>Note</b>&nbsp;&nbsp;&nbsp;Default ASP.NET configuration for the membership system results in the creation and use of a membership database in a SQL Express database in your application's \\app_data folder. For more information about how to use the ASP.NET membership system, see <a onclick=\"javascript:Track('ctl00_LibFrame_ctl01&#124;ctl00_LibFrame_ctl08',this);\" href=\"http://msdn2.microsoft.com/en-us/library/ms998347.aspx\">How To: Use Membership in ASP.NET 2.0</a>.</blockquote><li>Add a Web.config file to your application and add the following configuration, to configure your application for forms authentication. <div><pre>&lt;system.web&gt;<br />&nbsp;&nbsp;&nbsp; ...<br />&nbsp;&nbsp;&nbsp; &lt;authentication mode=\"Forms\" /&gt;<br />&nbsp;&nbsp;&nbsp; &lt;authorization&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;deny users=\"?\" /&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/authorization&gt;<br />&nbsp;&nbsp;&nbsp; ...<br />&lt;/system.web&gt;  </pre></div><li>Configure health monitoring for the custom event by adding the following &lt;<b>healthMonitoring</b>&gt; element to your application's Web.config file within the &lt;<b>system.web</b>&gt; element. <div><pre>&lt;healthMonitoring&gt;<br />&nbsp;&nbsp;&nbsp; &lt;eventMappings&gt; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;add name=\"Password Change Event\" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type=\"MyWebEvents.PasswordChangedEvent,MyWebEvents\"/&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/eventMappings&gt;<br />&nbsp;&nbsp;&nbsp; &lt;rules&gt; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;add name=\"Custom event\" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; eventName=\"Password Change Event\" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; provider=\"EventLogProvider\" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; minInterval=\"00:00:01\"/&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/rules&gt;&nbsp;&nbsp;&nbsp;&nbsp; <br />&lt;/healthMonitoring&gt;  </pre></div><li>Run the application. Use the <b>CreateUserWizard</b> control to create a new user. The default membership configuration requires a password of at least 7 characters in length with at least one non-alphanumeric character. <li>Use the <b>ChangePassword</b> control to change the user's password. <li>Examine the Windows application event log to verify that the custom event has been raised and logged. You should see details similar to the following. <div><pre>Event Type:&nbsp; Information<br />Event Source:&nbsp;&nbsp;&nbsp; ASP.NET 3.5<br />Event Category:&nbsp;&nbsp;&nbsp; Web Event <br />Event ID:&nbsp;&nbsp;&nbsp; 1312<br />Date:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 22/06/2009<br />Time:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 12:09:50<br />User:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; N/A<br />Computer:&nbsp;&nbsp;&nbsp; MachineName<br />Description:<br />Event code: 100002 <br />Event message: Password changed <br />Event time: 22/06/2009 12:09:48 <br />Event time (UTC): 22/06/2009 11:09:48 <br />Event ID: 1cc7c6fd96ea459892fd8896ceabf912 <br />Event sequence: 5 Event occurrence: 1 <br />Event detail code: 0<br />Application information:<br />&nbsp;&nbsp;&nbsp;&nbsp; Application domain: 39a139ed-2-127639121611001296<br />&nbsp;&nbsp;&nbsp;&nbsp; Trust level: Full<br />&nbsp;&nbsp;&nbsp;&nbsp; Application Virtual Path: /HealthMonitoring<br />&nbsp;&nbsp;&nbsp;&nbsp; Application Path: C:\\Documents and Settings\\&#123;UserName&#125;\\my documents\\visual studio\\Projects\\Websites\\HealthMonitoring\\<br />&nbsp;&nbsp;&nbsp;&nbsp; Machine name: MachineName<br />Process information:<br />&nbsp;&nbsp;&nbsp;&nbsp; Process ID: 3052<br />&nbsp;&nbsp;&nbsp;&nbsp; Process name: WebDev.WebServer.EXE<br />&nbsp;&nbsp;&nbsp;&nbsp; Account name: DomainName\\UserName<br />&nbsp;<br />Request information:<br />&nbsp;&nbsp;&nbsp;&nbsp; Request URL: <a href=\"http://localhost:2076/HealthMonitoring/default.aspx\">http://localhost:2076/HealthMonitoring/default.aspx</a><br />&nbsp;&nbsp;&nbsp;&nbsp; Request path: /HealthMonitoring/default.aspx<br />&nbsp;&nbsp;&nbsp;&nbsp; User host address: 127.0.0.1&nbsp;&nbsp;&nbsp;&nbsp; User: UserName&nbsp;&nbsp;&nbsp;&nbsp; Is authenticated: True<br />&nbsp;&nbsp;&nbsp;&nbsp; Authentication Type: Forms<br />&nbsp;&nbsp;&nbsp;&nbsp; Thread account name: DomainName\\UserName <br />Custom event details: <br />&nbsp;&nbsp;&nbsp; &#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42; SampleWebSuccessAuditEvent Start &#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;<br />&nbsp;&nbsp;&nbsp; Request path: /HealthMonitoring/default.aspx<br />&nbsp;&nbsp;&nbsp; Request Url: <a href=\"http://localhost:2076/HealthMonitoring/default.aspx\">http://localhost:2076/HealthMonitoring/default.aspx</a><br />&nbsp;&nbsp;&nbsp; Password changed<br />&nbsp;&nbsp;&nbsp; &#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42; SampleWebSuccessAuditEvent End &#42;&#42;&#42;&#42;&#42;&#42;&#42;&#42;<br />For more information, see Help and Support Center at <a href=\"http://go.microsoft.com/fwlink/events.asp\">http://go.microsoft.com/fwlink/events.asp</a>.<br /></pre></div></li></li></li></li></li></li></li>\r\n  </ol>\r\n  <h1>Sample: Membership Account Locked Event</h1>\r\n  <p>The following sample shows how to raise a custom Web event when an ASP.NET membership user account is locked because of too many attempts to login using an incorrect password.</p>\r\n  <h2>To create an account locked Web event </h2>\r\n  <ol>\r\n    <li>To build a Web event, create a class in a class library that derives from <b>System.Web.Management.WebAuthenticationFailureAuditEvent</b>. Use the following code after adding a reference to System.Web <div><pre>using System;<br />using System.Web.Management;<br />using System.Text;<br />using System.Web;<br />namespace MyWebEvents<br />&#123;<br />&nbsp;&nbsp;&nbsp; public class AccountLockedEvent : WebAuthenticationFailureAuditEvent<br />&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public AccountLockedEvent(string msg, object eventSource, int eventCode, string nameToAuthenticate)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : base(msg, eventSource, eventCode, nameToAuthenticate)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public AccountLockedEvent(string username, string msg, object eventSource, int eventCode, int eventDetailCode, string nameToAuthenticate)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : base(msg, eventSource, eventCode, eventDetailCode,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nameToAuthenticate)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;<br />&nbsp;&nbsp;&nbsp; &#125;<br />&#125;   </pre></div><li>Compile the class library to build an assembly. </li></li>\r\n  </ol>\r\n  <h2>To instrument an application with the account locked event </h2>\r\n  <ol>\r\n    <li>Create a new ASP.NET Web application that includes the following Login.aspx page. Note that this page contains <b>Login</b> and <b>CreateUserWizard</b> controls. Within the <b>Login1_LoginError</b> event handler, the custom <b>AccountLockedEvent</b> is raised if the authentication error is as a result of the user account being locked. <p>Note that this example traps the <b>LoginError</b> event of the <b>Login</b> control to detect that a user could not be authenticated. If you are using the membership system but not using the login controls, you can retrieve the value of the <b>MembershipUser.IsLockedOut</b> property at any time to detect if a user account is locked. </p><div><pre>&lt;&#37;&#64; Page Language=\"C#\" &#37;&gt;<br />&lt;&#37;&#64; Import namespace=\"System.Web.Management\" &#37;&gt;<br />&lt;&#33;DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.1//EN\" \"<a href=\"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd\">http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd</a>\"&gt;<br />&lt;script runat=\"server\"&gt;<br />&nbsp;&nbsp;&nbsp; protected void Login1_LoginError(object sender, EventArgs e)<br />&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MembershipUser user = Membership.GetUser(Login1.UserName);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Check user exists; if so, was failure due to locked out?<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (user &#33;= null)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (user.IsLockedOut)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AccountLockedEvent testEvent = <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; new AccountLockedEvent(\"Account Locked\",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WebEventCodes.WebExtendedBase &#43; 2,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Login1.UserName);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; testEvent.Raise();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;<br />&nbsp;&nbsp;&nbsp; &#125; &lt;/script&gt;<br />&lt;html&nbsp; &gt;<br />&lt;head runat=\"server\"&gt;<br />&nbsp;&nbsp;&nbsp; &lt;title&gt;Untitled Page&lt;/title&gt;<br />&lt;/head&gt;<br />&lt;body&gt;<br />&nbsp;&nbsp;&nbsp; &lt;form id=\"form1\" runat=\"server\"&gt;<br />&nbsp;&nbsp;&nbsp; &lt;div&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;asp:Login ID=\"Login1\" runat=\"server\" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnLoginError=\"Login1_LoginError\"&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/asp:Login&gt;<br />&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp; &lt;/div&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;asp:CreateUserWizard ID=\"CreateUserWizard1\" runat=\"server\"&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;WizardSteps&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;asp:CreateUserWizardStep runat=\"server\"&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/asp:CreateUserWizardStep&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;asp:CompleteWizardStep runat=\"server\"&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/asp:CompleteWizardStep&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/WizardSteps&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/asp:CreateUserWizard&gt;&nbsp;&nbsp;&nbsp; &lt;/form&gt;<br />&lt;/body&gt;<br />&lt;/html&gt;  </pre></div><li><blockquote><b>Note</b>&nbsp;&nbsp;&nbsp;Default ASP.NET configuration for the membership system results in the creation and use of a membership database in a SQL Express database in your application's \\app_data folder. </blockquote><li>Add a Web.config file to your application and add the following configuration to configure your application for forms authentication. <div><pre>&lt;system.web&gt;<br />&nbsp;&nbsp;&nbsp; ...<br />&nbsp;&nbsp;&nbsp; &lt;authentication mode=\"Forms\" /&gt;<br />&nbsp;&nbsp;&nbsp; &lt;authorization&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;deny users=\"?\" /&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/authorization&gt;<br />&nbsp;&nbsp;&nbsp; ...<br />&lt;/system.web&gt;  </pre></div><li>Configure health monitoring for the custom event by adding the following &lt;<b>healthMonitoring</b>&gt; element to your application's Web.config file within the &lt;<b>system.web</b>&gt; element. <div><pre>&lt;healthMonitoring&gt;<br />&nbsp;&nbsp;&nbsp; &lt;eventMappings&gt; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;add name=\"Account Locked Event\" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type=\"MyWebEvents.AccountLockedEvent,MyWebEvents\"/&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp; &lt;/eventMappings&gt;<br />&nbsp;&nbsp;&nbsp; &lt;rules&gt; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;add name=\"Custom event\" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; eventName=\"Account Locked Event\" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; provider=\"EventLogProvider\" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; minInterval=\"00:00:01\"/&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/rules&gt;&nbsp;&nbsp;&nbsp;&nbsp; <br />&lt;/healthMonitoring&gt;  </pre></div><li>Run the application. Use the <b>CreateUserWizard</b> control to create a new user. The default membership configuration requires a password of at least 7 characters in length with at least one non-alphanumeric character. <li>Enter data into the <b>Login</b> control to perform user authentication. Use the user name you just created, but deliberately enter an incorrect password. Repeat this 5 times within a 10 minute window. <blockquote><b>Note</b>&nbsp;&nbsp;&nbsp;The number of invalid password attempts is determined by the <b>maxInvalidPasswordAttempts</b> attribute of the configured membership provider and the retry window by the <b>passwordAttemptWindow</b> attribute. The default configuration for the ASP.NET membership system is defined in &#37;Windows&#37;\\Microsoft.NET\\Framework\\<i>version</i>\\Config\\machine.config.default, which defines this attributes as 5 attempts within a 10 minute window.<b></b></blockquote><li>Examine the Windows application event log to verify that the custom event has been raised and logged. You should see details similar to the following. Note that the user name of the locked account is included near the bottom as <b>Name to authenticate</b>. <div><pre>Event Type:&nbsp;&nbsp;&nbsp; Information<br />Event Source:&nbsp;&nbsp;&nbsp; ASP.NET 3.5<br />Event Category:&nbsp;&nbsp;&nbsp; Web Event <br />Event ID:&nbsp;&nbsp;&nbsp; 1315<br />Date:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 02/08/2009<br />Time:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 11:28:17<br />User:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; N/A<br />Computer:&nbsp;&nbsp;&nbsp; MachineName<br />Description:<br />Event code: 100001 <br />Event message: Account Locked <br />Event time: 02/08/2009 11:28:17 <br />Event time (UTC): 02/08/2009 10:28:17 <br />Event ID: aa11f46a63bf49ccb6e2c642735ef26e <br />Event sequence: 5 <br />Event occurrence: 1 <br />Event detail code: 0 <br />&nbsp;<br />Application information:<br />&nbsp;&nbsp;&nbsp;&nbsp; Application domain: 39a139ed-1-127674517374818688<br />&nbsp;&nbsp;&nbsp;&nbsp; Trust level: Full<br />&nbsp;&nbsp;&nbsp;&nbsp; Application Virtual Path: /HealthMonitoring<br />&nbsp;&nbsp;&nbsp;&nbsp; Application Path: C:\\Documents and Settings\\&#123;UserName&#125;\\my documents\\visual studio\\Projects\\Websites\\HealthMonitoring\\<br />&nbsp;&nbsp;&nbsp;&nbsp; Machine name: MachineName <br />&nbsp;<br />Process information:<br />&nbsp;&nbsp;&nbsp;&nbsp; Process ID: 2972<br />&nbsp;&nbsp;&nbsp;&nbsp; Process name: WebDev.WebServer.EXE<br />&nbsp;&nbsp;&nbsp;&nbsp; Account name: DomainName\\UserName Request information:<br />&nbsp;&nbsp;&nbsp;&nbsp; Request URL: <a href=\"http://localhost:2076/HealthMonitoring/login.aspx\">http://localhost:2076/HealthMonitoring/login.aspx</a><br />&nbsp;&nbsp;&nbsp;&nbsp; Request path: /HealthMonitoring/login.aspx<br />&nbsp;&nbsp;&nbsp;&nbsp; User host address: 127.0.0.1<br />&nbsp;&nbsp;&nbsp;&nbsp; User:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Is authenticated: False<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Authentication Type:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Thread account name: DomainName\\UserName <br />Name to authenticate: UserName <br />&nbsp;<br />Custom event details: <br />For more information, see Help and Support Center at <a href=\"http://go.microsoft.com/fwlink/events.asp.\">http://go.microsoft.com/fwlink/events.asp.</a></pre></div></li></li></li></li></li></li></li>\r\n  </ol>\r\n  <h1>Sample: Access Sensitive Method Event</h1>\r\n  <p>The following sample shows how to raise a custom Web event to track calls to a method containing sensitive business logic. </p>\r\n  <h2>To create a sensitive method Web event </h2>\r\n  <ol>\r\n    <li>To build a Web event, create a class in a class library that derives from <b>System.Web.Management.WebSuccessAuditEvent</b>. The following example writes out the name of the Windows account that is currently authenticated and the name of the function being accessed. <div><pre>using System;<br />using System.Web.Management;<br />using System.Text;<br />using System.Web;<br />namespace MyWebEvents<br />&#123;<br />&nbsp;&nbsp;&nbsp; public class SensitiveFunctionEvent : WebSuccessAuditEvent<br />&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private string userID;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private string functionName;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public SensitiveFunctionEvent(string msg, object eventSource, int eventCode, string functionname)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : base(msg, eventSource, eventCode)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; functionName = functionname;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Obtain the HTTP Context and store authentication details<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; userID = HttpContext.Current.User.Identity.Name;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public SensitiveFunctionEvent(string msg, object eventSource, int eventCode, int eventDetailCode, string functionname)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : base(msg, eventSource, eventCode, eventDetailCode)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; functionName = functionname;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Obtain the HTTP Context and store authentication details<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; userID = HttpContext.Current.User.Identity.Name;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;<br />public override void FormatCustomEventDetails(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WebEventFormatter formatter)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; base.FormatCustomEventDetails(formatter);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; formatter.AppendLine(\"Function Name: \" &#43; functionName);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; formatter.AppendLine(\"User ID: \" &#43; userID);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;&nbsp; <br />&nbsp;&nbsp;&nbsp; &#125;<br />&#125;   </pre></div><li>Add a reference to the <b>System.Web </b>assembly. <li>Compile the class library to build an assembly. </li></li></li>\r\n  </ol>\r\n  <h2>To instrument an application with the event </h2>\r\n  <ol>\r\n    <li>Create a new ASP.NET Web application that includes the following default.aspx page. <div><pre>&lt;&#37;&#64; Page Language=\"C#\" &#37;&gt;<br />&lt;&#37;&#64; Import namespace=\"System.Web.Management\" &#37;&gt;<br />&lt;&#33;DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.1//EN\" \"<a href=\"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd\">http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd</a>\"&gt;<br />&lt;script runat=\"server\"&gt;<br />&nbsp;&nbsp;&nbsp; protected void Page_Load(object sender, EventArgs e)<br />&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SomeFunctionContainingSensitiveLogic();<br />&nbsp;&nbsp;&nbsp; &#125;<br />&nbsp;&nbsp;&nbsp; private void SomeFunctionContainingSensitiveLogic()<br />&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SensitiveFunctionEvent testEvent = new SensitiveFunctionEvent(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \"Sensitive function has been accessed\",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WebEventCodes.WebExtendedBase &#43; 3,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \"SomeFunctionContainingSensitiveLogic\");<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; testEvent.Raise();<br />  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Some sensitive logic would appear below...<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // ...<br />&nbsp;&nbsp;&nbsp; &#125;&nbsp;&nbsp;&nbsp; <br />&lt;/script&gt;<br />&lt;html&nbsp; &gt;<br />&lt;head runat=\"server\"&gt;<br />&nbsp;&nbsp;&nbsp; &lt;title&gt;Untitled Page&lt;/title&gt;<br />&lt;/head&gt;<br />&lt;body&gt;<br />&nbsp;&nbsp;&nbsp; &lt;form id=\"form1\" runat=\"server\"&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/form&gt;<br />&lt;/body&gt;<br />&lt;/html&gt;  </pre></div><li>Add a Web.config file to your application and add the following configuration, to configure your application for Windows authentication. <div><pre>&lt;system.web&gt;<br />&nbsp;&nbsp;&nbsp; ...<br />&nbsp;&nbsp;&nbsp; &lt;authentication mode=\"Windows\" /&gt;<br />&nbsp;&nbsp;&nbsp; ...<br />&lt;/system.web&gt;  </pre></div><li>Configure health monitoring for the custom event by adding the following &lt;<b>healthMonitoring</b>&gt; element to your application's Web.config file within the &lt;<b>system.web</b>&gt; element. <div><pre>&lt;healthMonitoring&gt;<br />&nbsp;&nbsp;&nbsp; &lt;eventMappings&gt; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;add name=\"Sensitive Function Audit\" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type=\"MyWebEvents.SensitiveFunctionEvent,MyWebEvents\"/&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/eventMappings&gt;<br />&nbsp;&nbsp;&nbsp; &lt;rules&gt; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;add name=\"Custom event\" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; eventName=\"Sensitive Function Audit\" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; provider=\"EventLogProvider\" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; minInterval=\"00:00:01\"/&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/rules&gt;&nbsp;&nbsp;&nbsp;&nbsp; <br />&lt;/healthMonitoring&gt;  </pre></div><li>Run the application. <li>Examine the Windows application event log to verify that the custom event has been raised and logged. You should see details similar to the following. <div><pre>Event Type:&nbsp; Information<br />Event Source:&nbsp; ASP.NET 3.5<br />Event Category:&nbsp; Web Event <br />Event ID:&nbsp; 1312<br />Date:&nbsp;&nbsp;&nbsp; 02/08/2005<br />Time:&nbsp;&nbsp;&nbsp; 12:23:50<br />User:&nbsp;&nbsp;&nbsp; N/A<br />Computer:&nbsp; MachineName<br />Description:<br />Event code: 100003 <br />Event message: Sensitive function has been accessed <br />Event time: 02/08/2009 12:23:50 <br />Event time (UTC): 02/08/2009 11:23:50 <br />Event ID: 57d3761489b741978cae24b673f6b2a4 <br />Event sequence: 4 <br />Event occurrence: 1 <br />Event detail code: 0 <br />&nbsp;<br />Application information:<br />&nbsp;&nbsp;&nbsp;&nbsp; Application domain: 39a139ed-4-127674554288097376<br />&nbsp;&nbsp;&nbsp;&nbsp; Trust level: Full<br />&nbsp;&nbsp;&nbsp;&nbsp; Application Virtual Path: /HealthMonitoring<br />&nbsp;&nbsp;&nbsp;&nbsp; Application Path: C:\\Documents and Settings\\&#123;UserName&#125;\\my documents\\visual studio\\Projects\\Websites\\HealthMonitoring\\<br />&nbsp;&nbsp;&nbsp;&nbsp; Machine name: MachineName&nbsp; Process information:<br />&nbsp;&nbsp;&nbsp;&nbsp; Process ID: 2972<br />&nbsp;&nbsp;&nbsp;&nbsp; Process name: WebDev.WebServer.EXE<br />&nbsp;&nbsp;&nbsp;&nbsp; Account name: DomainName\\UserName&nbsp; Request information:<br />&nbsp;&nbsp;&nbsp;&nbsp; Request URL: <a href=\"http://localhost:2076/HealthMonitoring/default.aspx\">http://localhost:2076/HealthMonitoring/default.aspx</a><br />&nbsp;&nbsp;&nbsp;&nbsp; Request path: /HealthMonitoring/default.aspx<br />&nbsp;&nbsp;&nbsp;&nbsp; User host address: 127.0.0.1<br />&nbsp;&nbsp;&nbsp;&nbsp; User: DomainName\\UserName<br />&nbsp;&nbsp;&nbsp; Is authenticated: True<br />&nbsp;&nbsp;&nbsp;&nbsp; Authentication Type: NTLM<br />&nbsp;&nbsp;&nbsp;&nbsp; Thread account name: DomainName\\UserName <br />Custom event details:<br />Function Name: SomeFunctionContainingSensitiveLogic<br />User ID: DomainName\\UserName<br />For more information, see Help and Support Center at <a href=\"http://go.microsoft.com/fwlink/events.asp\">http://go.microsoft.com/fwlink/events.asp</a>.</pre></div></li></li></li></li></li>\r\n  </ol>\r\n  <hr />\r\n  <p>Adapted from Microsoft patterns & practices guidance.</p>"
        ]
      }
    ]
  }
}