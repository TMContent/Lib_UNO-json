{
  "TeamMentor_Article": {
    "$": {
      "Metadata_Hash": "-9561926",
      "Content_Hash": "-1287098766"
    },
    "Metadata": [
      {
        "Id": [
          "66528ee6-635f-40d6-9061-decee513cb64"
        ],
        "Id_History": [
          "66528ee6-635f-40d6-9061-decee513cb64,7ef73eb4-fec9-41b8-a573-a37556eeb680,"
        ],
        "Library_Id": [
          "be5273b1-d682-4361-99d9-6234f2d47eb7"
        ],
        "Title": [
          "[SINK] Sensitive Data in the Registry Is Encrypted."
        ],
        "Category": [
          "Hardening"
        ],
        "Phase": [
          "Implementation"
        ],
        "Technology": [
          ".NET 3.5"
        ],
        "Type": [
          "Checklist Item"
        ],
        "DirectLink": [
          "Sensitive Data in the Registry Is Encrypted."
        ],
        "Tag": [
          ""
        ],
        "Security_Demand": [
          ""
        ],
        "Author": [
          ""
        ],
        "Priority": [
          ""
        ],
        "Status": [
          ""
        ],
        "Source": [
          "SI"
        ]
      }
    ],
    "Content": [
      {
        "$": {
          "Sanitized": "true",
          "DataType": "Html"
        },
        "Data": [
          "<h1>What to Check For</h1>\n  <p>Check to ensure that sensitive data in the registry is encrypted by using DPAPI.</p>\n  <p />\n  <h1>How to Fix</h1>\n  <p>If you need to store sensitive data in the registry, then consider encrypting it with DPAPI. You can use DPAPI with the machine key to encrypt the data, store the encrypted data beneath a registry key, and then use an ACL that restricts access to your specific application identity to restrict access to the registry key. Alternatively, you can use DPAPI with the user store. In this latter case, you need to load the user account's profile to access the key.</p>\n  <p>Consider using the machine store if your application is a server that runs on its own dedicated computer with no other applications, or if you have multiple applications on the same server and you need those applications to be able to share the sensitive registry data. If you only want specific service accounts to be able to access the DPAPI keys and their profiles are loaded, then use DPAPI with the user store.</p>\n  <p>The following code shows how to create a registry key protected with an ACL and how to use DPAPI with the machine store to store encrypted data in the restricted key.</p>\n  <pre>\n    <div>\n      <pre>using System.Security.Cryptography;<br />using System.Security.AccessControl;<br />using System.Text;<br />using Microsoft.Win32;<br />...<br />// Get the original data in a byte arraybyte&amp;#91;&amp;#93;<br /> toEncrypt = UnicodeEncoding.ASCII.GetBytes(<br />                   \"The secret data to be encrypted\");<br />// Encrypt the data by using the ProtectedData <br />class.byte&amp;#91;&amp;#93; encryptedData = ProtectedData.Protect(toEncrypt, null,<br />                       DataProtectionScope.LocalMachine);<br />// Create a new key in the registry with a restricted ACL <br />// and write stream of bytes to the registry <br />keystring user = Environment.UserDomainName &amp;#43; \"\\\\\" &amp;#43; Environment.UserName;<br />RegistrySecurity security = new RegistrySecurity();<br />RegistryAccessRule rule = new RegistryAccessRule(user,<br />                RegistryRights.FullControl,<br />                InheritanceFlags.ContainerInherit,<br />                PropagationFlags.None,<br />                AccessControlType.Allow);<br />security.AddAccessRule(rule);<br />Registry.CurrentUser.CreateSubKey(\"TestEncryptedData\",<br />                RegistryKeyPermissionCheck.ReadWriteSubTree,<br />                security);Registry.SetValue(&amp;#64;\"HKEY_CURRENT_USER\\TestEncryptedData\", \"Encrypted\",<br />                 encryptedData);</pre>\n    </div>\n  </pre>\n  <p>Use the following code to decrypt the data stored in the registry.</p>\n  <pre>\n    <div>\n      <pre>// Read the encrypted data from registry and decrypt the contents <br />byte&amp;#91;&amp;#93; dataFromRegistry = Registry.GetValue(&amp;#64;\"HKEY_CURRENT_USER\\TestEncryptedData\",<br />                 \"Encrypted\", null) as byte&amp;#91;&amp;#93;;<br />byte&amp;#91;&amp;#93; decryptedData = ProtectedData.Unprotect(dataFromRegistry, null,<br />                 DataProtectionScope.LocalMachine);</pre>\n    </div>\n  </pre>\n  <pre>\n    <div>\n      <pre>&amp;nbsp;</pre>\n    </div>\n  </pre>\n  <hr />\n  <p>Adapted from Microsoft patterns &amp; practices guidance.</p>"
        ]
      }
    ]
  }
}