{
  "TeamMentor_Article": {
    "$": {
      "Metadata_Hash": "-2021896502",
      "Content_Hash": "-1108534495"
    },
    "Metadata": [
      {
        "Id": [
          "3d7727d0-18ca-47c3-90f6-5c6c715c4f35"
        ],
        "Id_History": [
          "3d7727d0-18ca-47c3-90f6-5c6c715c4f35,f88de01c-3883-4990-a32c-964e07e6a4fe,"
        ],
        "Library_Id": [
          "92718d53-36b2-47bc-b6f5-e60994385f46"
        ],
        "Title": [
          "Impersonation Is Not Used Unless Required"
        ],
        "Category": [
          "Impersonation and Delegation"
        ],
        "Phase": [
          "Design"
        ],
        "Technology": [
          ".NET 3.5"
        ],
        "Type": [
          "Checklist Item"
        ],
        "DirectLink": [
          "Impersonation Is Not Used Unless Required"
        ],
        "Tag": [
          "ASP.NET,ASP.NET 3.5,ASP"
        ],
        "Security_Demand": [
          ""
        ],
        "Author": [
          ""
        ],
        "Priority": [
          "2"
        ],
        "Status": [
          ""
        ],
        "Source": [
          "SI"
        ]
      }
    ],
    "Content": [
      {
        "$": {
          "Sanitized": "true",
          "DataType": "Html"
        },
        "Data": [
          "<h1>What to Check For</h1>\r\n  <p>Ensure that your application does not use impersonation when it can be avoided.</p>\r\n  <h1>Why</h1>\r\n  <p>If programmatic impersonation is not done properly, it can introduce security vulnerabilities. It is difficult to get it correct, particularly in multithreaded applications. When possible, use alternative approaches, such as a custom domain process identity for resource access. You should avoid programmatic impersonation where possible for the following reasons:</p>\r\n  <ul>\r\n    <li>It is easy to introduce errors because of thread switches where the thread impersonation token is not propagated across threads. <li>Some programmatic techniques require you to store credentials, which should be avoided. <li>Some programmatic techniques require you to grant additional privileges to your process account, which you should avoid. For example, you must grant your process account \"Act as part of the operating system\" if you call <strong>LogonUser</strong> on Windows Server 2000 or to obtain an impersonate-level token on Windows Server 2003 when you use the new <strong>WindowsIdentity</strong> constructor that generates a token from a user principal name. <li>If exceptions occur while impersonating, it is possible for malicious code higher in the call stack to run using the impersonated identity. This can present security issues, particularly if you impersonate a highly privileged account. To read more about this please see <a href=\"/article/5b6c71b0-cb89-4435-b30e-2fd76347078e\">Do Not Propagate Exceptions While Impersonating</a>.</li></li></li></li>\r\n  </ul>\r\n  <h1>How to Check</h1>\r\n  <p>Take the following steps to ensure that your application minimizes the use of impersonation:</p>\r\n  <ol>\r\n    <li>\r\n      <p>\r\n        <strong>Review your application's requirements. </strong>Examine your application's design and requirements to identify all possible areas in your application where impersonation might be used. Common uses of impersonation include:</p>\r\n      <ul>\r\n        <li>Enforcing Active Directory security settings through Forms authentication <li>Change of privileges <li>Enforcing security settings when accessing system resources <li>Change of user identity when communicating with external components</li></li></li></li>\r\n      </ul>\r\n      <li>\r\n        <p>\r\n          <strong>Identify alternatives to impersonation.</strong>\r\n        </p>\r\n        <ul>\r\n          <li>Thoroughly examine each instance where your application uses impersonation. <li>Using the <a href=\"http://msdn2.microsoft.com/en-us/library/aa139672.aspx\">Windows development documentation</a>, identify all possible alternatives that will allow your application to perform a task without using impersonation. <li>Once alternatives have been identified, verify that impersonation is used only when necessary.</li></li></li>\r\n        </ul>\r\n      </li>\r\n    </li>\r\n  </ol>\r\n  <h1>Problem Example</h1>\r\n  <p>MyApp is the HR application at MyCorp. The application's development team rolls out a new set of features that allow the users to upload files and collaborate data. Because MyApp operates under the ASP.NET local system account, the developers use impersonation as a mechanism for mapping uploaded files to their authors, which&nbsp;forces the application to perform unnecessary impersonation. If not handled properly, this could potentially lead to an escalation of privilege vulnerability in MyApp.</p>\r\n  <pre>WindowsIdentity winIdentity = new WindowsIdentity(username &#43; \"&#64;NTDOMAIN\");<br />WindowsImpersonationContext ctx = winIdentity.Impersonate();<br /> // Store the uploaded file</pre>\r\n  <h1>Related Guideline</h1>\r\n  <ul>\r\n    <li>\r\n      <a href=\"/article/fdb65a4c-d979-4ab7-b2fa-b88e908207fe\">Guideline: Do Not Use Impersonation Unless Required</a>\r\n    </li>\r\n  </ul>\r\n  <hr />\r\n  <p>Adapted from Microsoft patterns & practices guidance. </p>"
        ]
      }
    ]
  }
}