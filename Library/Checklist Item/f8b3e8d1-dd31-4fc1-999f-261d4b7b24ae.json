{
  "TeamMentor_Article": {
    "$": {
      "Metadata_Hash": "190928976",
      "Content_Hash": "-2020284366"
    },
    "Metadata": [
      {
        "Id": [
          "f8b3e8d1-dd31-4fc1-999f-261d4b7b24ae"
        ],
        "Id_History": [
          "f8b3e8d1-dd31-4fc1-999f-261d4b7b24ae,bd42d766-432f-4e6f-8197-fddd63bdded3,"
        ],
        "Library_Id": [
          "26bd1a04-beed-4a66-917d-b6ab0a7d634c"
        ],
        "Title": [
          "Logging Is Throttled"
        ],
        "Category": [
          "Auditing and Logging"
        ],
        "Phase": [
          "Implementation"
        ],
        "Technology": [
          ".NET"
        ],
        "Type": [
          "Checklist Item"
        ],
        "DirectLink": [
          "Logging Is Throttled"
        ],
        "Tag": [
          "ASP.NET,ASP.NET 4.0,ASP"
        ],
        "Security_Demand": [
          ""
        ],
        "Author": [
          ""
        ],
        "Priority": [
          ""
        ],
        "Status": [
          ""
        ],
        "Source": [
          "SI"
        ]
      }
    ],
    "Content": [
      {
        "$": {
          "Sanitized": "true",
          "DataType": "Html"
        },
        "Data": [
          "<h1>Applies To</h1>\n  <ul>\n    <li>ASP.NET 4.0</li>\n  </ul>\n  <h1>What to Check For</h1>\n  <p>Check to ensure your application cannot be overwhelmed by excessive logging driven by malicious activity.</p>\n  <h1>Why</h1>\n  <p>If an attacker is able to overwhelm your log buffers they can degrade the performance of your application to the point that it is no longer able to serve your customers (Denial of Service).</p>\n  <h1>How To Check</h1>\n  <p>Use the following steps to check for this problem:</p>\n  <ol>\n    <li>\n      <p>\n        <strong>Review your code for promiscuous logging. </strong>Your application should be instrumented well enough that you can determine if unusual activity is occurring.&nbsp;However, do not instrument in such a way that an attacker can easily drive a large number of events to be logged. For instance, if you log an event every time you receive an unexpected parameter value an attacker could send a large number of requests and quickly generate a large number of log entries.</p>\n    </li>\n    <li>\n      <p>\n        <strong>Review log buffering in your configuration files. </strong>By default ASP.NET sets the following buffer settings for Health Monitoring:</p>\n      <pre>&lt;bufferModes&gt;     <br />&lt;add name=\"Critical Notification\" maxBufferSize=\"100\" maxFlushSize=\"20\" <br /> urgentFlushThreshold=\"1\" regularFlushInterval=\"Infinite\"<br /> urgentFlushInterval=\"00:01:00\" maxBufferThreads=\"1\" /&gt;     <br />&lt;add name=\"Notification\" maxBufferSize=\"300\" maxFlushSize=\"20\" <br /> urgentFlushThreshold=\"1\" regularFlushInterval=\"Infinite\"<br /> urgentFlushInterval=\"00:01:00\" maxBufferThreads=\"1\" /&gt;     <br />&lt;add name=\"Analysis\" maxBufferSize=\"1000\" maxFlushSize=\"100\"<br /> urgentFlushThreshold=\"100\" regularFlushInterval=\"00:05:00\"<br /> urgentFlushInterval=\"00:01:00\" maxBufferThreads=\"1\" /&gt;     <br />&lt;add name=\"Logging\" maxBufferSize=\"1000\" maxFlushSize=\"200\"<br /> urgentFlushThreshold=\"800\" regularFlushInterval=\"00:30:00\"<br /> urgentFlushInterval=\"00:05:00\" maxBufferThreads=\"1\" /&gt;<br />&lt;/bufferModes&gt;</pre>\n      <p>These default settings provide a reasonable balance between performance and buffer size that is appropriate for most applications.&nbsp;However, pay special attention to the <em>maxBufferSize</em> and <em>urgentFlushInterval</em> attribute values.&nbsp;If an attacker can drive the <em>maxBufferSize</em> to be attained before the <em>urgentFlushInterval</em> time limit, logs will be dropped from the buffer before they are sent to be recorded in the event log.</p>\n      <p>Also pay particular attention if the settings have been changed from default, or new rules have been added for additional event providers.</p>\n    </li>\n  </ol>\n  <h1>How To Fix</h1>\n  <p>If you've determined that an attacker can drive a large number of log entries thereby consuming excessive resources on your server you can do the following:</p>\n  <ol>\n    <li>\n      <p>\n        <strong>Control log thresholds with the Profiles element. </strong>You use the &lt;<em>profiles</em>&gt; element to specify sets of parameters to use when configuring events. These parameters indicate the minimum number instances after which the event should be logged, the maximum number of instances, and the minimum interval between logging two similar events. This element can be critical in controlling the amount of information generated by defining when monitoring begins and when it ends by setting thresholds. </p>\n      <p>You can use this element to throttle the event occurrences. It can help prevent an attack against the eventing system itself or an event sink such as SQL Server or the event log. You can review the default settings in the machine-level Web.config file. The following code example shows the default settings from the machine-level Web.config default file:</p>\n      <pre>&lt;profiles&gt;  <br />&lt;add name=\"Default\" minInstances=\"1\" maxLimit=\"Infinite\"<br /> minInterval=\"00:01:00\" custom=\"\" /&gt;  <br />&lt;add name=\"Critical\" minInstances=\"1\" maxLimit=\"Infinite\"<br /> minInterval=\"00:00:00\" custom=\"\" /&gt;<br />&lt;/profiles&gt;</pre>\n      <p>You can use the default profiles in your own health monitoring configuration, and you can create new profiles. </p>\n    </li>\n    <li>\n      <p>\n        <strong>Log to a separate server. </strong>Logging to a separate server not only reduces the load on your application server, it also makes it more difficult for an attacker to steal or alter your log entries.&nbsp;</p>\n      <p>To log to a separate server&nbsp;set up SQL server on the logging host and designate it as the <em>SqlWebEventProvider</em>.&nbsp;The logging machine shouldn't have any other services or roles assigned to it, to ensure that its attack surface is as small as possible.&nbsp;Make sure that you connect to the SQL server securely, preferably by using integrated authentication.&nbsp;Also, ensure that the account connecting to the database has permissions only to the stored procedures it needs and nothing else, including direct table access.&nbsp;</p>\n    </li>\n    <li>\n      <p>\n        <strong>Modify your code's use of custom events. </strong>If you have defined and are using custom events, modify your code so that an attacker cannot control the frequency of the event being raised.&nbsp;For instance, if you raise a custom event every time your application recieves a malformed parameter, you can modify this code to only log the number of malformed parameters recieved in the last 60 seconds.</p>\n    </li>\n    <li>\n      <p>\n        <strong>Modify BufferModes. </strong>Modify <em>maxBufferSize</em> and <em>urgentFlushInterval</em> attribute values so that the maximum size cannot be attained within the <em>urgentFlushInterval</em>.</p>\n    </li>\n  </ol>\n  <h1>Related Items</h1>\n  <em>You may find these additional articles useful</em>\n  <ul>\n    <li>\n      <a href=\"/article/ffef7554-2a1d-487f-9b0a-8b1c522bc51c\">Throttle Logs</a>\n    </li>\n  </ul>\n  <hr />\n  <p>Adapted from Microsoft patterns & practices guidance. </p>\n  <h1>\n  </h1>"
        ]
      }
    ]
  }
}