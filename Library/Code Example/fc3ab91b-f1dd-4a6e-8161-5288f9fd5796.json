{
  "TeamMentor_Article": {
    "$": {
      "Metadata_Hash": "448467297",
      "Content_Hash": "-265064651"
    },
    "Metadata": [
      {
        "Id": [
          "fc3ab91b-f1dd-4a6e-8161-5288f9fd5796"
        ],
        "Id_History": [
          "fc3ab91b-f1dd-4a6e-8161-5288f9fd5796,3b8bc6da-0248-484c-b53f-7e3973e4cf7c,"
        ],
        "Library_Id": [
          "be5273b1-d682-4361-99d9-6234f2d47eb7"
        ],
        "Title": [
          "[SINK] Encoding Output Within a DataTable"
        ],
        "Category": [
          "Encoding"
        ],
        "Phase": [
          "Implementation"
        ],
        "Technology": [
          ".NET 3.5"
        ],
        "Type": [
          "Code Example"
        ],
        "DirectLink": [
          "Encoding Output Within a DataTable"
        ],
        "Tag": [
          "ASP.NET,ASP.NET 3.5,ASP"
        ],
        "Security_Demand": [
          ""
        ],
        "Author": [
          ""
        ],
        "Priority": [
          ""
        ],
        "Status": [
          ""
        ],
        "Source": [
          "SI"
        ]
      }
    ],
    "Content": [
      {
        "$": {
          "Sanitized": "true",
          "DataType": "Html"
        },
        "Data": [
          "<h1>Applies to</h1>\r\n  <ul>\r\n    <li>C# </li>\r\n    <li>Server-side </li>\r\n    <li>SQL Server </li>\r\n  </ul>\r\n  <h1>Summary</h1>\r\n  <p>This code demonstrates how to implement security output encoding when using the .NET DataTable object to display application data. Output encoding mitigates against client-side script vulnerabilities by representing output data using escape character equivalents for values that might otherwise be interpreted by the browser, such as those characters used in the formatting of HTML pages (&lt;,&gt;,&,\",').</p>\r\n  <h1>Objectives</h1>\r\n  <ul>\r\n    <li>Protect application users from client-side scripting attacks </li>\r\n    <li>Ensure that malicious data that may pre-date input validation routines or have been missed through poor validation does not render as application output </li>\r\n  </ul>\r\n  <h1>Scenarios</h1>\r\n  <ul>\r\n    <li>Database-backed web application that uses data tables to present output </li>\r\n    <li>Application that uses data tables to present input from an untrusted source </li>\r\n  </ul>\r\n  <h1>Solution Example </h1>\r\n  <p>\r\n    <strong>Solution Example #1: Looping through the DataTable</strong>\r\n  </p>\r\n  <p>The following code illustrates the use of output encoding accomplished by looping through the DataRow object and calling HtmlEncode for each output value we wish to encode. </p>\r\n  <pre>\r\n    <br />public void LoadEncodedPeopleTableEvent(SqlDataAdapter adapter)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp; // Build a Data Grid to house our data and add to the set of page controls<br />&nbsp;&nbsp;&nbsp;&nbsp; DataGrid dataGrid = new DataGrid();<br />&nbsp;&nbsp;&nbsp;&nbsp; this.Controls.Add(dataGrid);</pre>\r\n  <pre>\r\n    <br />&nbsp;&nbsp;&nbsp;&nbsp; // Create a new data table and fill our that table with names from the adapter <br />&nbsp;&nbsp;&nbsp;&nbsp; DataTable names = new DataTable();<br />&nbsp;&nbsp;&nbsp;&nbsp; adapter.Fill(names);</pre>\r\n  <pre>\r\n    <br />&nbsp;&nbsp;&nbsp;&nbsp; // add an event handler to our DataGrid to encode the data<br />&nbsp;&nbsp;&nbsp;&nbsp; dataGrid.ItemDataBound += new DataGridItemEventHandler(dataGrid_EncodeItem);</pre>\r\n  <pre>\r\n    <br />&nbsp;&nbsp;&nbsp;&nbsp; // Present the data to the user in the previously created Data Grid<br />&nbsp;&nbsp;&nbsp;&nbsp; dataGrid.DataSource = names;<br />&nbsp;&nbsp;&nbsp;&nbsp; dataGrid.DataBind();<br />}</pre>\r\n  <pre>\r\n    <br />public void dataGrid_EncodeItem(object sender, DataGridItemEventArgs e)<br />{<br />&nbsp;&nbsp;&nbsp; // Encode each actual data row presented within the Data Grid<br />&nbsp;&nbsp;&nbsp; if (e.Item.ItemType.Equals(ListItemType.Item) || <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; e.Item.ItemType.Equals(ListItemType.AlternatingItem))<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; e.Item.Cells[0].Text = Server.HtmlEncode(e.Item.Cells[0].Text);<br />&nbsp;&nbsp;&nbsp; }<br />}</pre>\r\n  <p>This approach is flexible and can be used in a variety of different data presentation settings. For the example data above, the row containing malicious Javascript will be encoded and presented as escaped HTML output. </p>\r\n  <p>\r\n    <strong>Solution Example #2: Using the DataGrid ItemDataBound event</strong>\r\n  </p>\r\n  <p>The following code illustrates the use of output encoding accomplished by associating a custom encoding handler within the ItemDataBound event support by the DataGrid in use for rendering the application output. </p>\r\n  <pre>public void LoadEncodedPeopleTableLoop(SqlDataAdapter adapter)<br />{</pre>\r\n  <pre>&nbsp;&nbsp;&nbsp; // Build a Data Grid to house our data and add to the set of page controls<br />&nbsp;&nbsp;&nbsp; DataGrid dataGrid = new DataGrid();<br />&nbsp;&nbsp;&nbsp; this.Controls.Add(dataGrid);</pre>\r\n  <pre>\r\n    <br />&nbsp;&nbsp;&nbsp; // Create a new data table and fill our that table with names from the adapter <br />&nbsp;&nbsp;&nbsp; DataTable names = new DataTable();<br />&nbsp;&nbsp;&nbsp; adapter.Fill(names);</pre>\r\n  <pre>\r\n    <br />&nbsp;&nbsp;&nbsp; foreach (DataRow row in names.Rows)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; row[\"Name\"] = Server.HtmlEncode((string)row[\"Name\"]);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; row.EndEdit();<br />&nbsp;&nbsp;&nbsp; }</pre>\r\n  <pre>\r\n    <br />&nbsp;&nbsp;&nbsp; // Present the data to the user in the previously created Data Grid<br />&nbsp;&nbsp;&nbsp; dataGrid.DataSource = names;<br />&nbsp;&nbsp;&nbsp; dataGrid.DataBind();</pre>\r\n  <pre>}</pre>\r\n  <p>This solution takes advantage of the event-driven architecture of .NET and eliminates the requirement to loop through the DataTable in order to access individual data items. Where presentation of data makes use of an object such as a DataGrid that supports data binding events, we recommend this approach for reasons of performance and architectural consistency. </p>\r\n  <h1>Problem Example</h1>\r\n  <p>The following example demonstrates the use of a DataTable to query data without the use of any output encoding:</p>\r\n  <pre>// Build a datagrid to house our data and add to the set of page controls<br />DataGrid dataGrid = new DataGrid();<br />this.Controls.Add(dataGrid);</pre>\r\n  <pre>\r\n    <br />// Create a new database connection using Integrated Security and open that connection<br />string connectionString = \"Initial Catalog=snippets;Data Source=vm-win2003\\\\sqlexpress;Integrated Security=SSPI;\";<br />SqlConnection cn = new SqlConnection(connectionString);<br />cn.Open();</pre>\r\n  <pre>\r\n    <br />// Create a new SQL Command object with a query to execute the stored procedure<br />SqlCommand cmd = new SqlCommand(\"exec spFullNames\", cn);<br />SqlDataAdapter adapter = new SqlDataAdapter(cmd);</pre>\r\n  <pre>\r\n    <br />// Create a new data table and fill our that table with names from the adapter <br />DataTable names = new DataTable();<br />adapter.Fill(names);</pre>\r\n  <pre>\r\n    <br />// Present the data to the user in the previously created Data Grid<br />dataGrid.DataSource = names;<br />dataGrid.DataBind();</pre>\r\n  <ul>\r\n    <li>Any HTML data present within the database query output will be rendered as part of the application HTML output </li>\r\n    <li>Any Javascript data present within the database query output will be rendered as part of the application HTML output </li>\r\n    <li>Code is vulnerable to client-side script attacks such as cross-site scripting (XSS) </li>\r\n  </ul>\r\n  <h1>Test Case</h1>\r\n  <p>The following classes must be included in any project making use of the sample code provided above:</p>\r\n  <pre>using System.Data;<br />using System.Data.SqlClient;<br />using System.Web;</pre>\r\n  <p>Create a new C# ASP.NET application and use the following Page_Load method to test the provided example methods (adjust database code for your example):</p>\r\n  <pre>protected void Page_Load(object sender, EventArgs e)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp; if (!Page.IsPostBack)<br />&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Create a new database connection using Integrated Security and open that connection<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string connectionString = \"Initial Catalog=snippets;Data Source=vm-win2003\\\\sqlexpress;Integrated Security=SSPI;\";<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SqlConnection cn = new SqlConnection(connectionString);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cn.Open();</pre>\r\n  <pre>\r\n    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Create a new SQL Command object with a query to execute the stored procedure<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SqlCommand cmd = new SqlCommand(\"exec spFullNames\", cn);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SqlDataAdapter adapter = new SqlDataAdapter(cmd);</pre>\r\n  <pre>\r\n    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadEncodedPeopleTableEvent(adapter);<br />&nbsp;&nbsp;&nbsp;&nbsp; }<br />}</pre>\r\n  <h1>Expected Result</h1>\r\n  <pre>&lt;table cellspacing=\"0\" rules=\"all\" border=\"1\" style=\"border-collapse:collapse;\"&gt;</pre>\r\n  <pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;tr&gt;&lt;td&gt;Name&lt;/td&gt;&lt;/tr&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;tr&gt;&lt;td&gt;Elvin Jones&lt;/td&gt;&lt;/tr&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;tr&gt;&lt;td&gt;Gene Krupa&lt;/td&gt;&lt;/tr&gt;</pre>\r\n  <pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;tr&gt;&lt;td&gt;Tony Williams&lt;/td&gt;&lt;/tr&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;tr&gt;&lt;td&gt;&lt;script&gt;alert('XSS!');&lt;/script&gt; XSS&lt;/td&gt;&lt;/tr&gt;</pre>\r\n  <pre>&lt;/table&gt;</pre>\r\n  <h1>More Information</h1>\r\n  <ul>\r\n    <li>In addition to output validation, developers should always validate any input that originates from untrusted sources, such as application users or external feeds. </li>\r\n  </ul>\r\n  <br />\r\n  <hr />\r\n  <p>Adapted from Microsoft patterns & practices guidance.</p>"
        ]
      }
    ]
  }
}