{
  "TeamMentor_Article": {
    "$": {
      "Metadata_Hash": "331372747",
      "Content_Hash": "-451182207"
    },
    "Metadata": [
      {
        "Id": [
          "70bf25f8-7433-4b57-9047-e01f223a815f"
        ],
        "Id_History": [
          "70bf25f8-7433-4b57-9047-e01f223a815f,91d144c1-f0c4-42f6-9b6c-8723713cbcbd,"
        ],
        "Library_Id": [
          "92718d53-36b2-47bc-b6f5-e60994385f46"
        ],
        "Title": [
          "Consider Using S4U Feature for Impersonation And Delegation, When You Cannot Do a Windows Mapping"
        ],
        "Category": [
          "Impersonation and Delegation"
        ],
        "Phase": [
          "Implementation"
        ],
        "Technology": [
          "WCF"
        ],
        "Type": [
          "Guideline"
        ],
        "DirectLink": [
          "Consider Using S4U Feature for Impersonation And Delegation, When You Cannot Do a Windows Mapping"
        ],
        "Tag": [
          "WCF 3.5"
        ],
        "Security_Demand": [
          ""
        ],
        "Author": [
          ""
        ],
        "Priority": [
          "J.D. Meier, Jason Taylor, Prashant Bansode, Carlos Farre, Madhu Sundararajan, Rob Boucher, Steve Gregersen"
        ],
        "Status": [
          ""
        ],
        "Source": [
          "SI"
        ]
      }
    ],
    "Content": [
      {
        "$": {
          "Sanitized": "true",
          "DataType": "Html"
        },
        "Data": [
          "<h1>Applies to</h1>\n  <ul>\n    <li>Microsoft&#174; Windows Communication Foundation (WCF) 3.5 <li>Microsoft Visual Studio&#174; 2008</li></li>\n  </ul>\n  <h1>What to Do</h1>\n  <p>Consider using S4U feature for Impersonation and Delegation, when you cannot do a windows mapping. </p>\n  <h1>How</h1>\n  <p>In many situations&#8212;for example, if your users access a WCF Service over the Internet&#8212;you cannot use Kerberos authentication because firewalls prevent the client computer from directly communicating with the domain controller. Instead, your Service must authenticate the client by using another approach, such as username authentication, or in an extranet scenario, client certificate authentication.</p>\n  <p>In such situations where you cannot map the username or certificate authentication directly to Windows accounts, you can consider using the protocol transition (S4U) feature that permits applications to use a non-Windows authentication mechanism to authenticate users, but still use Kerberos authentication and delegation to access downstream network resources. This allows your application to access downstream servers that require Windows authentication and it allows you to use Windows auditing to track user access to backend resources.</p>\n  <p>Use the WindowsIdentity constructor to create a Windows token giving only an account's user principal name (UPN). </p>\n  <p>\n    <strong>Important</strong>: To impersonate at impersonation level, you must grant your process account the \"Act as part of the operating system\" user right. To impersonate at delegation level, to access network resources, you must enable protocol transition in Active Directory.</p>\n  <p>The following code shows how to use this constructor to obtain a Windows token for a given user.</p>\n  <pre>using System;<br />using System.Security.Principal;<br />public void ConstructToken(string upn, out WindowsPrincipal p)<br />&#123;<br />&nbsp; WindowsIdentity id = new WindowsIdentity(upn);<br />&nbsp; p = new WindowsPrincipal (id);<br />&#125;</pre>\n  <h1>Additional Resources</h1>\n  <ul>\n    <li>For more information on the S4U and Protocol Transition, see &#8220;Using Protocol Transition&#8212;Tips from the Trenches&#8221; at <a href=\"http://msdn2.microsoft.com/en-us/magazine/cc163500.aspx\">http://msdn2.microsoft.com/en-us/magazine/cc163500.aspx</a><li>For more information, see &#8220;Delegation and Impersonation with WCF&#8221; at <a href=\"http://msdn2.microsoft.com/en-us/library/ms730088.aspx\">http://msdn2.microsoft.com/en-us/library/ms730088.aspx</a><li>For impersonation and delegation Q&A, see the Impersonation/Delegation section of &#8220;WCF 3.5 Questions and Answers&#8220; at <a href=\"http://www.codeplex.com/WCFSecurityGuide/Wiki/View.aspx?title=WCF&#37;20Questions&#37;20and&#37;20Answers&#37;20&#37;28Q&#37;26A&#37;29&referringTitle=Home\">http://www.codeplex.com/WCFSecurityGuide/Wiki/View.aspx?title=WCF&#37;20Questions&#37;20and&#37;20Answers&#37;20&#37;28Q&#37;26A&#37;29&referringTitle=Home</a><a href=\"http://www.codeplex.com/WCFSecurity/Wiki/View.aspx?title=Questions&#37;20and&#37;20Answers&referringTitle=Home\"></a></li></li></li>\n  </ul>\n  <hr />\n  <p>Adapted from Microsoft patterns & practices guidance.</p>"
        ]
      }
    ]
  }
}