{
  "TeamMentor_Article": {
    "$": {
      "Metadata_Hash": "-117942592",
      "Content_Hash": "-1577604210"
    },
    "Metadata": [
      {
        "Id": [
          "faada3f5-3f50-42fc-b863-5058e3d848cb"
        ],
        "Id_History": [
          "faada3f5-3f50-42fc-b863-5058e3d848cb,f911624a-eca0-4ed3-9989-dc00dfe8d7e4,"
        ],
        "Library_Id": [
          "be5273b1-d682-4361-99d9-6234f2d47eb7"
        ],
        "Title": [
          "[SINK] Protect Sensitive Data Inside Configuration Files"
        ],
        "Category": [
          "Hardening"
        ],
        "Phase": [
          "Deployment"
        ],
        "Technology": [
          ".NET 3.5"
        ],
        "Type": [
          "Guideline"
        ],
        "DirectLink": [
          "Protect Sensitive Data Inside Configuration Files"
        ],
        "Tag": [
          ""
        ],
        "Security_Demand": [
          ""
        ],
        "Author": [
          ""
        ],
        "Priority": [
          "2"
        ],
        "Status": [
          ""
        ],
        "Source": [
          "SI"
        ]
      }
    ],
    "Content": [
      {
        "$": {
          "Sanitized": "true",
          "DataType": "Html"
        },
        "Data": [
          "<h1>What to Do</h1>\r\n  <p>Protect all sensitive data that is stored within configuration files.</p>\r\n  <h1>Why</h1>\r\n  <p>Configuration sections typically contain sensitive data (e.g., a connection string for a SQL server resource includes a username and password). As a precautionary measure, they should not be stored in plaintext, because if an attacker compromises the server or otherwise obtains a copy of the file, he would then be able to read those values if they are not adequately protected.</p>\r\n  <h1>When</h1>\r\n  <p>If your application uses configuration files that contain sensitive data such as connection strings, encryption keys, hashing salts, directory paths, or credentials.</p>\r\n  <h1>How</h1>\r\n  <p>To protect sensitive data inside configuration files use the following steps:</p>\r\n  <ol>\r\n    <li>\r\n      <p>\r\n        <strong>Identify the sensitive data</strong>: Locate all sensitive data that is stored inside the configuration files. Examples of sensitive data include, but are not limited to, credentials, connection strings, encryption keys, hashing salts, and directory paths. The following sections inside <strong>web.config</strong> are known to frequently contain sensitive data:</p>\r\n      <ul>\r\n        <li>\r\n          <strong>appSettings</strong>\r\n        </li>\r\n        <li>\r\n          <strong>connectionStrings</strong>\r\n        </li>\r\n        <li>\r\n          <strong>identity </strong>\r\n        </li>\r\n        <li>\r\n          <strong>sessionState</strong>\r\n        </li>\r\n      </ul>\r\n      <p>However, the following sections inside web.config <strong>cannot</strong> be encrypted:</p>\r\n      <ul>\r\n        <li>\r\n          <strong>processModel </strong>\r\n        </li>\r\n        <li>\r\n          <strong>runtime</strong>\r\n        </li>\r\n        <li>\r\n          <strong>mscorlib </strong>\r\n        </li>\r\n        <li>\r\n          <strong>startup</strong>\r\n        </li>\r\n        <li>\r\n          <strong>system.runtime.remoting</strong>\r\n        </li>\r\n        <li>\r\n          <strong>configProtectedData</strong>\r\n        </li>\r\n        <li>\r\n          <strong>satelliteassemblies</strong>\r\n        </li>\r\n        <li>\r\n          <strong>cryptographySettings</strong>\r\n        </li>\r\n        <li>\r\n          <strong>cryptoNameMapping</strong>\r\n        </li>\r\n        <li>\r\n          <strong>cryptoClasses</strong>\r\n        </li>\r\n      </ul>\r\n    </li>\r\n    <li>\r\n      <p>\r\n        <strong>Encrypt sensitive data inside the configuration files</strong>: Encrypt the sensitive data inside the configuration file to ensure its confidentiality in case this file is compromised. Once the application accesses the configuration file, it should decrypt the sensitive data just before use. Use the following mechanisms to protect sections within your application's <strong>web.config</strong>:</p>\r\n      <ul>\r\n        <li>\r\n          <p>\r\n            <strong>RSAProtectedConfigurationProvider</strong>: This provider encrypts configuration sections using the RSA encryption algorithm, and should be used when multiple machines need to share the same configuration file or key. Use the <strong>aspnet_regiis</strong> utility to perform encryption using this provider:</p>\r\n          <blockquote>\r\n            <pre>aspnet_regiis -pe \"connectionStrings\" -app \"/&lt; your application's name &gt;\" -prov \"RSAProtectedConfigurationProvider\"</pre>\r\n          </blockquote>\r\n          <p>Additionally, you need to allow ASP.NET's local system account to access the IIS key repository. Use the following command to grant such access:</p>\r\n          <blockquote>\r\n            <pre>aspnet_regiis -pa \"NetFrameworkConfigurationKey\" \"&lt; ASP.NET's local system account &gt;\"</pre>\r\n          </blockquote>\r\n        </li>\r\n        <li>\r\n          <p>\r\n            <strong>DataProtectionConfigurationProvider</strong>: This provider encrypts configuration sections using the Windows DPAPI, and should be used when configuration data does not need to be shared across multiple machines. Use the <strong>aspnet_regiis</strong> utility to perform encryption using this provider:</p>\r\n          <blockquote>\r\n            <pre>aspnet_regiis -pe \"connectionStrings\" -app \"/&lt; your application's name &gt;\" -prov \"DataProtectionConfigurationProvider\"</pre>\r\n          </blockquote>\r\n        </li>\r\n        <li>\r\n          <p>\r\n            <strong>Windows identities</strong>: Use the following steps to protect all Windows impersonations that are performed by ASP.NET:</p>\r\n          <ol>\r\n            <li>\r\n              <p>Identify the Windows account that is to be impersonated.</p>\r\n            </li>\r\n            <li>\r\n              <p>Create a Registry key for your application in the <strong>HKLM\\Software</strong> hive.</p>\r\n            </li>\r\n            <li>\r\n              <p>Use the <strong>aspnet_setreg</strong> utility to store the credentials that will be used during the impersonation. Example:</p>\r\n              <blockquote>\r\n                <pre>aspnet_setreg -k:Software\\MyApp\\identity -u:&lt; username &gt; -p:&lt; password &gt;</pre>\r\n              </blockquote>\r\n            </li>\r\n            <li>\r\n              <p>Update the <strong>identity</strong> element inside <strong>web.config</strong> with the attributes that the <strong>aspnet_setreg</strong> utility provides. Example:</p>\r\n              <blockquote>\r\n                <pre>&lt;identity impersonate=\"true\" userName=\"registry:HKLM\\Software\\MyApp\\Identity\\ASPNET_SETREG,userName\"<br />                              password=\"registry:HKLM\\Software\\MyApp\\Identity\\ASPNET_SETREG,password\" /&gt;</pre>\r\n              </blockquote>\r\n            </li>\r\n          </ol>\r\n        </li>\r\n      </ul>\r\n    </li>\r\n    <li>\r\n      <p>\r\n        <strong>Protect configuration files</strong>:</p>\r\n      <ul>\r\n        <li>\r\n          <p>\r\n            <strong>Set appropriate permissions</strong>: Apply the appropriate filesystem permissions such that the configuration files can be only accessed by your application and its administrators.</p>\r\n        </li>\r\n        <li>\r\n          <p>\r\n            <strong>Use HttpForbiddenHandler</strong>: Use HttpForbiddenHandler to restrict HTTP access to configuration files. Follow these steps when configuring HttpForbiddenHandler to work with your application's custom extensions:</p>\r\n          <ul>\r\n            <li>\r\n              <p>\r\n                <strong>ISAPI filter</strong>: Map the ASP.NET ISAPI filter to your application's custom extension.</p>\r\n              <ol>\r\n                <li>Open the IIS management utility. </li>\r\n                <li>Locate your application's virtual directory. </li>\r\n                <li>Right click on your application and select <strong>Properties</strong>. </li>\r\n                <li>Navigate to the <strong>Directory</strong> tab. </li>\r\n                <li>Select <strong>Configuration</strong>. </li>\r\n                <li>Locate the <strong>.aspx</strong> extension. </li>\r\n                <li>Select <strong>Edit</strong>. </li>\r\n                <li>Copy the Executable path. </li>\r\n                <li>Select <strong>Cancel</strong>. </li>\r\n                <li>Select <strong>Add</strong>. </li>\r\n                <li>Paste the Executable path. </li>\r\n                <li>Specify your application's custom extension. </li>\r\n                <li>Select <strong>OK</strong> until you reach the IIS management utility.</li>\r\n              </ol>\r\n            </li>\r\n            <li>\r\n              <p>\r\n                <strong>web.config</strong>: Add the following element in your application's web.config:</p>\r\n              <blockquote>\r\n                <pre>&lt;httpHandlers&gt;<br />  &lt;add path=\"*.myappextension\" verb=\"*\" type=\"System.Web.HttpForbiddenHandler\" validate=\"true\"/&gt;<br />&lt;/httpHandlers&gt;</pre>\r\n              </blockquote>\r\n            </li>\r\n          </ul>\r\n        </li>\r\n      </ul>\r\n    </li>\r\n  </ol>\r\n  <h1>Problem Example</h1>\r\n  <p>The following segment illustrates a configuration section responsible for providing valid credentials for Windows impersonation. Unfortunately, the credentials are stored inside web.config in plaintext; therefore anybody with access to the configuration file will be able to obtain the credentials.</p>\r\n  <blockquote>\r\n    <pre>&lt;identity impersonate=\"true\" userName=\"testAcct\" password=\"testPass\"/&gt;</pre>\r\n  </blockquote>\r\n  <h1>Solution Example</h1>\r\n  <p>The following segment illustrates a configuration section responsible for providing valid credentials for Windows impersonation. Because the developers use the aspnet_setreg utility to encrypt the credentials, they have altered the web.config to point to the appropriate registry keys that contain the encrypted credentials. If the configuration file becomes compromised, the attacker will not be able to obtain the valid set of Windows credentials.</p>\r\n  <blockquote>\r\n    <pre>&lt;identity impersonate=\"true\" userName=\"registry:HKLM\\Software\\MyApp\\Identity\\ASPNET_SETREG,userName\"<br />                              password=\"registry:HKLM\\Software\\MyApp\\Identity\\ASPNET_SETREG,password\"/&gt;</pre>\r\n  </blockquote>\r\n  <hr />\r\n  <p>Adapted from Microsoft patterns &amp; practices guidance. </p>"
        ]
      }
    ]
  }
}